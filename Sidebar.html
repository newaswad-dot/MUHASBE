<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>أداة البحث</title>
  <style>
    :root{
      color-scheme:dark;
      --bg:#05080f;
      --surface:#0f151f;
      --surface-soft:#121b27;
      --surface-strong:#182234;
      --accent:#2bffa8;
      --accent-strong:#1ddf8d;
      --accent-dim:rgba(43,255,168,0.14);
      --muted:#7f8ba5;
      --text:#e8f7ff;
      --text-strong:#ffffff;
      --danger:#ff5d75;
      --warning:#ffd166;
      --border:rgba(255,255,255,0.07);
    }
    *{box-sizing:border-box;font-family:'Tajawal','Cairo','Segoe UI',sans-serif;}
    body{margin:0;background:radial-gradient(circle at top left,#0c1424 0%,#05080f 55%,#020307 100%);color:var(--text);min-height:100vh;display:flex;justify-content:center;position:relative;}
    body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at 20% 20%,rgba(45,212,255,.18),transparent 55%),radial-gradient(circle at 80% 10%,rgba(150,41,255,.18),transparent 60%);opacity:.75;pointer-events:none;z-index:-1;}
    body.drawer-open{overflow:hidden;}
    body,button,input,select,textarea{font-size:15px;}
    body.dark{background:#020307;color:var(--text);}
    a{color:inherit;}
    button{cursor:pointer;border:none;background:var(--surface-soft);color:var(--text);border-radius:18px;padding:12px 16px;font-weight:700;transition:transform .18s ease,box-shadow .18s ease,background .18s ease;}
    button:active{transform:scale(.98);}
    button:disabled{opacity:.45;cursor:not-allowed;}
    .btn-green{background:linear-gradient(135deg,var(--accent) 0%,var(--accent-strong) 100%);color:#04140d;box-shadow:0 12px 34px var(--accent-dim);}
    .btn-green:hover{background:linear-gradient(135deg,var(--accent-strong) 0%,var(--accent) 100%);}
    .btn-blue{background:linear-gradient(135deg,#2dd4ff 0%,#38bdf8 100%);color:#031420;box-shadow:0 12px 34px rgba(45,212,255,.25);}
    .btn-red{background:linear-gradient(135deg,#ff5d75 0%,#ff3b5f 100%);color:#2b040b;box-shadow:0 12px 34px rgba(255,61,110,.28);}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border);}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:14px 16px;border-radius:18px;border:1px solid rgba(255,255,255,0.05);background:var(--surface);color:var(--text);outline:none;transition:border .18s ease,box-shadow .18s ease;}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
    textarea{min-height:130px;resize:vertical;line-height:1.6;}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    .app-shell{width:100%;max-width:460px;padding:26px 18px 36px;display:flex;flex-direction:column;gap:18px;position:relative;}
    @media(min-width:520px){.app-shell{max-width:520px;}}
    .app-header{display:flex;align-items:center;gap:14px;}
    .hamburger{width:46px;height:46px;display:inline-flex;align-items:center;justify-content:center;border-radius:16px;background:var(--surface-strong);border:1px solid var(--border);color:var(--accent);box-shadow:0 10px 26px rgba(18,233,153,.18);}
    .header-meta{margin-inline-start:auto;display:flex;flex-wrap:wrap;align-items:stretch;justify-content:flex-end;gap:14px;flex:1 1 auto;}
    .counter-cluster{display:flex;align-items:center;justify-content:center;gap:12px;background:var(--surface-strong);padding:10px 14px;border-radius:18px;border:1px solid var(--border);box-shadow:0 12px 30px rgba(16,26,44,.36);flex-wrap:wrap;}
    .counter-mini{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:86px;padding:4px 0;flex:1 1 80px;}
    .counter-mini .label{font-size:11px;color:var(--muted);letter-spacing:.4px;}
    .counter-mini .value{font-size:16px;font-weight:800;color:var(--accent);}
    .section-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid rgba(43,255,168,.26);background:rgba(43,255,168,.08);color:var(--accent);font-weight:700;white-space:nowrap;flex:0 0 auto;transition:background .18s ease,border .18s ease,color .18s ease;}
    .section-chip .chip-label{font-size:11px;letter-spacing:.3px;color:var(--muted);}
    .section-chip .chip-value{color:var(--text-strong);font-size:13px;}
    .section-chip.is-empty{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.08);color:var(--muted);}
    .section-chip.is-empty .chip-value{color:var(--muted);}
    .view-switch{display:flex;gap:10px;}
    .view-tab{flex:1;background:var(--surface);border:1px solid transparent;border-radius:16px;padding:12px 14px;color:var(--muted);font-weight:700;}
    .view-tab.active{background:linear-gradient(135deg,var(--surface-strong),#1c2537);color:var(--accent);border-color:rgba(43,255,168,.22);box-shadow:0 12px 32px rgba(26,214,145,.22);}
    .view-panel{display:none;flex-direction:column;gap:16px;}
    .view-panel.active{display:flex;}
    .stack-group{background:linear-gradient(150deg,rgba(18,26,38,.96),rgba(8,12,22,.9));border-radius:30px;border:1px solid rgba(255,255,255,.05);box-shadow:0 28px 72px rgba(5,12,22,.55);display:flex;flex-direction:column;overflow:hidden;}
    .stack-row{padding:24px 26px;border-bottom:1px solid rgba(255,255,255,.04);display:flex;flex-direction:column;gap:18px;}
    .stack-row:last-child{border-bottom:none;}
    .stack-row--title{padding:30px 28px 18px;gap:10px;}
    .stack-row--primary{padding:0;border-bottom:none;}
    .primary-blocks{display:flex;flex-direction:column;gap:0;}
    .primary-block{display:flex;flex-direction:column;gap:16px;padding:24px 28px;}
    .primary-block + .primary-block{padding-top:0;}
    .primary-block:not(:last-child){padding-bottom:0;}
    .stack-title{margin:0;font-size:24px;font-weight:800;color:var(--accent);letter-spacing:.6px;}
    .stack-subtitle{margin:0;font-size:13px;color:var(--muted);letter-spacing:.4px;}
    .stack-box{display:flex;flex-direction:column;gap:18px;}
    .log-slot{display:flex;flex-direction:column;gap:12px;}
    .mobile-load-spot{display:none;}
    .mobile-load-spot.show{display:block;}
    .mobile-load-spot #loadCard{margin-top:18px;}
    #logSlot > *{width:100%;}
    .card{background:linear-gradient(145deg,var(--surface-strong),rgba(10,18,32,.96));border-radius:26px;padding:20px;border:1px solid rgba(255,255,255,.06);box-shadow:0 22px 50px rgba(5,12,22,.58);backdrop-filter:blur(6px);}
    .card.flat{background:linear-gradient(150deg,rgba(18,26,38,.96),rgba(8,12,22,.92));border-color:rgba(255,255,255,.04);box-shadow:0 18px 42px rgba(6,10,20,.45);}
    #loadCard{display:flex;flex-direction:column;gap:12px;background:var(--surface-strong);border-radius:22px;padding:18px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 18px 42px rgba(6,10,20,.45);width:100%;max-width:none;}
    #loadCard button{width:100%;font-size:15px;}
    #loadCard .muted{font-size:12px;}
    .badge{display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;letter-spacing:.4px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);}
    .badge--withdraw{color:#4de4a1;border-color:rgba(77,228,161,.32);background:rgba(77,228,161,.09);}
    .badge--agent{color:#38bdf8;border-color:rgba(56,189,248,.28);background:rgba(56,189,248,.08);}
    .badge--admin{color:#facc15;border-color:rgba(250,204,21,.32);background:rgba(250,204,21,.08);}
    .badge--dup{color:#ff5d75;border-color:rgba(255,93,117,.34);background:rgba(255,93,117,.12);}
    .badge--loading{color:var(--muted);border-color:rgba(255,255,255,.08);}
    #nameText{font-size:15px;color:var(--muted);margin-bottom:8px;}
    #amountText{font-size:64px;font-weight:900;color:var(--accent);text-shadow:0 0 24px rgba(43,255,168,.45);margin-bottom:8px;}
    #discountInfo{font-size:13px;color:var(--muted);margin-bottom:6px;min-height:18px;}
    #multiText{font-size:12px;color:var(--muted);letter-spacing:.4px;}
    #extraDupInfo{font-size:12px;color:var(--muted);margin-top:12px;}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .primary-cluster{display:flex;flex-direction:column;gap:18px;width:100%;}
    .column{display:flex;flex-direction:column;gap:12px;}
    .column.stretch>*{width:100%;}
    .row.stretch>*,.row.stretch>button{flex:1 1 auto;}
    .pill-group{display:flex;gap:10px;flex-wrap:wrap;}
    .pill{flex:1;min-width:120px;background:var(--surface);padding:12px 14px;border-radius:18px;border:1px solid rgba(255,255,255,.04);display:flex;flex-direction:column;gap:6px;}
    .pill .title{font-size:12px;color:var(--muted);}
    .pill .value{font-weight:700;font-size:15px;color:var(--text);}
    #resultsBox{padding:26px 22px;text-align:center;background:radial-gradient(circle at top,#1a2e2a 0%,#0b1118 55%,#090d13 100%);border:1px solid rgba(43,255,168,.22);box-shadow:0 28px 70px rgba(30,255,168,.18);display:flex;flex-direction:column;gap:12px;justify-content:center;border-radius:26px;}
    #resultsBox .badges{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:0;}
    #searchCard{background:linear-gradient(160deg,rgba(18,26,38,.94),rgba(7,12,22,.88));border-radius:22px;box-shadow:0 18px 42px rgba(6,10,20,.4);border:1px solid rgba(255,255,255,.05);display:flex;flex-direction:column;gap:16px;padding:22px 20px;}
    #searchCard button{min-width:160px;}
    #searchCard .column button{width:100%;}
    #searchCard .actions{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:8px;}
    #searchCard .actions .muted{flex:1;}
    #advCard{background:linear-gradient(160deg,rgba(18,26,38,.96),rgba(7,10,20,.9));border-radius:26px;border:1px solid rgba(255,255,255,.06);box-shadow:0 22px 50px rgba(5,12,22,.48);display:flex;flex-direction:column;gap:24px;padding:28px;}
    #advCard .row{gap:10px;}
    #advCard select{background:var(--surface-strong);}
    #advCard .btn-ghost{border-color:rgba(43,255,168,.26);color:var(--accent);min-width:110px;}
    #advCard .btn-green{padding:16px;font-size:18px;border-radius:20px;}
    #advCard .adv-top{display:flex;flex-direction:column;gap:12px;}
    #advCard .adv-control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;}
    #advCard .adv-control{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:18px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);backdrop-filter:blur(4px);}
    #advCard .adv-control select{width:100%;min-height:44px;}
    #advCard .adv-control--color{align-items:center;justify-content:center;}
    #advCard .adv-control--color input[type="color"]{width:100%;height:48px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:var(--surface-strong);padding:0;}
    #advCard .toggle-chip{display:none;}
    #advCard .toggles-row{display:none;}
    #discountInput,#applyDiscountToMessage,#enableSalaryCorrection{display:none;}
    .adv-subcard{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);border-radius:20px;padding:18px;display:flex;flex-direction:column;gap:12px;}
    #personCard{display:none;}
    #bulkCard{display:flex;flex-direction:column;gap:24px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);border-radius:22px;padding:22px;}
    .bulk-actions-row{display:flex;flex-wrap:wrap;gap:12px;}
    .bulk-actions-row button{flex:1 1 160px;}
    .bulk-progress-wrap{display:flex;flex-direction:column;gap:12px;}
    .bulk-progress{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;}
    .bulk-progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#38bdf8);transition:width .3s ease;}
    .bulk-progress-text{display:flex;justify-content:space-between;align-items:center;gap:12px;color:var(--muted);font-size:13px;}
    .bulk-progress-text span:first-child{color:var(--accent);font-weight:800;}
    .bulk-counters{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;}
    .bulk-counter{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);border-radius:16px;padding:12px 14px;font-size:12px;color:var(--muted);}
    .bulk-counter b{color:var(--text-strong);}
    #bulkIds{min-height:220px;background:var(--surface-strong);border-radius:20px;border:1px solid rgba(255,255,255,.08);padding:18px;color:var(--text);box-shadow:0 16px 38px rgba(6,10,20,.4);}
    .bulk-table-wrap{display:flex;flex-direction:column;gap:14px;padding:18px;border-radius:20px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);}
    .bulk-table{width:100%;border-collapse:collapse;font-size:13px;border-radius:16px;overflow:hidden;}
    .bulk-table thead{background:var(--surface-strong);}
    .bulk-table th,.bulk-table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.05);text-align:right;}
    .bulk-table tbody tr:nth-child(even){background:rgba(255,255,255,.02);}
    .bulk-page-btn{background:var(--surface-strong);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 18px;}
    .bulk-config{display:flex;flex-direction:column;gap:20px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);border-radius:22px;padding:22px;}
    .bulk-config-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;}
    .bulk-config-block{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);border-radius:18px;padding:16px;display:flex;flex-direction:column;gap:12px;}
    .bulk-inline{display:flex;gap:12px;flex-wrap:wrap;}
    .bulk-inline input{min-width:200px;}
    .bulk-external{display:flex;flex-direction:column;gap:10px;padding:18px;border-radius:18px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);}
    .bulk-discount-row{display:flex;align-items:center;gap:14px;flex-wrap:wrap;padding:14px 16px;border-radius:18px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);}
    .drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:8;}
    .drawer-backdrop.show{opacity:1;pointer-events:auto;}
    #quickTools.drawer{position:fixed;top:40px;left:50%;transform:translate(-50%,-20px) scale(.96);width:90%;max-width:360px;background:var(--surface-strong);border:1px solid rgba(255,255,255,.08);border-radius:24px;padding:20px 18px;box-shadow:0 30px 80px rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:opacity .2s ease,transform .22s ease;z-index:9;}
    #quickTools.drawer.open{opacity:1;pointer-events:auto;transform:translate(-50%,0) scale(1);}
    .drawer-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
    .drawer-title{font-size:18px;font-weight:800;color:var(--text);}
    .drawer-close{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--muted);width:38px;height:38px;border-radius:14px;}
    .drawer-items{display:flex;flex-direction:column;gap:12px;}
    .drawer-item{background:var(--surface);border-radius:18px;padding:14px 16px;text-align:center;font-weight:700;letter-spacing:.4px;border:1px solid rgba(255,255,255,.04);color:var(--text);}
    .drawer-item.primary{background:linear-gradient(135deg,var(--accent),var(--accent-strong));color:#04140d;box-shadow:0 14px 38px var(--accent-dim);}
    .drawer-toggle{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border-radius:18px;padding:12px 16px;border:1px solid rgba(255,255,255,.04);}
    .drawer-section{margin-top:12px;padding:14px 16px;border-radius:18px;background:var(--surface);border:1px solid rgba(255,255,255,.04);display:flex;flex-direction:column;gap:10px;}
    .drawer-section .small{margin:0;}
    .drawer-discount-row{display:flex;align-items:center;gap:10px;}
    .drawer-discount-row input{flex:1;}
    .drawer-discount-value{min-width:90px;text-align:center;color:var(--muted);font-size:13px;font-weight:700;padding:10px 12px;border-radius:14px;background:var(--surface-strong);border:1px solid rgba(255,255,255,.06);}
    .drawer-note{font-size:12px;color:var(--muted);line-height:1.5;}
    #qtMode{width:58px;height:30px;border-radius:999px;background:var(--surface-strong);position:relative;border:1px solid rgba(255,255,255,.12);padding:0;font-size:0;line-height:0;}
    #qtMode::after{content:'';position:absolute;top:3px;right:3px;width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.35);transition:transform .2s ease,background .2s ease;}
    body.dark #qtMode{background:var(--accent);border-color:rgba(43,255,168,.32);}
    body.dark #qtMode::after{transform:translateX(-26px);background:#052016;}
    .hidden-tools{display:none;}
    .muted{color:var(--muted);}
    .lastid{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);color:var(--muted);cursor:pointer;background:var(--surface-strong);font-size:12px;}
    #lastIdPill{margin-inline-start:auto;}
    #bulkCard .bulk-chip{background:rgba(255,93,117,.16);color:#ff8da4;border-radius:999px;padding:2px 8px;font-size:11px;}
    .bulk-pagination{display:flex;justify-content:space-between;align-items:center;gap:14px;margin-top:12px;flex-wrap:wrap;}
    .bulk-page-info{color:var(--muted);font-size:12px;}
    #bulkStatusText{font-size:13px;}
    #pasteHint{color:var(--muted);}
    #advNote{color:var(--muted);font-size:13px;}
    #loadNote{margin-top:8px;color:var(--muted);font-size:12px;}
    #statusChipsRow{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
    #statusChipsRow .chip{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.05);font-size:11px;color:var(--muted);}
    .view-panel footer{margin-top:8px;font-size:12px;color:var(--muted);text-align:center;}

    #advCard .adv-control .title{display:none;}
    @media(max-width:768px){
      #advCard .adv-control{gap:6px;padding:12px;}
      #advCard .adv-control--color input[type="color"]{height:52px;}
    }

    @media(min-width:1024px){
      body{padding:0;align-items:stretch;}
      .app-shell{max-width:none;width:100%;padding:46px clamp(32px,5vw,72px);gap:32px;min-height:100vh;}
      .view-switch{max-width:960px;margin:0 auto;width:100%;}
      .view-tab{max-width:240px;}
      #mainView .stack-group,#bulkView .stack-group{max-width:960px;margin:0 auto;}
      .stack-row{padding-inline:36px;}
      .stack-row--title{padding-inline:40px;padding-top:36px;}
      #advCard .adv-control-grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:16px;}
      .bulk-actions-row button{flex:1 1 180px;}
      #bulkIds{min-height:260px;}
    }
  </style>
</head>
<body class="dark">
  <div class="app-shell">
    <header class="app-header">
      <button id="menuToggle" class="hamburger" type="button" aria-label="فتح القائمة">
        <svg width="22" height="18" viewBox="0 0 22 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect x="1" y="1" width="20" height="2.4" rx="1.2" fill="currentColor" />
          <rect x="1" y="7.8" width="20" height="2.4" rx="1.2" fill="currentColor" />
          <rect x="1" y="14.6" width="20" height="2.4" rx="1.2" fill="currentColor" />
        </svg>
      </button>
      <div class="header-meta">
        <div class="counter-cluster">
          <div class="counter-mini">
            <span class="label">ملوّن</span>
            <span id="qtColored" class="value">—</span>
          </div>
          <div class="counter-mini">
            <span class="label">غير ملوّن</span>
            <span id="qtUncolored" class="value">—</span>
          </div>
        </div>
        <div id="sectionChip" class="section-chip is-empty">
          <span class="chip-label">القسم</span>
          <span id="headerSectionLabel" class="chip-value">—</span>
        </div>
      </div>
    </header>
    <div class="view-switch">
      <button class="view-tab active" type="button" data-view="main">الصفحة الرئيسية</button>
      <button class="view-tab" type="button" data-view="bulk">أداة البحث الجماعي</button>
    </div>

    <div id="mobileLoadCardSpot" class="mobile-load-spot"></div>

    <section id="mainView" class="view-panel active">
      <div id="mainStack" class="stack-group">
        <div class="stack-row stack-row--title">
          <h2 class="stack-title">الصفحة الرئيسية</h2>
        </div>

        <div class="stack-row stack-row--primary">
          <div class="primary-blocks">
            <div class="primary-block primary-block--results">
              <h3 class="stack-subtitle">خانة النتائج</h3>
              <div id="resultsBox">
                <div class="badges">
                  <span id="statusBadge" class="badge badge--loading">—</span>
                  <span id="dupBadge" class="badge badge--dup" style="display:none">مكرر</span>
                  <span id="statusChipsRow"></span>
                </div>
                <div id="nameText" class="subline">—</div>
                <div id="amountText" class="amountBig">—</div>
                <div id="discountInfo" style="display:none"></div>
                <div id="multiText" class="subline"></div>
                <div id="extraDupInfo" class="muted" style="margin-top:12px"></div>
              </div>
            </div>

            <div class="primary-block primary-block--search">
              <h3 class="stack-subtitle">خانة البحث</h3>
              <div id="searchCard">
                <label class="small">ID للبحث</label>
                <div class="column stretch">
                  <input id="idInput" type="text" placeholder="أدخل ID هنا" autocomplete="off" inputmode="numeric">
                  <button id="pasteSearchBtn" class="btn-blue" type="button">لصق ثم بحث</button>
                </div>
                <div class="actions">
                  <div id="pasteHint" class="muted"></div>
                  <div id="lastIdPill" class="lastid" style="display:none">آخر ID: <b id="lastIdText"></b></div>
                </div>
              </div>
            </div>

            <div class="primary-block primary-block--single">
              <h3 class="stack-subtitle">قسم التنفيذ الفردي</h3>
              <div id="advCard">
                <div class="adv-top">
                  <button id="advRunBtn" class="btn-green" type="button">تنفيذ (حسب النتيجة)</button>
                  <div id="advNote" class="muted"></div>
                </div>

                <div class="adv-control-grid">
                  <div class="pill adv-control">
                    <span class="title">الهدف</span>
                    <select id="sheetSelect" aria-label="الهدف"></select>
                  </div>
                  <div class="pill adv-control">
                    <span class="title">التنفيذ</span>
                    <select id="targetMode" aria-label="وضع التنفيذ">
                      <option value="agent">الوكيل فقط</option>
                      <option value="both" selected>الإدارة + الوكيل</option>
                    </select>
                  </div>
                  <div class="pill adv-control adv-control--color">
                    <span class="title">لون الإدارة</span>
                    <input id="adminColor" type="color" value="#fde68a" aria-label="لون الإدارة">
                  </div>
                  <div class="pill adv-control adv-control--color">
                    <span class="title">لون سحب وكالة</span>
                    <input id="withdrawColor" type="color" value="#9629ff" aria-label="لون سحب وكالة">
                  </div>
                </div>

                <div class="row stretch">
                  <input id="newSheetName" type="text" placeholder="اسم ورقة جديدة (داخل الإدارة)">
                  <button id="createSheetBtn" class="btn-ghost" type="button">إنشاء</button>
                </div>

                <div class="row toggles-row">
                  <div class="row" style="gap:8px;align-items:center;">
                    <label class="small" style="margin:0;">الخصم %</label>
                    <input id="discountInput" type="number" min="0" max="100" value="0" step="1" style="width:110px">
                  </div>
                  <div class="toggle-chip">
                    <span class="switch-label">الخصم لحظيًا</span>
                    <label class="ios-toggle">
                      <input id="applyDiscountToMessage" type="checkbox">
                      <span class="slider"></span>
                    </label>
                  </div>
                  <div class="toggle-chip">
                    <span class="switch-label">تصحيح الراتب</span>
                    <label class="ios-toggle">
                      <input id="enableSalaryCorrection" type="checkbox">
                      <span class="slider"></span>
                    </label>
                  </div>
                </div>

                <div class="adv-subcard" id="personCard">
                  <div class="row" style="justify-content:space-between; align-items:center">
                    <strong>بيانات صاحب الـID</strong>
                    <div class="row" style="gap:6px; flex:0 0 auto">
                      <button id="copyMsgBtn" class="btn-green" type="button">نسخ الرسالة</button>
                      <button id="colorAllBtn" class="btn-ghost" type="button" title="تلوين كل الـIDs لهذا الشخص بسرعة">تلوين الكل</button>
                    </div>
                  </div>
                  <div id="personNote" class="muted" style="margin-top:6px">—</div>
                  <textarea id="personMsg" rows="8" style="margin-top:8px;" readonly></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="stack-row stack-row--log">
          <h3 class="stack-subtitle">زر السجل</h3>
          <div class="stack-box">
            <div id="logSlot" class="log-slot"></div>
          </div>
        </div>

        <div class="stack-row stack-row--load">
          <h3 class="stack-subtitle">تحميل البيانات</h3>
          <div class="stack-box">
            <div class="load-card" id="loadCard">
              <button id="reloadBtn" class="btn-red" type="button">تحميل البيانات</button>
              <div id="loadNote" class="muted"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="bulkMobileMount" class="span2" style="display:none"></div>
    </section>

    <section id="bulkView" class="view-panel">
      <div id="bulkStack" class="stack-group">
        <div class="stack-row stack-row--title">
          <h2 class="stack-title">أداة البحث الجماعي</h2>
        </div>

        <div class="stack-row stack-row--goal">
          <h3 class="stack-subtitle">قسم الهدف و المنطق</h3>
          <div class="stack-box">
            <div class="bulk-note" id="bulkStatusText">ألصق IDs وسيتم التحليل تلقائيًا.</div>
            <div id="bulkConfigCard" class="bulk-config">
              <div class="bulk-config-grid">
                <div class="bulk-config-block">
                  <label class="small">النطاق</label>
                  <select id="bulkScope">
                    <option value="agent">الوكيل فقط</option>
                    <option value="both" selected>الإدارة + الوكيل</option>
                    <option value="all">الكل (يشمل الخارجي)</option>
                  </select>
                </div>
                <div class="bulk-config-block">
                  <label class="small">ورقة الهدف</label>
                  <div class="row" style="gap:6px; align-items:center">
                    <select id="bulkTargetSheet" style="flex:1"></select>
                    <button id="bulkRefreshSheets" class="btn-ghost" title="تحديث قائمة الأوراق" style="flex:0 0 auto">↻</button>
                  </div>
                </div>
              </div>

              <div class="bulk-inline">
                <input id="bulkNewSheet" type="text" placeholder="اسم ورقة جديدة (داخل الإدارة)">
                <button id="bulkCreateSheet" class="btn-ghost">إنشاء ورقة</button>
              </div>

              <div id="bulkExternalWrap" class="bulk-external" style="display:none;">
                <label class="small" style="display:block">ورقة الهدف (خارجي) <span id="bulkExternalFileLabel" class="muted"></span></label>
                <div class="row" style="gap:6px; align-items:center">
                  <select id="bulkExternalTargetSheet" style="flex:1"></select>
                  <button id="bulkExternalRefreshSheets" class="btn-ghost" title="تحديث قائمة الأوراق الخارجية" style="flex:0 0 auto">↻</button>
                </div>
                <div class="row stretch" style="margin-top:8px">
                  <input id="bulkExternalNewSheet" type="text" placeholder="اسم ورقة جديدة (خارجية)">
                  <button id="bulkExternalCreateSheet" class="btn-ghost">إنشاء</button>
                </div>
                <div id="bulkExternalNote" class="muted" style="margin-top:6px"></div>
              </div>

              <div class="bulk-discount-row">
                <div class="row" style="gap:8px;align-items:center;">
                  <label class="small" style="margin:0;">لون الإدارة</label>
                  <input id="bulkAdminColor" type="color" value="#fde68a" aria-label="لون الإدارة">
                </div>
                <div class="row" style="gap:8px;align-items:center;">
                  <label class="small" style="margin:0;">لون السحب</label>
                  <input id="bulkWithdrawColor" type="color" value="#9629ff" aria-label="لون سحب وكالة">
                </div>
                <div class="row" style="gap:8px;align-items:center;">
                  <label class="small" style="margin:0;">الخصم %</label>
                  <input id="bulkDiscount" type="number" min="0" max="100" value="0" step="1" style="width:110px">
                </div>
                <div class="muted" id="bulkDiscountNote">يُطبّق تلقائيًا على النتائج.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="stack-row stack-row--execute">
          <h3 class="stack-subtitle">قسم التنفيذ الجماعي</h3>
          <div class="stack-box">
            <div id="bulkCard" class="bulk-execute">
              <div class="bulk-actions-row">
                <button id="bulkPasteBtn" class="btn-blue">لصق ثم بحث</button>
                <button id="bulkExecuteBtn" class="btn-red" disabled>تنفيذ الكل</button>
                <button id="bulkResetBtn" class="btn-ghost">إعادة تعيين</button>
                <button id="bulkCopyAllBtn" class="btn-ghost" disabled>نسخ الكل</button>
                <button id="bulkCopySalaryBtn" class="btn-ghost" disabled>نسخ الراتب فقط</button>
              </div>

              <div class="bulk-progress-wrap">
                <div class="bulk-progress">
                  <div id="bulkProgressBar" class="bulk-progress-bar"></div>
                </div>
                <div class="bulk-progress-text">
                  <span id="bulkProgressLabel">0%</span>
                  <span id="bulkSummaryText"></span>
                </div>
              </div>

              <div class="bulk-counters">
                <div class="bulk-counter">عدد الإدخالات: <b id="bulkCountTotal">0</b></div>
                <div class="bulk-counter">ملوّن: <b id="bulkCountColored">0</b></div>
                <div class="bulk-counter">غير ملوّن: <b id="bulkCountUncolored">0</b></div>
                <div class="bulk-counter">مجموع الرواتب: <b id="bulkSalarySum">0</b></div>
              </div>
            </div>
          </div>
        </div>

        <div class="stack-row stack-row--paste">
          <h3 class="stack-subtitle">قسم خانة اللصق</h3>
          <div class="stack-box">
            <textarea id="bulkIds" placeholder="ألصق عدة IDs (سطر لكل ID أو مفصولة بمسافات)"></textarea>
          </div>
        </div>

        <div class="stack-row stack-row--results">
          <h3 class="stack-subtitle">قسم النتائج</h3>
          <div class="stack-box">
            <div class="bulk-table-wrap">
              <table class="bulk-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>الراتب</th>
                    <th>الحالة</th>
                    <th>ملوّن؟</th>
                  </tr>
                </thead>
                <tbody id="bulkResultsBody"></tbody>
              </table>
              <div id="bulkPagination" class="bulk-pagination">
                <button id="bulkPrevBtn" class="bulk-page-btn">‹ السابق</button>
                <span id="bulkPageInfo" class="bulk-page-info"></span>
                <button id="bulkNextBtn" class="bulk-page-btn">التالي ›</button>
              </div>
              <div id="bulkEmptyState" class="bulk-empty">لا توجد نتائج بعد.</div>
            </div>
          </div>
        </div>
      </div>

    </section>
  </div>

  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="quickTools" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <span class="drawer-title">القائمة</span>
      <button id="drawerClose" class="drawer-close" type="button" aria-label="إغلاق">✕</button>
    </div>
    <div class="drawer-items">
      <button id="menuReload" class="drawer-item primary" type="button">تحميل البيانات</button>
      <button id="menuHome" class="drawer-item" type="button">الصفحة الرئيسية</button>
      <button id="menuBulk" class="drawer-item" type="button">أداة البحث الجماعي</button>
      <button id="refreshSheetsBtn" class="drawer-item" type="button">تحديث قائمة الأوراق</button>
      <div class="drawer-section">
        <label class="small" for="menuSection">القسم الحالي</label>
        <select id="menuSection"></select>
        <div id="menuSectionStatus" class="drawer-note"></div>
      </div>
      <div class="drawer-toggle">
        <span>الوضع الداكن</span>
        <button id="qtMode" type="button" aria-label="تبديل الوضع"></button>
      </div>
      <div class="drawer-section">
        <label class="small" for="menuDiscount">الخصم الفوري (%)</label>
        <div class="drawer-discount-row">
          <input id="menuDiscount" type="number" min="0" max="100" step="0.1" inputmode="decimal" placeholder="0">
          <span id="menuDiscountValue" class="drawer-discount-value">بدون خصم</span>
        </div>
        <div class="drawer-note">يُطبّق مباشرة على نتيجة البحث الفردي.</div>
      </div>
    </div>
    <div class="hidden-tools">
      <button id="qtHideLoad" type="button"></button>
      <button id="qtHidePerson" type="button"></button>
      <label><input id="qtDisablePerson" type="checkbox"></label>
      <button id="qtRefreshCnt" type="button"></button>
    </div>
  </aside>

  <script>
    // عناصر عامة
    const loadCard       = document.getElementById('loadCard');
    const reloadBtn      = document.getElementById('reloadBtn');
    const loadNote       = document.getElementById('loadNote');
    const mobileLoadCardSpot = document.getElementById('mobileLoadCardSpot');
    const loadCardHome = loadCard ? { parent: loadCard.parentNode, next: loadCard.nextSibling } : null;
    const loadCardMedia = window.matchMedia('(max-width: 768px)');

    function placeLoadCard(){
      if (!loadCard || !loadCardHome || !loadCardHome.parent) return;
      if (loadCardMedia.matches && mobileLoadCardSpot){
        if (loadCard.parentNode !== mobileLoadCardSpot){
          mobileLoadCardSpot.appendChild(loadCard);
        }
        mobileLoadCardSpot.classList.add('show');
      } else {
        if (loadCard.parentNode !== loadCardHome.parent){
          if (loadCardHome.next && loadCardHome.next.parentNode === loadCardHome.parent){
            loadCardHome.parent.insertBefore(loadCard, loadCardHome.next);
          } else {
            loadCardHome.parent.appendChild(loadCard);
          }
        }
        if (mobileLoadCardSpot){
          mobileLoadCardSpot.classList.remove('show');
        }
      }
    }

    placeLoadCard();
    if (typeof loadCardMedia.addEventListener === 'function'){
      loadCardMedia.addEventListener('change', placeLoadCard);
    } else if (typeof loadCardMedia.addListener === 'function'){
      loadCardMedia.addListener(placeLoadCard);
    }

    const idInput        = document.getElementById('idInput');
    const pasteSearchBtn = document.getElementById('pasteSearchBtn');
    const pasteHint      = document.getElementById('pasteHint');
    const headerSectionLabelEl = document.getElementById('headerSectionLabel');
    const sectionChipEl        = document.getElementById('sectionChip');

    const resultsBox  = document.getElementById('resultsBox');
    const statusBadge = document.getElementById('statusBadge');
    const dupBadge    = document.getElementById('dupBadge');
    const amountText  = document.getElementById('amountText');
    const discountInfo= document.getElementById('discountInfo');
    const multiText   = document.getElementById('multiText');
    const extraDupInfo= document.getElementById('extraDupInfo');
    const justColored = Object.create(null);

    const bulkCardEl         = document.getElementById('bulkCard');
    const bulkScope          = document.getElementById('bulkScope');
    const bulkTargetSheet          = document.getElementById('bulkTargetSheet');
    const bulkRefreshSheets        = document.getElementById('bulkRefreshSheets');
    const bulkNewSheet             = document.getElementById('bulkNewSheet');
    const bulkCreateSheet          = document.getElementById('bulkCreateSheet');
    const bulkExternalWrap         = document.getElementById('bulkExternalWrap');
    const bulkExternalTargetSheet  = document.getElementById('bulkExternalTargetSheet');
    const bulkExternalRefreshSheets= document.getElementById('bulkExternalRefreshSheets');
    const bulkExternalNewSheet     = document.getElementById('bulkExternalNewSheet');
    const bulkExternalCreateSheet  = document.getElementById('bulkExternalCreateSheet');
    const bulkExternalNote         = document.getElementById('bulkExternalNote');
    const bulkExternalFileLabel    = document.getElementById('bulkExternalFileLabel');
    const bulkAdminColor           = document.getElementById('bulkAdminColor');
    const bulkWithdrawColor        = document.getElementById('bulkWithdrawColor');
    const bulkDiscount             = document.getElementById('bulkDiscount');
    const bulkIdsInput       = document.getElementById('bulkIds');
    const bulkPasteBtn       = document.getElementById('bulkPasteBtn');
    const bulkExecuteBtn     = document.getElementById('bulkExecuteBtn');
    const bulkCopyAllBtn     = document.getElementById('bulkCopyAllBtn');
    const bulkCopySalaryBtn  = document.getElementById('bulkCopySalaryBtn');
    const bulkResetBtn       = document.getElementById('bulkResetBtn');
    const bulkProgressBar    = document.getElementById('bulkProgressBar');
    const bulkProgressLabel  = document.getElementById('bulkProgressLabel');
    const bulkSummaryText    = document.getElementById('bulkSummaryText');
    const bulkStatusText     = document.getElementById('bulkStatusText');
    const bulkCountTotal     = document.getElementById('bulkCountTotal');
    const bulkCountColored   = document.getElementById('bulkCountColored');
    const bulkCountUncolored = document.getElementById('bulkCountUncolored');
    const bulkSalarySum      = document.getElementById('bulkSalarySum');
    const bulkResultsBody    = document.getElementById('bulkResultsBody');
    const bulkEmptyState     = document.getElementById('bulkEmptyState');
    const bulkPagination     = document.getElementById('bulkPagination');
    const bulkPrevBtn        = document.getElementById('bulkPrevBtn');
    const bulkNextBtn        = document.getElementById('bulkNextBtn');
    const bulkPageInfo       = document.getElementById('bulkPageInfo');

    // عنصر لعرض اسم العميل (من عمود B)
    const nameText   = document.getElementById('nameText');
    const advCard    = document.getElementById('advCard');
    const advNote    = document.getElementById('advNote');
    const sheetSelect   = document.getElementById('sheetSelect');
    const refreshSheetsBtn = document.getElementById('refreshSheetsBtn');
    const newSheetName  = document.getElementById('newSheetName');
    const createSheetBtn= document.getElementById('createSheetBtn');
    const adminColor    = document.getElementById('adminColor');
    const withdrawColor = document.getElementById('withdrawColor');
    const targetModeSel = document.getElementById('targetMode');
    const advRunBtn     = document.getElementById('advRunBtn');

    const discountInput = document.getElementById('discountInput');
    const applyDiscountToMessage = document.getElementById('applyDiscountToMessage');
    const enableSalaryCorrection = document.getElementById('enableSalaryCorrection');
    const menuDiscountInput = document.getElementById('menuDiscount');
    const menuDiscountValue = document.getElementById('menuDiscountValue');

    // بطاقة الشخص
    const personCardEl = document.getElementById('personCard');
    const personNote   = document.getElementById('personNote');
    const personMsg    = document.getElementById('personMsg');
    const copyMsgBtn   = document.getElementById('copyMsgBtn');
    const colorAllBtn  = document.getElementById('colorAllBtn');

    // عناصر واجهة العرض والقائمة
    const menuToggleBtn   = document.getElementById('menuToggle');
    const drawerEl        = document.getElementById('quickTools');
    const drawerCloseBtn  = document.getElementById('drawerClose');
    const drawerBackdrop  = document.getElementById('drawerBackdrop');
    const menuReloadBtn   = document.getElementById('menuReload');
    const menuHomeBtn     = document.getElementById('menuHome');
    const menuBulkBtn     = document.getElementById('menuBulk');
    const menuSectionSelect = document.getElementById('menuSection');
    const menuSectionStatus = document.getElementById('menuSectionStatus');
    if (menuSectionStatus) {
      menuSectionStatus.textContent = '✳️ اكتب اسم كل قسم في العمود K (بدءًا من K2) داخل ورقة Settings. يمكن أن يكون العنوان في K1 مثل Sheet_month_name أو أي وصف تفضله.';
    }
    const viewTabs        = Array.from(document.querySelectorAll('.view-tab'));
    const mainViewEl      = document.getElementById('mainView');
    const bulkViewEl      = document.getElementById('bulkView');

    // آخر ID
    const lastIdPill = document.getElementById('lastIdPill');
    const lastIdText = document.getElementById('lastIdText');

    // أدوات سريعة
    const qtColored = document.getElementById('qtColored');
    const qtUncolored = document.getElementById('qtUncolored');
    const qtMode = document.getElementById('qtMode');
    const qtHide = document.getElementById('qtHideLoad');

    const qtHidePerson = document.getElementById('qtHidePerson');
    const qtDisablePerson = document.getElementById('qtDisablePerson');

    function setDrawerState(open){
      if (!drawerEl) return;
      const shouldOpen = !!open;
      drawerEl.classList.toggle('open', shouldOpen);
      drawerEl.setAttribute('aria-hidden', shouldOpen ? 'false' : 'true');
      if (drawerBackdrop) drawerBackdrop.classList.toggle('show', shouldOpen);
      document.body.classList.toggle('drawer-open', shouldOpen);
    }

    function closeDrawer(){ setDrawerState(false); }
    function toggleDrawer(){
      if (!drawerEl) return;
      setDrawerState(!drawerEl.classList.contains('open'));
    }

    if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleDrawer);
    if (drawerCloseBtn) drawerCloseBtn.addEventListener('click', closeDrawer);
    if (drawerBackdrop) drawerBackdrop.addEventListener('click', closeDrawer);
    if (menuSectionSelect) {
      menuSectionSelect.addEventListener('change', () => {
        const selected = menuSectionSelect.value;
        if (!selected) return;
        if (selected === activeSectionKey) {
          if (activeSectionLabel) {
            setSectionStatus('✅ القسم الحالي: ' + activeSectionLabel);
          }
          return;
        }
        performSectionSwitch(selected);
      });
    }
    updateHeaderSectionUI('');
    fetchSections();

    const viewsMap = { main: mainViewEl, bulk: bulkViewEl };

    function activateView(name){
      const key = viewsMap[name] ? name : 'main';
      viewTabs.forEach(btn => {
        const isActive = (btn.dataset.view || 'main') === key;
        btn.classList.toggle('active', isActive);
      });
      Object.entries(viewsMap).forEach(([viewKey, el]) => {
        if (el) el.classList.toggle('active', viewKey === key);
      });
      try { localStorage.setItem('active_view', key); } catch(_) {}
      closeDrawer();
    }

    if (viewTabs.length){
      viewTabs.forEach(btn => btn.addEventListener('click', () => activateView(btn.dataset.view || 'main')));
      let savedView = null;
      try { savedView = localStorage.getItem('active_view'); } catch(_) {}
      activateView(savedView && viewsMap[savedView] ? savedView : 'main');
    } else {
      activateView('main');
    }

    if (menuHomeBtn) menuHomeBtn.addEventListener('click', () => activateView('main'));
    if (menuBulkBtn) menuBulkBtn.addEventListener('click', () => activateView('bulk'));
    if (menuReloadBtn) menuReloadBtn.addEventListener('click', () => {
      closeDrawer();
      if (reloadBtn) reloadBtn.click();
    });
    if (refreshSheetsBtn) refreshSheetsBtn.addEventListener('click', () => {
      closeDrawer();
      fillSheets();
    });
    document.addEventListener('keydown', evt => {
      if (evt.key === 'Escape') closeDrawer();
    });

    // حالة
    let localMap = null;
    let lastResult = null;
    let lastProfileIds = [];
    let lastBaseId = '';

    let bulkIds = [];
    let bulkResults = [];
    let bulkBusy = false;
    let bulkAnalyzed = false;
    let bulkExecuted = false;
    let bulkAutoAnalyzeTimer = null;
    let bulkExternalAvailable = false;
    let bulkExternalDefaultName = '';
    let bulkExternalErrorMessage = '';
    let bulkPage = 1;

    let sectionOptions = [];
    let activeSectionKey = '';
    let activeSectionLabel = '';
    let manualSearchTimer = null;
    let skipNextManualDebounce = false;

    const BULK_PAGE_SIZE = 20;
    const JUST_COLORED_TTL = 120000;
    const SINGLE_DISCOUNT_STORAGE_KEY = 'single_discount_pct';

    const fmt = n => {
      const x = Number(n);
      return isNaN(x) ? '—' : new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(x);
    };

    const clampDiscountValue = (val) => {
      const num = Number(val);
      if (!isFinite(num)) return 0;
      return Math.max(0, Math.min(100, num));
    };

    const formatDiscountValue = (val) => {
      const num = Number(val);
      if (!isFinite(num)) return '0';
      const rounded = Math.round(num * 100) / 100;
      return Number(rounded.toFixed(2)).toString();
    };

    function updateMenuDiscountUI(pct, options = {}){
      const safe = clampDiscountValue(pct);
      const formatted = formatDiscountValue(safe);
      if (menuDiscountValue) {
        menuDiscountValue.textContent = safe > 0 ? `${formatted}%` : 'بدون خصم';
      }
      if (menuDiscountInput && !options.skipInputUpdate) {
        menuDiscountInput.value = formatted;
      }
    }

    function setSectionStatus(message){
      if (menuSectionStatus) {
        menuSectionStatus.textContent = message || '';
      }
    }

    function updateHeaderSectionUI(label){
      const safe = String(label || '').trim();
      window.__activeSectionLabel = safe;
      if (headerSectionLabelEl) {
        headerSectionLabelEl.textContent = safe || '—';
      }
      if (sectionChipEl) {
        sectionChipEl.classList.toggle('is-empty', !safe);
        sectionChipEl.title = safe ? `القسم الحالي: ${safe}` : 'لم يتم اختيار قسم';
      }
      if (window.__aiClient && typeof window.__aiClient.setActiveSection === 'function') {
        window.__aiClient.setActiveSection(safe);
      }
    }

    function rebuildSectionOptions(){
      if (!menuSectionSelect) return;
      const previous = menuSectionSelect.value;
      menuSectionSelect.innerHTML = '';
      sectionOptions.forEach(section => {
        const opt = document.createElement('option');
        opt.value = section.key || '';
        opt.textContent = section.label || section.key || '';
        menuSectionSelect.appendChild(opt);
      });
      const targetValue = activeSectionKey || previous;
      if (targetValue) {
        menuSectionSelect.value = targetValue;
      }
      if (!menuSectionSelect.value && menuSectionSelect.options.length) {
        menuSectionSelect.selectedIndex = 0;
      }
      if (!activeSectionLabel && sectionOptions.length) {
        const match = sectionOptions.find(s => s.key === menuSectionSelect.value);
        activeSectionLabel = match ? match.label : '';
      }
      menuSectionSelect.disabled = sectionOptions.length <= 1;
    }

    async function fetchSections(options = {}){
      if (!menuSectionSelect) return;
      const keepStatus = options.keepStatus;
      if (!keepStatus) setSectionStatus('⏳ جارٍ تحميل الأقسام…');
      menuSectionSelect.disabled = true;
      try {
        const res = await runServer('getAvailableSections');
        if (!res || res.ok === false) {
          const msg = res?.message || 'فشل تحميل الأقسام.';
          setSectionStatus('⚠️ ' + msg);
          sectionOptions = [];
          activeSectionKey = '';
          activeSectionLabel = '';
          menuSectionSelect.innerHTML = '';
          menuSectionSelect.disabled = true;
          return;
        }
        sectionOptions = Array.isArray(res.sections) ? res.sections : [];
        activeSectionKey = res.activeKey || (sectionOptions[0]?.key || '');
        const match = sectionOptions.find(s => s.key === activeSectionKey);
        activeSectionLabel = res.activeLabel || (match ? match.label : '');
        rebuildSectionOptions();
        updateHeaderSectionUI(activeSectionLabel);
        if (activeSectionLabel) {
          setSectionStatus('✅ القسم الحالي: ' + activeSectionLabel);
        } else {
          setSectionStatus(sectionOptions.length ? 'اختر قسمًا لبدء العمل.' : 'لم يتم إعداد أي قسم.');
        }
      } catch (err) {
        setSectionStatus('⚠️ حدث خطأ أثناء تحميل الأقسام: ' + (err?.message || err));
        sectionOptions = [];
        activeSectionKey = '';
        activeSectionLabel = '';
        menuSectionSelect.innerHTML = '';
        menuSectionSelect.disabled = true;
        updateHeaderSectionUI('');
      }
    }

    async function performSectionSwitch(key){
      const targetKey = String(key || '').trim();
      if (!targetKey) return;
      if (menuSectionSelect) menuSectionSelect.disabled = true;
      setSectionStatus('⏳ جارٍ تحميل بيانات القسم…');
      if (loadNote) loadNote.textContent = '⏳ جارٍ تحميل بيانات القسم…';
      setLoadBtnState(false);
      try {
        const res = await runServer('switchActiveSection', targetKey);
        if (!res || res.ok === false) {
          const msg = res?.message || 'فشل تبديل القسم.';
          setSectionStatus('⚠️ ' + msg);
          if (loadNote) loadNote.textContent = '⚠️ ' + msg;
          return;
        }
        activeSectionKey = res.section?.key || targetKey;
        activeSectionLabel = res.section?.label || (sectionOptions.find(s => s.key === activeSectionKey)?.label || '');
        rebuildSectionOptions();
        updateHeaderSectionUI(activeSectionLabel);
        const baseMsg = res.loadResult?.message || 'تم تحديث بيانات القسم.';
        const serverOk = res.loadResult?.success !== false;
        applyLoadResults(baseMsg, res.snapshot, { serverSuccess: serverOk });
        if (activeSectionLabel) {
          setSectionStatus('✅ القسم الحالي: ' + activeSectionLabel);
        } else {
          setSectionStatus('✅ تم تحديث القسم.');
        }
        if (typeof fillSheets === 'function') {
          fillSheets();
        } else {
          refreshBulkSheets();
        }
      } catch (err) {
        setSectionStatus('⚠️ حدث خطأ أثناء تحديث القسم: ' + (err?.message || err));
      } finally {
        if (menuSectionSelect) {
          menuSectionSelect.disabled = sectionOptions.length <= 1;
          menuSectionSelect.value = activeSectionKey || '';
        }
      }
    }

    function runServer(fnName, ...args) {
      return new Promise((resolve, reject) => {
        try {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(err => reject(err))
            [fnName](...args);
        } catch (err) {
          reject(err);
        }
      });
    }

    const parseBulkIds = txt => {
      return String(txt || '')
        .split(/[\s,\n\r]+/)
        .map(v => v.trim())
        .filter(v => !!v);
    };

    function markJustColored(ids, mode){
      const arr = Array.isArray(ids) ? ids : [ids];
      const flavor = mode === 'agent' ? 'agent' : 'both';
      arr.forEach(id => {
        const key = String(id || '').trim();
        if (!key) return;
        justColored[key] = flavor;
        setTimeout(() => {
          if (justColored[key] === flavor) delete justColored[key];
        }, JUST_COLORED_TTL);
      });
    }

    function updateBulkPaginationUI(total, startIndex, endIndex, totalPages){
      if (!bulkPagination) return;
      if (!total){
        bulkPagination.style.display = 'none';
        if (bulkPageInfo) bulkPageInfo.textContent = '';
        if (bulkPrevBtn) bulkPrevBtn.disabled = true;
        if (bulkNextBtn) bulkNextBtn.disabled = true;
        return;
      }
      const pages = Math.max(1, totalPages || 1);
      const hasPages = total > BULK_PAGE_SIZE;
      bulkPagination.style.display = hasPages ? 'flex' : 'none';
      const start = Math.min(total, Math.max(1, startIndex + 1));
      const end = Math.min(total, Math.max(start, endIndex));
      if (bulkPageInfo){
        if (hasPages){
          bulkPageInfo.textContent = `عرض ${start} - ${end} من ${total} (صفحة ${bulkPage}/${pages})`;
        } else {
          bulkPageInfo.textContent = `عرض ${total} نتيجة`;
        }
      }
      if (bulkPrevBtn) bulkPrevBtn.disabled = !hasPages || bulkPage <= 1;
      if (bulkNextBtn) bulkNextBtn.disabled = !hasPages || bulkPage >= pages;
    }

    function setBulkBusy(flag){
      bulkBusy = !!flag;
      const disabled = bulkBusy;
      [bulkPasteBtn, bulkExecuteBtn,
        bulkScope, bulkTargetSheet, bulkRefreshSheets, bulkNewSheet, bulkCreateSheet,
        bulkExternalTargetSheet, bulkExternalRefreshSheets, bulkExternalNewSheet, bulkExternalCreateSheet,
        bulkAdminColor, bulkWithdrawColor, bulkDiscount, bulkIdsInput]
        .forEach(el => { if (el) el.disabled = disabled; });
    }

    function updateBulkProgress(done, total, label){
      const max = Math.max(0, Number(total) || 0);
      const cur = Math.min(max, Math.max(0, Number(done) || 0));
      const pct = max === 0 ? 0 : Math.round((cur / max) * 100);
      if (bulkProgressBar) bulkProgressBar.style.width = `${pct}%`;
      if (bulkProgressLabel) bulkProgressLabel.textContent = `${pct}%`;
      if (bulkSummaryText) bulkSummaryText.textContent = label || '';
    }

    function updateBulkButtons(){
      const hasIds = bulkIds.length > 0;
      const hasCopyableResults = bulkResults.length > 0;
      if (bulkPasteBtn) bulkPasteBtn.disabled = bulkBusy;
      if (bulkExecuteBtn) bulkExecuteBtn.disabled = !hasIds || !bulkAnalyzed || bulkBusy;
      if (bulkCopyAllBtn) bulkCopyAllBtn.disabled = !hasCopyableResults;
      if (bulkCopySalaryBtn) bulkCopySalaryBtn.disabled = !hasCopyableResults;
      if (bulkResetBtn) bulkResetBtn.disabled = bulkBusy || !bulkExecuted;
    }

    function renderBulkResults(){
      while (bulkResultsBody && bulkResultsBody.firstChild) {
        bulkResultsBody.removeChild(bulkResultsBody.firstChild);
      }
      if (!bulkResults.length) {
        if (bulkEmptyState) bulkEmptyState.style.display = '';
        updateBulkPaginationUI(0, 0, 0, 0);
        return;
      }
      if (bulkEmptyState) bulkEmptyState.style.display = 'none';

      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      const total = bulkResults.length;
      const totalPages = Math.max(1, Math.ceil(total / BULK_PAGE_SIZE));
      if (bulkPage > totalPages) bulkPage = totalPages;
      if (bulkPage < 1) bulkPage = 1;
      const startIndex = (bulkPage - 1) * BULK_PAGE_SIZE;
      const endIndex = Math.min(total, startIndex + BULK_PAGE_SIZE);
      const visible = bulkResults.slice(startIndex, endIndex);

      visible.forEach((res, idx) => {
        const tr = document.createElement('tr');
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const salaryBase = Number(baseSalaryRaw || 0);
        const absoluteIndex = startIndex + idx;
        const cells = [
          { text: String(absoluteIndex + 1) },
          { text: res.id || '' },
          { text: fmt(salaryBase) },
          { html: res.duplicateLabel ? `${res.state || ''} <span class="bulk-chip">${res.duplicateLabel}</span>` : (res.state || '') },
          { text: res.colored ? 'نعم' : 'لا' }
        ];
        cells.forEach((cell, i) => {
          const td = document.createElement('td');
          if (i === 3) td.classList.add('state-cell');
          if (cell.html) td.innerHTML = cell.html;
          else td.textContent = cell.text;
          tr.appendChild(td);
        });
        if (bulkResultsBody) bulkResultsBody.appendChild(tr);
      });
      updateBulkPaginationUI(total, startIndex, endIndex, totalPages);
    }

    function updateBulkCounters(){
      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      let total = bulkIds.length;
      let colored = 0;
      let salarySum = 0;
      bulkResults.forEach(res => {
        if (res.colored) colored++;
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const val = Number(baseSalaryRaw || 0);
        salarySum += isNaN(val) ? 0 : val;
      });
      const uncolored = Math.max(0, total - colored);
      if (bulkCountTotal) bulkCountTotal.textContent = total;
      if (bulkCountColored) bulkCountColored.textContent = colored;
      if (bulkCountUncolored) bulkCountUncolored.textContent = uncolored;
      if (bulkSalarySum) bulkSalarySum.textContent = fmt(salarySum);
    }

    function cancelBulkAutoAnalyze(){
      if (bulkAutoAnalyzeTimer) {
        clearTimeout(bulkAutoAnalyzeTimer);
        bulkAutoAnalyzeTimer = null;
      }
    }

    function scheduleBulkAutoAnalyze(reason){
      if (!bulkIds.length) return;
      cancelBulkAutoAnalyze();
      const attempt = () => {
        if (bulkBusy) {
          bulkAutoAnalyzeTimer = setTimeout(attempt, 180);
          return;
        }
        bulkAutoAnalyzeTimer = null;
        runBulkAnalyze({ skipHandleChange: true, reason: reason || 'auto' });
      };
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ التحليل التلقائي…';
      bulkAutoAnalyzeTimer = setTimeout(attempt, 180);
    }

    function handleBulkIdsChange(options = {}){
      const auto = options.auto !== false;
      bulkIds = parseBulkIds(bulkIdsInput?.value || '');
      bulkPage = 1;
      cancelBulkAutoAnalyze();
      if (!bulkIds.length) {
        bulkResults = [];
        bulkAnalyzed = false;
        bulkExecuted = false;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(0, 1, '');
        if (bulkEmptyState) bulkEmptyState.style.display = '';
        if (bulkStatusText) bulkStatusText.textContent = 'ألصق IDs وسيتم التحليل تلقائيًا.';
        return;
      }
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, bulkIds.length, '');
      if (bulkEmptyState) bulkEmptyState.style.display = 'none';
      if (bulkStatusText) bulkStatusText.textContent = `تمت إضافة ${bulkIds.length} ID — جارٍ التحليل…`;
      if (auto) scheduleBulkAutoAnalyze(options.reason || 'ids-change');
    }

    async function refreshBulkSheets(preserveLocal, preserveExternal){
      try {
        const res = await runServer('getBulkSheetLists');
        if (!res || res.ok === false) {
          if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${res?.message || 'فشل تحميل الأوراق'}`;
          return;
        }

        const localList = Array.isArray(res.localSheets) ? res.localSheets : [];
        if (bulkTargetSheet) {
          const current = preserveLocal || bulkTargetSheet.value;
          bulkTargetSheet.innerHTML = '';
          localList.forEach(name => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            bulkTargetSheet.appendChild(opt);
          });
          if (current && localList.includes(current)) {
            bulkTargetSheet.value = current;
          } else if (res.localDefault && localList.includes(res.localDefault)) {
            bulkTargetSheet.value = res.localDefault;
          }
        }

        const externalList = Array.isArray(res.externalSheets) ? res.externalSheets : [];
        bulkExternalAvailable = !!res.externalEnabled;
        bulkExternalDefaultName = String(res.externalDefault || '');
        bulkExternalErrorMessage = String(res.externalError || '');
        if (bulkExternalTargetSheet) {
          const currentExt = preserveExternal || bulkExternalTargetSheet.value;
          bulkExternalTargetSheet.innerHTML = '';
          externalList.forEach(name => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            bulkExternalTargetSheet.appendChild(opt);
          });
          if (currentExt && externalList.includes(currentExt)) {
            bulkExternalTargetSheet.value = currentExt;
          } else if (bulkExternalDefaultName && externalList.includes(bulkExternalDefaultName)) {
            bulkExternalTargetSheet.value = bulkExternalDefaultName;
          } else if (externalList.length) {
            bulkExternalTargetSheet.value = externalList[0];
          }
        }

        if (bulkExternalFileLabel) {
          bulkExternalFileLabel.textContent = res.externalFileName ? `(${res.externalFileName})` : '';
        }

        applyBulkScopeUI();
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
      }
    }

    async function createBulkSheet(){
      const name = (bulkNewSheet?.value || '').trim();
      if (!name) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ اكتب اسم ورقة جديدة أولًا.';
        return;
      }
      const btn = bulkCreateSheet;
      if (btn) btn.disabled = true;
      try {
        const res = await runServer('createSheetIfMissing', name);
        await refreshBulkSheets(res?.name || name, bulkExternalTargetSheet?.value);
        bulkNewSheet.value = '';
        if (bulkStatusText) bulkStatusText.textContent = `✅ تم تجهيز الورقة: ${res?.name || name}`;
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function createExternalSheet(){
      const name = (bulkExternalNewSheet?.value || '').trim();
      if (!name) {
        if (bulkExternalNote) bulkExternalNote.textContent = '⚠️ اكتب اسم ورقة جديدة أولًا.';
        return;
      }
      const btn = bulkExternalCreateSheet;
      if (btn) btn.disabled = true;
      try {
        const res = await runServer('createExternalSheetIfMissing', name);
        await refreshBulkSheets(bulkTargetSheet?.value, res?.name || name);
        if (bulkExternalNewSheet) bulkExternalNewSheet.value = '';
        if (bulkExternalNote) bulkExternalNote.textContent = `✅ تم تجهيز الورقة الخارجية: ${res?.name || name}`;
      } catch (err) {
        if (bulkExternalNote) bulkExternalNote.textContent = `خطأ: ${err?.message || err}`;
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function applyBulkScopeUI(){
      const scope = bulkScope?.value || 'both';
      const showExternal = scope === 'all';
      if (bulkExternalWrap) {
        bulkExternalWrap.style.display = showExternal ? '' : 'none';
      }
      if (bulkExternalNote) {
        if (showExternal && !bulkExternalAvailable) {
          bulkExternalNote.textContent = bulkExternalErrorMessage || '⚠️ أضف رابط ملف الإدارة الخارجي في Settings (الأعمدة I-L).';
        } else if (showExternal && bulkExternalErrorMessage) {
          bulkExternalNote.textContent = bulkExternalErrorMessage;
        } else {
          bulkExternalNote.textContent = '';
        }
      }
      if (showExternal && bulkExternalAvailable && bulkExternalTargetSheet && !bulkExternalTargetSheet.value && bulkExternalDefaultName) {
        const opts = Array.from(bulkExternalTargetSheet.options || []);
        const match = opts.find(o => o.value === bulkExternalDefaultName);
        if (match) bulkExternalTargetSheet.value = bulkExternalDefaultName;
      }
    }

    async function runBulkAnalyze(options = {}){
      if (bulkBusy) return;
      if (!options.skipHandleChange) handleBulkIdsChange({ auto: false, reason: options.reason });
      if (!bulkIds.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ أضف IDs أولًا.';
        return;
      }
      cancelBulkAutoAnalyze();
      const discountVal = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const scope = bulkScope?.value || 'both';
      setBulkBusy(true);
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, bulkIds.length, 'جارٍ التحليل…');
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ التحليل…';

      const chunkSize = bulkIds.length > 400 ? 150 : 120;
      let processed = 0;
      const aggregated = [];

      try {
        for (let i = 0; i < bulkIds.length; i += chunkSize) {
          const part = bulkIds.slice(i, i + chunkSize);
          const res = await runServer('bulkSearchExact', part, discountVal, scope);
          if (!res || !res.ok) {
            throw new Error(res?.message || 'فشل التحليل');
          }
          const arr = Array.isArray(res.results) ? res.results : [];
          aggregated.push(...arr);
          processed += part.length;
          updateBulkProgress(processed, bulkIds.length, `تم تحليل ${Math.min(processed, bulkIds.length)} من ${bulkIds.length}`);
        }
        bulkPage = 1;
        bulkResults = aggregated;
        bulkAnalyzed = true;
        bulkExecuted = false;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(bulkIds.length, bulkIds.length, 'تم التحليل');
        if (bulkStatusText) bulkStatusText.textContent = `✅ تم تحليل ${bulkResults.length} ID.`;
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
        updateBulkProgress(processed, bulkIds.length, 'توقف بسبب خطأ');
      } finally {
        setBulkBusy(false);
        updateBulkButtons();
      }
    }

    async function runBulkExecute(){
      if (bulkBusy) {
        if (bulkStatusText) bulkStatusText.textContent = '⏳ هناك عملية جارية، انتظر قليلًا.';
        return;
      }
      if (!bulkIds.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ لا يوجد IDs.';
        return;
      }
      if (!bulkAnalyzed) {
        await runBulkAnalyze({ skipHandleChange: true, reason: 'execute' });
        if (!bulkAnalyzed) {
          if (bulkStatusText) bulkStatusText.textContent = '⚠️ تعذّر التحليل قبل التنفيذ.';
          return;
        }
      }

      const ids = bulkIds.slice();
      if (!ids.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ لا يوجد IDs.';
        return;
      }

      const scope = bulkScope?.value || 'both';
      const targetMode = scope === 'agent' ? 'agent' : 'both';
      const sheetName = bulkTargetSheet?.value || '';
      if (targetMode !== 'agent' && !sheetName) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ اختر ورقة الهدف.';
        return;
      }

      let externalSheetName = '';
      if (scope === 'all') {
        if (!bulkExternalAvailable) {
          if (bulkExternalNote) bulkExternalNote.textContent = bulkExternalErrorMessage || '⚠️ أضف ملف الإدارة الخارجي أولًا.';
        }
        externalSheetName = bulkExternalTargetSheet?.value || '';
      }

      const config = {
        sheetName: sheetName,
        color: bulkWithdrawColor?.value || '#9629ff',
        adminColor: bulkAdminColor?.value || '#fde68a',
        withdrawColor: bulkWithdrawColor?.value || '#9629ff',
        targetMode: targetMode,
        scope: scope,
        externalSheetName: externalSheetName
      };

      cancelBulkAutoAnalyze();
      setBulkBusy(true);
      bulkExecuted = false;
      updateBulkButtons();
      updateBulkProgress(0, ids.length, 'جارٍ التنفيذ…');
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ التنفيذ…';

      const chunkSize = ids.length > 300 ? 80 : 60;
      let processed = 0;
      let copiedTotal = 0;
      let skippedTotal = 0;
      let copiedExternalTotal = 0;
      const coloredSet = new Set();

      try {
        for (let i = 0; i < ids.length; i += chunkSize) {
          const part = ids.slice(i, i + chunkSize);
          const res = await runServer('bulkExecuteExact', part, config);
          if (!res || !res.ok) {
            throw new Error(res?.message || 'فشل التنفيذ');
          }
          const newlyColored = Array.isArray(res.coloredIds) ? res.coloredIds : [];
          newlyColored.forEach(id => coloredSet.add(id));
          if (newlyColored.length) {
            markJustColored(newlyColored, targetMode);
            if (localMap) {
              newlyColored.forEach(uid => {
                const key = String(uid || '').trim();
                if (!key || !localMap[key]) return;
                localMap[key].aCol = true;
                if (targetMode === 'both') localMap[key].dCol = true;
              });
            }
          }
          copiedTotal += Number(res.copied || 0);
          skippedTotal += Number(res.skipped || 0);
          copiedExternalTotal += Number(res.copiedExternal || 0);
          processed += part.length;
          updateBulkProgress(processed, ids.length, `تمت معالجة ${Math.min(processed, ids.length)} من ${ids.length}`);
        }

        if (coloredSet.size) {
          bulkResults = bulkResults.map(res => coloredSet.has(res.id)
            ? Object.assign({}, res, { colored: true })
            : res);
        }
        if (coloredSet.size) {
          markJustColored(Array.from(coloredSet), targetMode);
        }
        bulkExecuted = true;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(ids.length, ids.length, 'تم التنفيذ');
        const parts = ['✅ تم التنفيذ'];
        if (coloredSet.size) parts.push(`تلوين ${coloredSet.size}`);
        if (copiedTotal) parts.push(`نسخ ${copiedTotal}`);
        if (copiedExternalTotal) parts.push(`خارجي ${copiedExternalTotal}`);
        if (skippedTotal) parts.push(`تخطي ${skippedTotal}`);
        if (bulkStatusText) bulkStatusText.textContent = parts.join(' • ');
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
        updateBulkProgress(processed, ids.length, 'توقف بسبب خطأ');
      } finally {
        setBulkBusy(false);
        updateBulkButtons();
      }
    }

    async function copyBulk(mode){
      if (!bulkResults.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ نفّذ التحليل والتطبيق أولًا.';
        return;
      }
      const copyingDuringRun = bulkBusy || !bulkExecuted;
      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      const rows = bulkResults.map(res => {
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const salaryVal = Number(baseSalaryRaw || 0);
        const salaryStr = salaryVal.toFixed(2);
        if (mode === 'salary') return salaryStr;
        const stateText = res.state || '';
        const duplicateText = res.duplicateLabel ? `${stateText ? ' - ' : ''}${res.duplicateLabel}` : '';
        return [res.id || '', salaryStr, `${stateText}${duplicateText}`.trim()].join('\t');
      });
      const text = rows.join('\n');
      const successMessage = copyingDuringRun
        ? 'ℹ️ تم النسخ من آخر نتائج مكتملة (لا تزال العملية الحالية جارية).'
        : '✅ تم النسخ إلى الحافظة.';
      const fallbackMessage = copyingDuringRun
        ? 'ℹ️ تم النسخ (وضع احتياطي) من آخر نتائج مكتملة أثناء استمرار العملية الحالية.'
        : '✅ تم النسخ (وضع احتياطي).';
      try {
        await navigator.clipboard.writeText(text);
        if (bulkStatusText) {
          bulkStatusText.textContent = successMessage;
        }
      } catch (err) {
        const helper = document.createElement('textarea');
        helper.style.position = 'fixed';
        helper.style.opacity = '0';
        helper.value = text;
        document.body.appendChild(helper);
        helper.focus();
        helper.select();
        try {
          document.execCommand('copy');
          if (bulkStatusText) bulkStatusText.textContent = fallbackMessage;
        } catch (e2) {
          if (bulkStatusText) bulkStatusText.textContent = `⚠️ انسخ يدويًا: ${e2?.message || e2}`;
        }
        document.body.removeChild(helper);
      }
    }

    function resetBulkTool(){
      if (bulkBusy) return;
      cancelBulkAutoAnalyze();
      if (bulkIdsInput) bulkIdsInput.value = '';
      bulkIds = [];
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      bulkPage = 1;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, 1, '');
      if (bulkEmptyState) bulkEmptyState.style.display = '';
      if (bulkStatusText) bulkStatusText.textContent = 'تمت إعادة التعيين.';
    }

    async function handleBulkPaste(){
      try {
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()) {
          if (bulkIdsInput) bulkIdsInput.value = txt.trim();
          handleBulkIdsChange({ auto: true, reason: 'paste' });
          return;
        }
      } catch (_) {}
      const fallback = prompt('ألصق IDs يدويًا:');
      if (fallback && bulkIdsInput) {
        bulkIdsInput.value = fallback;
        handleBulkIdsChange({ auto: true, reason: 'paste' });
      }
    }

    /******** قسم البيانات (إخفاء/تعطيل) ********/
    function isPersonFeatureDisabled(){ return localStorage.getItem('disable_person_feature') === '1'; }
    function isPersonHidden(){ return localStorage.getItem('hide_person_section') === '1'; }

    function applyPersonVisibility(){
      qtDisablePerson.checked = isPersonFeatureDisabled();
      const hidden = isPersonHidden() || isPersonFeatureDisabled();
      personCardEl.style.display = hidden ? 'none' : '';
      if (isPersonFeatureDisabled()){
        personMsg.value = '';
        personNote.textContent = '—';
        copyMsgBtn.disabled = true;
        colorAllBtn.disabled = true;
      } else {
        copyMsgBtn.disabled = false;
        colorAllBtn.disabled = false;
      }
      qtHidePerson.textContent = hidden ? '👀 إظهار قسم البيانات' : '🙈 إخفاء قسم البيانات';
    }
    qtHidePerson.addEventListener('click', ()=>{
      const cur = isPersonHidden();
      localStorage.setItem('hide_person_section', cur ? '0':'1');
      applyPersonVisibility();
    });
    qtDisablePerson.addEventListener('change', ()=>{
      const en = !!qtDisablePerson.checked;
      localStorage.setItem('disable_person_feature', en ? '1':'0');
      applyPersonVisibility();
    });

    /******** أدوات مساعدة UI ********/
    function flash(el, cls){
      el.classList.remove('flash-blue','flash-green');
      void el.offsetWidth;
      el.classList.add(cls);
    }
    function saveLastId(id){
      try { localStorage.setItem('last_id', id); } catch(_){}
      lastIdText.textContent = id || '';
      lastIdPill.style.display = id ? 'inline-flex' : 'none';
    }
    function loadLastId(){
      let v = '';
      try { v = localStorage.getItem('last_id') || ''; } catch(_){}
      if (v){ lastIdText.textContent = v; lastIdPill.style.display = 'inline-flex'; }
      else { lastIdPill.style.display = 'none'; }
    }
    lastIdPill.addEventListener('click', ()=>{
      const v = lastIdText.textContent || '';
      if (!v) return;
      idInput.value = v;
      clearTimeout(manualSearchTimer);
      manualSearchTimer = null;
      doSearch({ manual:true });
    });

    /******** تحميل الأوراق ********/
    function fillSheets(){
      if (advNote) advNote.textContent = '⏳ جارٍ تحديث قائمة الأوراق…';
      google.script.run
        .withSuccessHandler(arr=>{
          const list = Array.isArray(arr) ? arr : [];
          sheetSelect.innerHTML = '';
          list.forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          if (bulkTargetSheet) {
            const keep = bulkTargetSheet.value;
            refreshBulkSheets(keep, bulkExternalTargetSheet?.value);
          }
          if (advNote) advNote.textContent = '✅ تم تحديث قائمة الأوراق';
        })
        .withFailureHandler(err=> advNote.textContent = 'خطأ: '+(err?.message||''))
        .getAdminSheets();
    }

    /******** تحميل البيانات ********/
    function setLoadBtnState(ok){
      if (ok===true){ reloadBtn.classList.remove('btn-red'); reloadBtn.classList.add('btn-green'); }
      else if (ok===false){ reloadBtn.classList.remove('btn-green'); reloadBtn.classList.add('btn-red'); }
    }

    function applyLoadResults(baseMessage, snapshot, options = {}){
      if (!loadNote) return;
      const baseMsg = baseMessage || 'تم التحميل من السيرفر.';
      const serverOk = options.serverSuccess !== false;
      if (!snapshot || snapshot.ok === false) {
        const extra = snapshot && snapshot.message ? snapshot.message : '';
        loadNote.textContent = extra
          ? `${baseMsg} | ⚠️ فشل المحلي: ${extra}`
          : `${baseMsg} | ⚠️ فشل التحميل المحلي.`;
        setLoadBtnState(false);
        return;
      }
      localMap = snapshot.map || null;
      const st = snapshot.stats || {};
      loadNote.textContent = `${baseMsg} | محلي: ${st.agentRows||0} صف / ${st.agentUnique||0} ID.`;
      setLoadBtnState(serverOk);
      refreshCountsLive();
    }
    function loadData(){
      setLoadBtnState(false);
      loadNote.textContent = '⏳ جارٍ تحميل البيانات…';
      google.script.run
        .withSuccessHandler(srv=>{
          const baseMsg = srv?.message || 'تم التحميل من السيرفر.';
          google.script.run
            .withSuccessHandler(res=>{
              const serverOk = srv?.success !== false;
              applyLoadResults(baseMsg, res, { serverSuccess: serverOk });
            })
            .withFailureHandler(err=>{
              loadNote.textContent = baseMsg + ' | ⚠️ خطأ بالمحلي: ' + (err?.message||'');
              setLoadBtnState(false);
            })
            .getSearchSnapshotLight();
        })
        .withFailureHandler(err=>{
          loadNote.textContent = '⚠️ خطأ بالتحميل: ' + (err?.message||'');
          setLoadBtnState(false);
        })
        .loadDataIntoCache();
    }
    reloadBtn.addEventListener('click', loadData);
    createSheetBtn.addEventListener('click', ()=>{
  const name = (newSheetName.value || '').trim();
  if (!name){ advNote.textContent = '⚠️ اكتب اسم ورقة جديدة'; return; }
  google.script.run
    .withSuccessHandler(msg=>{
      advNote.textContent = msg || 'تم الإنشاء ✅';
      // حدّث القائمة وحدّد الورقة الجديدة
      google.script.run
        .withSuccessHandler(arr=>{
          sheetSelect.innerHTML = '';
          (arr||[]).forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          // حاول اختيار الورقة التي أنشأناها
          const opt = Array.from(sheetSelect.options).find(o => o.value === name);
          if (opt) sheetSelect.value = name;
          newSheetName.value = '';
        })
        .getAdminSheets();
    })
    .withFailureHandler(err=>{
      advNote.textContent = 'خطأ: ' + (err?.message || '');
    })
    .createAdminSheet(name);
    });

    if (bulkIdsInput) bulkIdsInput.addEventListener('input', () => handleBulkIdsChange({ reason: 'typing' }));
    if (bulkPasteBtn) bulkPasteBtn.addEventListener('click', handleBulkPaste);
    if (bulkExecuteBtn) bulkExecuteBtn.addEventListener('click', runBulkExecute);
    if (bulkCopyAllBtn) bulkCopyAllBtn.addEventListener('click', () => copyBulk('all'));
    if (bulkCopySalaryBtn) bulkCopySalaryBtn.addEventListener('click', () => copyBulk('salary'));
    if (bulkResetBtn) bulkResetBtn.addEventListener('click', resetBulkTool);
    if (bulkPrevBtn) bulkPrevBtn.addEventListener('click', () => {
      if (bulkPage > 1) {
        bulkPage--;
        renderBulkResults();
      }
    });
    if (bulkNextBtn) bulkNextBtn.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil((bulkResults.length || 0) / BULK_PAGE_SIZE));
      if (bulkPage < totalPages) {
        bulkPage++;
        renderBulkResults();
      }
    });
    if (bulkDiscount) bulkDiscount.addEventListener('input', () => {
      if (!bulkIds.length) return;
      bulkAnalyzed = false;
      bulkExecuted = false;
      updateBulkButtons();
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ تحديث النتائج بعد تعديل الخصم…';
      scheduleBulkAutoAnalyze('discount-change');
    });
    if (bulkRefreshSheets) bulkRefreshSheets.addEventListener('click', () => refreshBulkSheets(bulkTargetSheet?.value, bulkExternalTargetSheet?.value));
    if (bulkExternalRefreshSheets) bulkExternalRefreshSheets.addEventListener('click', () => refreshBulkSheets(bulkTargetSheet?.value, bulkExternalTargetSheet?.value));
    if (bulkCreateSheet) bulkCreateSheet.addEventListener('click', createBulkSheet);
    if (bulkExternalCreateSheet) bulkExternalCreateSheet.addEventListener('click', createExternalSheet);
    if (bulkScope) bulkScope.addEventListener('change', () => {
      bulkAnalyzed = false;
      bulkExecuted = false;
      applyBulkScopeUI();
      updateBulkButtons();
      if (bulkIds.length) scheduleBulkAutoAnalyze('scope-change');
    });
    refreshBulkSheets();
    applyBulkScopeUI();
    updateBulkButtons();

    /******** لصق ثم بحث / إنتر ********/
    pasteSearchBtn.addEventListener('click', async ()=>{
      pasteHint.textContent = '';
      try{
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()){
          idInput.value = txt.trim();
          clearTimeout(manualSearchTimer);
          manualSearchTimer = null;
          doSearch({ manual:true });
          return;
        }
      }catch(_){}
      idInput.focus(); idInput.select();
      pasteHint.textContent = 'الصق يدويًا وسيبدأ البحث تلقائيًا…';
      const once = ()=>{
        pasteHint.textContent = '';
        idInput.removeEventListener('input', once);
        skipNextManualDebounce = true;
        setTimeout(()=>{
          doSearch({ manual:true });
          skipNextManualDebounce = false;
        }, 0);
      };
      idInput.addEventListener('input', once, { once:true });
    });
    idInput.addEventListener('paste', ()=>{
      skipNextManualDebounce = true;
      setTimeout(()=>{
        clearTimeout(manualSearchTimer);
        manualSearchTimer = null;
        doSearch({ manual:true });
        skipNextManualDebounce = false;
      }, 0);
    });
    idInput.addEventListener('keyup', e=>{
      if (e.key === 'Enter'){
        clearTimeout(manualSearchTimer);
        manualSearchTimer = null;
        doSearch({ manual:true });
      }
    });
    idInput.addEventListener('input', ()=>{
      if (skipNextManualDebounce) return;
      const val = String(idInput.value || '').trim();
      clearTimeout(manualSearchTimer);
      if (!val){
        manualSearchTimer = null;
        doSearch({ manual:true });
        return;
      }
      manualSearchTimer = setTimeout(()=>{
        doSearch({ manual:true });
      }, 140);
    });

    /******** رندر النتائج ********/
    function clearDupUI(){
      dupBadge.style.display = 'none';
      dupBadge.textContent = 'مكرر';
      extraDupInfo.textContent = '';
    }
    function renderLoading(){
      clearDupUI();
      statusBadge.className = 'badge badge--loading';
      statusBadge.textContent = 'جارٍ البحث…';
      amountText.textContent = '⏳';
      multiText.textContent = '';
      if (discountInfo){
        discountInfo.textContent = '';
        discountInfo.style.display = 'none';
      }
      if (nameText) nameText.textContent = '—';
    }
    function applyBadges(baseStatus, duplicateLabel, hasSalaries){
      let baseClass = 'badge--agent';
      if (baseStatus.includes('ادارة') && !hasSalaries) baseClass = 'badge--admin';
      else if (baseStatus.includes('سحب وكالة'))      baseClass = 'badge--withdraw';
      else if (baseStatus.includes('غير موجود'))      baseClass = 'badge--missing';
      statusBadge.className = 'badge ' + baseClass;
      statusBadge.textContent = baseStatus || '—';
      if (duplicateLabel){ dupBadge.style.display='inline-block'; dupBadge.textContent=duplicateLabel; }
      else dupBadge.style.display='none';
    }
    function renderResult(res){
      lastResult = res;
      
      // حدّد اسم الشخص إن وجد فى النتيجة (إما خاصية name أو دمج مصفوفة names)
      (function(){ 
        try{
          let nm = '';
          if (res) {
            if (res.name) nm = String(res.name||'').trim();
            else if (Array.isArray(res.names)) nm = res.names.map(x=>String(x||'').trim()).filter(Boolean).join('، ');
          }
          if (nameText) nameText.textContent = nm || '—';
        }catch(_){ if (nameText) nameText.textContent = '—'; }
      })();
      if (res.status === 'error'){
        applyBadges('خطأ', null, false);
        amountText.textContent = '—';
        multiText.textContent = res.message || '';
        if (discountInfo){
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
        return;
      }
      if (res.status === 'غير موجود'){
        applyBadges('غير موجود', null, false);
        amountText.textContent = '—';
        multiText.textContent = '';
        if (discountInfo){
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
        return;
      }

      const baseStatus = res.status || '';
      const dupLabel   = (res.isDuplicate && res.duplicateLabel) ? res.duplicateLabel : null;

      const hasSalaries = Array.isArray(res.salaries) && res.salaries.length > 0;
      const isAdminOnly = baseStatus.includes('ادارة') && !hasSalaries;

      applyBadges(baseStatus, dupLabel, hasSalaries);

      if (isAdminOnly){
        amountText.textContent = '—';
        multiText.textContent = '';
        if (discountInfo){
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
        flash(resultsBox,'flash-blue');
        return;
      }

      const total = Number(res.totalSalary) || 0;
      const pct   = clampDiscountValue(discountInput?.value);
      const discountedTotal = total * (1 - pct / 100);
      amountText.textContent = fmt(discountedTotal);

      if (discountInfo){
        if (pct > 0 && total > 0){
          const discountAmount = total - discountedTotal;
          discountInfo.textContent = `قبل الخصم: ${fmt(total)} • خصم ${formatDiscountValue(pct)}%: ${fmt(discountAmount)}`;
          discountInfo.style.display = '';
        } else {
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
      }

      if (hasSalaries && res.salaries.length > 1){
        multiText.textContent = '(' + res.salaries.map(n=>fmt(Number(n)||0)).join(' + ') + ')';
      } else multiText.textContent = '';

      flash(resultsBox,'flash-blue');
    }

    /******** الرسالة ********/
    function buildMessageText(card, applyDiscount, localMapRef){
      if (!card || !Array.isArray(card.ids)) return '—';
      const pct = clampDiscountValue(discountInput?.value);
      const lm  = localMapRef || {};
      const header = [];
      if (card.name)    header.push(card.name);
      if (card.phone)   header.push(card.phone);
      if (card.address) header.push(card.address);
      if (card.agency)  header.push(card.agency);
      if (card.note)    header.push('ملاحظة : ' + card.note);

      let total = 0;
      const idLines = [];
      card.ids.forEach(x=>{
        const id = String(x.id||'').trim();
        if (!id) return;
        const node = lm[id];
        const adminOnly = node ? (!node.rowsCount && node.inAdmin) : false;
        let val = Number(x.amount||0);
        if (applyDiscount) val = val * (pct ? (1 - pct/100) : 1);
        total += val;
        idLines.push({ id, text: `${id} ... ${fmt(val)}${adminOnly ? ' ادارة' : ''}`, value: val });
      });

      const lines = [];
      lines.push(header.join('\n')); lines.push('');
      if (idLines.length === 1){
        lines.push(idLines[0].id); lines.push(''); lines.push(fmt(idLines[0].value));
      } else if (idLines.length > 1){
        lines.push(idLines.map(x=>x.text).join('\n'));
        lines.push('•••••••••••••••••••••••');
        lines.push('المجموع : ' + fmt(total));
        lines.push('•••••••••••••••••••••••');
      }
      return lines.filter(Boolean).join('\n');
    }

    function renderPersonCard(id){
      if (isPersonFeatureDisabled()) { personNote.textContent='—'; personMsg.value=''; return; }
      personNote.textContent = 'جاري جلب الرسالة...';
      personMsg.value = '';
      lastProfileIds = [];
      google.script.run
        .withSuccessHandler(card=>{
          if(!card || !card.ok){
            personNote.textContent = card?.message || 'لم يتم العثور على بيانات.';
            personMsg.value = '';
            return;
          }
          lastProfileIds = (card.ids||[]).map(x=> String(x.id));
          const txt = buildMessageText(card, applyDiscountToMessage.checked, localMap);
          personMsg.value = txt;
          personNote.textContent = `تم — عدد IDs: ${lastProfileIds.length}`;
          flash(personCardEl, 'flash-blue');

          clearDupUI();
          const dupList = [];
          lastProfileIds.forEach(uid=>{
            const node = localMap && localMap[uid];
            if (!node) return;
            if (node.aCol && node.dCol) dupList.push(`${uid} (مكرر)`);
            else if (node.aCol)         dupList.push(`${uid} (مكرر وكالة فقط)`);
            else if (node.dCol)         dupList.push(`${uid} (مكرر ادارة فقط)`);
          });
          if (dupList.length){
            dupBadge.style.display='inline-block';
            dupBadge.textContent='مكرر';
            extraDupInfo.textContent = 'IDs مكررة: ' + dupList.join('، ');
          }
        })
        .withFailureHandler(err=>{
          personNote.textContent = 'خطأ: ' + (err?.message||'');
          personMsg.value = '';
        })
        .getPersonCardById(id);
    }

    function rebuildPersonCardUsingLast(){
      if (isPersonFeatureDisabled()) return;
      if (lastBaseId){
        google.script.run
          .withSuccessHandler(card=>{
            if(card && card.ok){
              personMsg.value = buildMessageText(card, !!applyDiscountToMessage.checked, localMap);
              personNote.textContent = `تم — عدد IDs: ${(card.ids||[]).length}`;
            }
          })
          .getPersonCardById(lastBaseId);
      }
    }

    copyMsgBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(personMsg.value||'');
        copyMsgBtn.textContent = '✓ نُسخت';
        setTimeout(()=> copyMsgBtn.textContent='نسخ الرسالة', 900);
      }catch(_){
        personMsg.select(); document.execCommand('copy');
      }
    });

    colorAllBtn.addEventListener('click', ()=>{
      if (isPersonFeatureDisabled()) { personNote.textContent='الميزة معطّلة.'; return; }
      if (!lastProfileIds.length){ personNote.textContent='لا IDs لتلوينها.'; return; }
      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode==='both' && !sheet){ advNote.textContent='اختر ورقة الهدف أولاً.'; return; }

      personNote.textContent = 'جارٍ التلوين...';
      let done=0, fail=0;
      const runOne = (uid)=> new Promise((resolve)=>{
        google.script.run
          .withSuccessHandler(_=>{ done++; resolve(true); })
          .withFailureHandler(_=>{ fail++; resolve(false); })
          .applyAdvancedAction(uid, sheet, adminColor.value, withdrawColor.value, targetMode);
      });
      Promise.all(lastProfileIds.map(runOne)).then(()=>{
        personNote.textContent = `تم — ملوّن: ${done}, فشل: ${fail}`;
        flash(personCardEl,'flash-green');
        if(localMap){
          lastProfileIds.forEach(uid=>{
            if(!localMap[uid]) return;
            localMap[uid].aCol = true;
            if (targetMode==='both') localMap[uid].dCol = true;
          });
        }
        markJustColored(lastProfileIds, targetMode);
        refreshCountsLive();
      });
    });

    /******** تنفيذ ذكي ********/
    function runAdvanced() {
      advNote.textContent = '... جارٍ التنفيذ';
      const id = idInput.value.trim();
      if (!id) { advNote.textContent = '⚠️ أدخل ID أولاً'; return; }

      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode === 'both' && !sheet) {
        advNote.textContent = '⚠️ اختر ورقة الهدف';
        return;
      }

      google.script.run
        .withSuccessHandler(res => {
          advNote.textContent = res?.message || 'تم ✅';
          flash(advCard, 'flash-green');
          if (localMap && localMap[id]) {
            localMap[id].aCol = true;
            if (targetMode === 'both') localMap[id].dCol = true;
          }
          markJustColored(id, targetMode);
          if (lastResult) renderResult(lastResult);
          refreshCountsLive();
        })
        .withFailureHandler(err => {
          advNote.textContent = 'خطأ: ' + (err?.message || '');
        })
        .applyAdvancedAction(id, sheet, adminColor.value, withdrawColor.value, targetMode);
    }
    advRunBtn.addEventListener('click', runAdvanced);

    /******** عداد / وضع داكن / إخفاء تحميل ********/
    function fmtNum(n){ const x=Number(n); return isNaN(x)?'—':new Intl.NumberFormat('en-US').format(x); }
    function refreshCountsLive(pctOverride){
      const pct = (typeof pctOverride === 'number')
        ? clampDiscountValue(pctOverride)
        : clampDiscountValue(discountInput?.value);
      google.script.run
        .withSuccessHandler(res=>{
          if(!res || !res.ok){
            if (qtColored) qtColored.textContent = '—';
            if (qtUncolored) qtUncolored.textContent = '—';
            return;
          }
          if (qtColored) qtColored.textContent   = fmtNum(res.coloredRows || 0);
          if (qtUncolored) qtUncolored.textContent = fmtNum(res.uncoloredRows || 0);
        })
        .withFailureHandler(()=>{
          if (qtColored) qtColored.textContent = '—';
          if (qtUncolored) qtUncolored.textContent = '—';
        })
        .getLiveStatsForFooter(pct);
    }
    function applyModeLabel(){
      const isDark = document.body.classList.contains('dark');
      qtMode.textContent = isDark ? '☀️ وضع فاتح' : '🌙 وضع داكن';
    }
    try { if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark'); } catch(_){}
    applyModeLabel();
    qtMode.addEventListener('click', ()=>{
      const isDark = document.body.classList.toggle('dark');
      applyModeLabel();
      try { localStorage.setItem('darkMode', isDark ? 'true':'false'); } catch(_){}
    });
    function applyHideState(){
      const loadCard = document.getElementById('loadCard');
      const hide = (localStorage.getItem('hide_loadsec') === '1');
      if (loadCard) loadCard.style.display = hide ? 'none' : '';
      qtHide.textContent = hide ? '👀 إظهار التحميل' : '🙈 إخفاء التحميل';
    }
    applyHideState();
    qtHide.addEventListener('click', ()=>{
      const cur = localStorage.getItem('hide_loadsec') === '1';
      localStorage.setItem('hide_loadsec', cur ? '0':'1');
      applyHideState();
    });
    document.getElementById('qtRefreshCnt').addEventListener('click', refreshCountsLive);

    /******** البحث (محلي أولاً ثم السيرفر) ********/
    let querySeq = 0;
    function normalizeId(v){ return String(v||'').trim(); }

    function buildLocalResult(id){
      if (!localMap || (!localMap[id] && !Object.prototype.hasOwnProperty.call(localMap, id))) {
        // لو غير موجود بالوكيل، يمكن يكون "ادارة فقط" — نترك للسيرفر الحكم
        return { status:'غير موجود', totalSalary:'0.00', salaries:[], id:id, isDuplicate:false };
      }
      const node = localMap[id] || {};
      const inAdmin = !!node.inAdmin;
      const rowsCount = Number(node.rowsCount||0);
      const total = Number(node.sum||0);
      const salaries = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];

      let status = 'غير موجود';
      if (rowsCount > 0) {
        status = inAdmin ? ((rowsCount>1)? 'سحب وكالة - راتبين':'سحب وكالة') : ((rowsCount>1)? 'راتبين':'وكالة');
      } else if (inAdmin) {
        status = 'ادارة';
      }

      // مكرر؟
      let isDuplicate=false, duplicateLabel=null;
      const aCol = !!node.aCol;
      const dCol = !!node.dCol;
      if (aCol && dCol) { isDuplicate = true; duplicateLabel = 'مكرر'; }
      else if (aCol)    { isDuplicate = true; duplicateLabel = 'مكرر وكالة فقط'; }
      else if (dCol)    { isDuplicate = true; duplicateLabel = 'مكرر ادارة فقط'; }

      return {
        status: status,
        totalSalary: total.toFixed(2),
        salaries: salaries,
        discountAmount: '0.00',
        salaryAfterDiscount: total.toFixed(2),
        id: id,
        isDuplicate: isDuplicate,
        duplicateLabel: duplicateLabel
      };
    }

  function doSearch(options = {}){
    const id = String(idInput.value||'').trim();
    const allowSuggestions = options && options.allowSuggestions !== false;
    if (!id){
      applyBadges('غير موجود', null, false);
      amountText.textContent = '—';
      multiText.textContent  = '';
      if (discountInfo){
        discountInfo.textContent = '';
        discountInfo.style.display = 'none';
      }
      personNote.textContent = '—';
      personMsg.value = '';
      clearDupUI();
      return;
    }

    saveLastId(id);
    lastBaseId = id;
    renderLoading(); // أبقِ "جارٍ البحث…" كافتراضي

    const hasLocal = !!(localMap && Object.prototype.hasOwnProperty.call(localMap, id));
    if (hasLocal){
      // إذا موجود بالوكيل: أعرض محليًا فورًا (وكالة/سحب وكالة/راتبين)
      const node = localMap[id];
      const inAdmin   = !!node.inAdmin;
      const rowsCount = Number(node.rowsCount||0);
      const total     = Number(node.sum||0);
      const salaries  = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];
      let status;
      if (rowsCount > 0) status = inAdmin ? ((rowsCount>1)? 'سحب وكالة - راتبين':'سحب وكالة')
                                          : ((rowsCount>1)? 'راتبين':'وكالة');
      else status = 'غير موجود';

      let isDuplicate=false, duplicateLabel=null;
      if (node.aCol && node.dCol) { isDuplicate = true; duplicateLabel = 'مكرر'; }
      else if (node.aCol)         { isDuplicate = true; duplicateLabel = 'مكرر وكالة فقط'; }
      else if (node.dCol)         { isDuplicate = true; duplicateLabel = 'مكرر ادارة فقط'; }

      renderResult({
        status,
        totalSalary: total.toFixed(2),
        salaries,
        names: (Array.isArray(node.names) ? node.names : []),
        name: (Array.isArray(node.names) && node.names.length ? String(node.names[0]||'').trim() : ''),
        discountAmount: '0.00',
        salaryAfterDiscount: total.toFixed(2),
        id,
        isDuplicate,
        duplicateLabel
      });
    }

    const mySeq = (++window.__qseq || (window.__qseq=1));
    const pct = clampDiscountValue(discountInput?.value);

    google.script.run
      .withSuccessHandler(res=>{
        if (mySeq !== window.__qseq) return; // تجاهل الردود المتأخرة
        if (!res || res.status === 'error'){
          if (res && res.message) renderResult({ status:'error', message: res.message });
          return;
        }
        renderResult(res);
        renderPersonCard(id);
      })
      .withFailureHandler(err=>{
        if (err && err.message) renderResult({ status:'error', message: err.message });
      })
      .searchId(id, pct);
  }

    // تحديث الخصم دون اتصالات
    (function(){
      if (!discountInput) return;

      let initialValue = clampDiscountValue(discountInput.value);
      try {
        const stored = localStorage.getItem(SINGLE_DISCOUNT_STORAGE_KEY);
        if (stored !== null && stored !== '') {
          initialValue = clampDiscountValue(stored);
        }
      } catch (_) {}

      discountInput.value = formatDiscountValue(initialValue);
      updateMenuDiscountUI(initialValue);

      let debounceTimer;
      discountInput.addEventListener('input', ()=>{
        const pct = clampDiscountValue(discountInput.value);
        const formatted = formatDiscountValue(pct);
        if (discountInput.value !== formatted) {
          discountInput.value = formatted;
        }
        updateMenuDiscountUI(pct, { skipInputUpdate: document.activeElement === menuDiscountInput });
        try { localStorage.setItem(SINGLE_DISCOUNT_STORAGE_KEY, formatted); } catch (_) {}
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=>{
          if (lastResult) renderResult(lastResult);
          refreshCountsLive(pct);
          if (applyDiscountToMessage?.checked && lastBaseId) rebuildPersonCardUsingLast();
        }, 120);
      });
    })();

    if (menuDiscountInput){
      menuDiscountInput.addEventListener('input', ()=>{
        const pct = clampDiscountValue(menuDiscountInput.value);
        const formatted = formatDiscountValue(pct);
        if (menuDiscountInput.value !== formatted) {
          menuDiscountInput.value = formatted;
        }
        updateMenuDiscountUI(pct, { skipInputUpdate: true });
        if (discountInput){
          if (discountInput.value !== formatted) {
            discountInput.value = formatted;
          }
          discountInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
    }

    // مهيّئ سويتش "تصحيح الراتب"
    function initSalaryCorrectionSwitch(){
      if (!enableSalaryCorrection) return;
      google.script.run
        .withSuccessHandler(res=>{
          try { enableSalaryCorrection.checked = !!(res && res.enabled); } catch(_){}
        })
        .withFailureHandler(()=>{})
        .getSalaryCorrectionEnabled();

      enableSalaryCorrection.addEventListener('change', ()=>{
        const desired = !!enableSalaryCorrection.checked;
        google.script.run
          .withSuccessHandler(res=>{
            if (!res || typeof res.enabled === 'undefined') return;
            if (!!res.enabled !== desired) enableSalaryCorrection.checked = !!res.enabled;
            if (lastBaseId) rebuildPersonCardUsingLast();
          })
          .withFailureHandler(()=>{ enableSalaryCorrection.checked = !desired; })
          .setSalaryCorrectionEnabled(desired ? 1 : 0);
      });
    }

    // أول تحميل
    window.addEventListener('load', ()=>{
      applyPersonVisibility();
      loadLastId();
      loadData();
      fillSheets();
      handleBulkIdsChange();
      updateBulkButtons();
      initSalaryCorrectionSwitch();
      setTimeout(refreshCountsLive, 600);
    });
  </script>
  
<!-- ===== /Bulk IDs — Advanced ===== -->
<!-- شارة حالة الإنترنت (فحص ذكي، لا يمنع التنفيذ عند البطء) -->
<style>
  #netBadge{position:fixed;inset-inline-end:18px;inset-block-end:18px;z-index:9999;padding:8px 12px;border-radius:14px;font-size:12px;font-weight:700;box-shadow:0 18px 48px rgba(0,0,0,.38);background:var(--surface-strong);border:1px solid rgba(255,255,255,.12);color:var(--text);display:flex;align-items:center;gap:8px;backdrop-filter:blur(12px);}
  #netBadge.net-weak{background:rgba(255,209,102,.12);border-color:rgba(255,209,102,.32);color:#ffd27f;}
  #netBadge.net-down{background:rgba(255,93,117,.16);border-color:rgba(255,93,117,.32);color:#ff9aad;}
  #netBadge .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(43,255,168,.6);}
  #netBadge.net-weak .dot{background:#ffd166;box-shadow:0 0 8px rgba(255,209,102,.6);}
  #netBadge.net-down .dot{background:#ff5d75;box-shadow:0 0 8px rgba(255,93,117,.6);}
</style>
<div id="netBadge"><span class="dot"></span><span id="netText">فحص الاتصال…</span></div>

<script>
(function(){
  const badge=document.getElementById('netBadge');
  const text=document.getElementById('netText');

  function setState(kind,label){
    badge.classList.remove('net-weak','net-down');
    if(kind==='ok'){ text.textContent=`متصل ✅ ${label||''}`.trim(); }
    else if(kind==='weak'){ badge.classList.add('net-weak'); text.textContent=`بطيء 🟡 ${label||''}`.trim(); }
    else { badge.classList.add('net-down'); text.textContent=`أوفلاين ⛔ ${label||''}`.trim(); }
  }

  function pingServer(timeoutMs){
    return new Promise(res=>{
      let done=false, t0=performance.now();
      try{
        google.script.run
          .withSuccessHandler(()=>{ if(done) return; done=true; res({ok:true,rtt:performance.now()-t0}); })
          .withFailureHandler(()=>{ if(done) return; done=true; res({ok:false}); })
          .ping?.();
        setTimeout(()=>{ if(done) return; done=true; res({ok:false}); }, timeoutMs||2000);
      }catch(_){ res({ok:false}); }
    });
  }

  let lastPing=0;
  async function checkNow(){
    // فحص الجهاز كل ثانية (سنفعّله بالinterval بالأسفل)
    if(!navigator.onLine){ setState('down','(الجهاز غير متصل)'); window.__serverReachable=false; return; }

    // فحص السيرفر كل 30 ثانية فقط
    const now=Date.now();
    if(now-lastPing>30000){
      lastPing=now;
      const s=await pingServer(1500);
      if(s.ok){
        const rtt=Math.round(s.rtt||0);
        if(rtt<=700) setState('ok',`(${rtt}ms)`); else setState('weak',`(${rtt}ms)`);
        window.__serverReachable=true;   // نستفيد منها للعرض فقط
      }else{
        setState('weak','()'); // عرض فقط؛ ما يمنع التنفيذ
        window.__serverReachable=false;
      }
    }
  }

  // فحص الجهاز كل ثانية + السيرفر كل 30 ثانية
  setInterval(checkNow,1000);
  checkNow();
  window.addEventListener('online',()=>{ lastPing=0; checkNow(); });
  window.addEventListener('offline',()=> setState('down','(الجهاز غير متصل)'));

  // 🔁 أهم تغيير: السماح بالتنفيذ ما دام الجهاز Online حتى لو السيرفر بطيء
  window.netEnsureOnline = async function(){
    // لو الجهاز أوفلاين فقط نمنع
    if(!navigator.onLine){
      alert('⛔ الجهاز غير متصل بالإنترنت');
      return false;
    }
    // خلاف ذلك نسمح دومًا (سريع أو بطيء / السيرفر يتأخر بالرد)
    return true;
  };
})();
</script>
<script>
/* حارس زر التنفيذ — يمنع التنفيذ لو الاتصال غير جاهز (بدون لمس كودك الأصلي) */
(function guardExecButton(){
  const SELECTORS = ['#advRunBtn']; // أضف أزرار أخرى هنا لو تحب

  function isServerLikelyUp(){
    if (window.__serverReachable === true)  return true;
    if (window.__serverReachable === false) return false;
    return navigator.onLine; // تقدير سريع
  }

  async function ensureOnlineInteractive(){
    if (typeof window.netEnsureOnline === 'function'){
      return await window.netEnsureOnline();
    }
    if (!navigator.onLine){ alert('⛔ الجهاز أوفلاين — لن يتم التنفيذ.'); return false; }
    if (window.__serverReachable === false){ alert('🟡 السيرفر غير متاح — أعد المحاولة أو حدّث الصفحة.'); return false; }
    return true;
    }

  function handlerCapture(e){
    const btn = e.target.closest(SELECTORS.join(','));
    if (!btn) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    (async ()=>{
      if (!isServerLikelyUp()){
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      } else {
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      }
      // مرّت الشروط ✅ — أعد إطلاق النقر ليكمل كودك الأصلي
      document.removeEventListener('click', handlerCapture, true);
      try { btn.click(); } finally {
        setTimeout(()=> document.addEventListener('click', handlerCapture, true), 0);
      }
    })();
  }

  document.addEventListener('click', handlerCapture, true);
})();
</script>
<!-- ======= سجل النقل — واجهة نهائية ======= -->
<style>
  .lgp-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px;border:1px solid #16a34a;background:#22c55e;color:#fff;
    font-weight:800;cursor:pointer;width:100%;margin:10px 0;border-radius:12px}
  .lgp-btn:disabled{opacity:.6;cursor:not-allowed}

  .lgp-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.35);z-index:99999}
  .lgp-modal.show{display:flex}
  .lgp-sheet{width:min(92vw,560px);padding:14px;background:var(--card-bg,#111827);color:var(--fg,#e5e7eb);
    box-shadow:0 12px 28px rgba(0,0,0,.25);border:1px solid var(--border,#374151);border-radius:12px;overflow:hidden}
  .lgp-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .lgp-title h3{margin:0;font-size:16px;font-weight:800}
  .lgp-ghost{border:1px solid var(--border,#374151);background:transparent;padding:8px 12px;color:inherit;border-radius:12px}

  .lgp-list{max-height:56vh;overflow:auto;border:1px solid var(--border,#374151);background:rgba(255,255,255,.02);border-radius:12px}
  .lgp-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-bottom:1px solid var(--border,#374151)}
  .lgp-row:last-child{border-bottom:0}
  .lgp-id{font-family:ui-monospace,monospace;font-weight:800}
  .lgp-meta{font-size:11px;opacity:.8}

  .lgp-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .lgp-select,.lgp-color{border:1px solid var(--border,#374151);background:transparent;color:inherit;padding:10px;border-radius:12px}
  .lgp-primary{background:#22c55e;border:1px solid #16a34a;color:#fff;padding:12px;font-weight:800;border-radius:12px}

  .lgp-toggle{display:inline-flex;align-items:center;gap:10px}
  .ios-switch{position:relative;width:48px;height:28px}
  .ios-switch input{appearance:none;-webkit-appearance:none;width:48px;height:28px;margin:0;cursor:pointer}
  .ios-switch .track{position:absolute;inset:0;background:#6b7280;transition:.2s;border-radius:999px}
  .ios-switch .thumb{position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.25);transition:.2s}
  .ios-switch input:checked ~ .track{ background:#22c55e }
  .ios-switch input:checked ~ .thumb{ left:23px }

  .lgp-color{ width:44px;height:34px;padding:0 }
  .lgp-hint{font-size:12px;opacity:.75;margin-top:6px}
</style>

<!-- زر "السجل" (يُزرَع تلقائيًا تحت زر التنفيذ) -->
<div id="lgpMount" style="display:none">
  <button id="lgpOpen" class="lgp-btn">📁 السجل</button>
</div>

<!-- النافذة المنبثقة -->
<div id="lgpModal" class="lgp-modal" role="dialog" aria-modal="true">
  <div class="lgp-sheet">
    <div class="lgp-title">
      <h3>📁 سجل النقل (آخر 15)</h3>
      <button id="lgpClose" class="lgp-ghost">إغلاق</button>
    </div>

    <div id="lgpList" class="lgp-list">
      <div class="lgp-row"><div></div><div>… جارٍ التحميل</div><div></div></div>
    </div>

    <div class="lgp-controls">
      <select id="lgpTarget" class="lgp-select" title="اختر ورقة الهدف">
        <option>… جارٍ التحميل</option>
      </select>

      <div class="lgp-toggle">
        <span style="font-size:12px;opacity:.8">لون مخصّص</span>
        <label class="ios-switch">
          <input id="lgpUseCustom" type="checkbox">
          <span class="track"></span><span class="thumb"></span>
        </label>
      </div>
      <input id="lgpColor" type="color" class="lgp-color" value="#9629ff" title="لون بعد النقل" disabled>

      <button id="lgpMove" class="lgp-primary">نقل المحدد</button>
    </div>

    <div id="lgpHint" class="lgp-hint"></div>
  </div>
</div>

<script>
/* زرع زر السجل تحت زر تنفيذ (حسب النتيجة) */
(function(){
  var mount = document.getElementById('lgpMount');
  function resolveHost(){
    if (!mount) return null;
    var slot = document.getElementById('logSlot');
    if (slot) return slot;
    var mobile = document.body.classList.contains('bulk-mobile-active') && window.matchMedia('(max-width: 1200px)').matches;
    if (mobile){
      var mobileHost = document.getElementById('bulkMobileMount');
      if (mobileHost) return mobileHost;
    }
    var runBtn=document.getElementById('advRunBtn');
    var host = runBtn ? runBtn.closest('.card') : null;
    if(!host) host=document.getElementById('advCard');
    if(!host){
      var cards=document.querySelectorAll('.card');
      if(cards.length) host=cards[cards.length-1];
    }
    if(!host) host=document.body;
    return host;
  }
  function placeButton(){
    if(!mount) return;
    var host = resolveHost();
    if(!host) return;
    var mobileHost = document.getElementById('bulkMobileMount');
    if(host === mobileHost){
      if(mount.parentNode!==host || host.firstChild!==mount){
        host.insertBefore(mount, host.firstChild || null);
      }
    } else {
      if(mount.parentNode!==host) host.appendChild(mount);
    }
    mount.style.display='block';
  }
  function ensureMounted(){
    placeButton();
    setTimeout(placeButton,150); setTimeout(placeButton,400); setTimeout(placeButton,1000);
    window.addEventListener('resize',()=>setTimeout(placeButton,150));
    document.addEventListener('bulk-mobile-state-change', ()=>setTimeout(placeButton,50));
    new MutationObserver(()=>placeButton()).observe(document.body,{childList:true,subtree:true});
  }
  (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded',ensureMounted) : ensureMounted();
})();

/* واجهة السجل */
(function(){
  var modal=document.getElementById('lgpModal');
  var openBtn=document.getElementById('lgpOpen');
  var closeBtn=document.getElementById('lgpClose');
  var list=document.getElementById('lgpList');
  var sel=document.getElementById('lgpTarget');
  var useCustom=document.getElementById('lgpUseCustom');
  var colorInp=document.getElementById('lgpColor');
  var move=document.getElementById('lgpMove');
  var hint=document.getElementById('lgpHint');

  function setHint(msg){ if(hint) hint.textContent = msg || ''; }

  function renderList(items){
    list.innerHTML='';
    if(!items||!items.length){
      list.innerHTML='<div class="lgp-row"><div></div><div>لا يوجد سجل</div><div></div></div>';
      list.__rows__=[];
      return;
    }
    items.forEach(function(it,i){
      var row=document.createElement('div');
      row.className='lgp-row';
      row.innerHTML = `
        <label><input type="checkbox" data-idx="${i}"></label>
        <div>
          <div class="lgp-id">${it.id||'—'} | ${it.target||'—'}</div>
          <div class="lgp-meta">${it.at||''} • صفوف: ${it.rows||1}</div>
        </div>
        <div style="width:18px;height:18px;border:1px solid var(--border,#374151);border-radius:6px;background:${it.color||'transparent'}"></div>
      `;
      list.appendChild(row);
    });
    list.__rows__ = items || [];
  }

  function loadAll(){
    list.innerHTML='<div class="lgp-row"><div></div><div>… جارٍ التحميل</div><div></div></div>';
    sel.innerHTML='<option>… جارٍ التحميل</option>';
    setHint('تحميل السجل والأوراق…');

    // السجل
    google.script.run
      .withSuccessHandler(function(items){ renderList(items||[]); setHint(''); })
      .withFailureHandler(function(err){
        list.innerHTML='<div class="lgp-row"><div></div><div>⚠️ خطأ getMoveLogLatest: '+(err&&err.message||'')+'</div><div></div></div>';
        list.__rows__=[];
        setHint('');
      })
      .getMoveLogLatest(15);

    // أسماء الأوراق (يستخدم getAdminSheetsSafe، وإن فشل يحاول getAdminSheets)
    google.script.run
      .withSuccessHandler(function(arr){
        sel.innerHTML='';
        (arr||[]).forEach(function(n){
          var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
        });
        var sheetSelect=document.getElementById('sheetSelect');
        if(sheetSelect && sheetSelect.value) sel.value = sheetSelect.value;
      })
      .withFailureHandler(function(){
        google.script.run
          .withSuccessHandler(function(arr){
            sel.innerHTML='';
            (arr||[]).forEach(function(n){
              var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
            });
          })
          .withFailureHandler(function(err){
            sel.innerHTML=''; var o=document.createElement('option');
            o.textContent='⚠️ فشل الحصول على أسماء الأوراق: '+(err&&err.message||''); sel.appendChild(o);
          })
          .getAdminSheets();
      })
      .getAdminSheetsSafe();
  }

  // فتح/إغلاق
  openBtn && openBtn.addEventListener('click', ()=>{ loadAll(); modal.classList.add('show'); });
  closeBtn && closeBtn.addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });

  // تفعيل/تعطيل لون مخصص
  function syncColor(){ colorInp.disabled = !useCustom.checked; colorInp.style.opacity = useCustom.checked ? '1' : '.55'; }
  useCustom && useCustom.addEventListener('change', syncColor); syncColor();

  // نقل المحدد
  move && move.addEventListener('click', function(){
    var checks = Array.from(list.querySelectorAll('input[type=checkbox]:checked'));
    if(!checks.length){ alert('اختر عناصر للنقل'); return; }
    var rows = list.__rows__ || [];
    var pick = checks.map(function(ch){ var r=rows[+ch.dataset.idx]||{}; return { id:(r.id||''), from:(r.target||'') }; });
    var override = useCustom && useCustom.checked ? (colorInp.value||'') : '';

    move.disabled=true; move.textContent='جارٍ النقل…';
    google.script.run
      .withSuccessHandler(function(res){
        move.disabled=false; move.textContent='نقل المحدد';
        alert(res && res.message ? res.message : 'تم.');
        loadAll();
      })
      .withFailureHandler(function(err){
        move.disabled=false; move.textContent='نقل المحدد';
        alert('خطأ: '+(err&&err.message||'')); 
      })
      .moveFromLog(pick, sel.value||'', override);
  });
})();
</script>
<?!= HtmlService.createHtmlOutputFromFile('AIClient').getContent(); ?>
<!-- ✅ ترتيب موحّد + تثبيت الأدوات السريعة + تنسيق صف البحث -->
 
<script>
(function(){
  if (typeof renderResult !== 'function') return;
  const _orig = renderResult;

  renderResult = function(res){
    // ارسم النتيجة الأصلية أولاً (الراتب/الحالة…)
    _orig(res);

    // ثم عزّز "مكرر" محليًا فورًا
    try{
      const dupBadge = document.getElementById('dupBadge'); // شارة "مكرر" الحالية
      const id = (res && res.id) ? String(res.id).trim() : '';

      // لو السيرفر لسه ما رجّع "مكرر"، بس نحنا شايفين تنفيذ فوري لهالـID
      const serverSaysDup = !!(res && (res.isDuplicate || res.dupFlavor));
      if (id && justColored[id] && !serverSaysDup) {
        if (dupBadge){
          dupBadge.style.display = '';
          dupBadge.textContent = (justColored[id] === 'both') ? 'مكرر' : 'مكرر وكالة فقط';
        }
        // (اختياري) امسح العلامة بعد أول إظهار لحتى ما تضل معك
        // delete justColored[id];
      } else if (dupBadge && !serverSaysDup) {
        // ما في لا محلي ولا سيرفر → أخفِ الشارة
        dupBadge.style.display = 'none';
      }
    }catch(_){}
  };

  // نظافة بصرية: لما تغيّر الـID أو يبدأ بحث جديد امسح الشارة بسرعة
  try {
    const idInput = document.getElementById('idInput');
    if (idInput){
      idInput.addEventListener('input', ()=>{
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      });
    }
    if (typeof renderLoading === 'function'){
      const _rl = renderLoading;
      renderLoading = function(){
        _rl();
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      };
    }
  } catch (_){}
})();
</script>
</body>
</html>
