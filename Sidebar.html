<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>أداة البحث</title>
  
  <style>
    :root{
      color-scheme:dark;
      --bg:#05080f;
      --surface:#121b27;
      --surface-soft:#0f151f;
      --accent:#2bffa8;
      --accent-strong:#1ddf8d;
      --muted:#7f8ba5;
      --text:#e8f7ff;
      --text-strong:#ffffff;
    }
    *{box-sizing:border-box;font-family:'Tajawal','Cairo','Segoe UI',sans-serif;}
    body{margin:0;background:#05080f;color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:24px 16px;}
    body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at 20% 20%,rgba(45,212,255,.18),transparent 55%),radial-gradient(circle at 80% 10%,rgba(150,41,255,.18),transparent 60%);opacity:.6;pointer-events:none;z-index:-1;}
    body.drawer-open{overflow:hidden;}
    body,button,input,select,textarea{font-size:15px;}
    a{color:inherit;text-decoration:none;}
    button{cursor:pointer;border:1px solid rgba(255,255,255,0.12);background:var(--surface-soft);color:var(--text);border-radius:10px;padding:12px 16px;font-weight:700;transition:background .18s ease,opacity .18s ease;box-shadow:0 0 6px rgba(255,255,255,0.08);}
    button:active{transform:scale(.98);}
    button:disabled{opacity:.45;cursor:not-allowed;}
    .btn-green{background:linear-gradient(135deg,var(--accent),var(--accent-strong));color:#04140d;}
    .btn-blue{background:linear-gradient(135deg,#2dd4ff,#38bdf8);color:#031420;}
    .btn-red{background:linear-gradient(135deg,#ff5d75,#ff3b5f);color:#2b040b;}
    .btn-ghost{background:transparent;color:var(--text);}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(12,18,28,0.82);color:var(--text);outline:none;transition:border-color .18s ease,box-shadow .18s ease;box-shadow:0 0 6px rgba(255,255,255,0.08);}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);}
    textarea{min-height:130px;resize:vertical;line-height:1.6;}
    .layout{width:100%;max-width:1080px;display:flex;flex-direction:column;gap:24px;}
    .main-area{display:flex;flex-direction:column;gap:16px;}
    .top-bar{display:flex;align-items:center;gap:12px;}
    .hamburger{width:46px;height:46px;display:flex;align-items:center;justify-content:center;}
    .header-meta{margin-inline-start:auto;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .counter-cluster{display:flex;gap:8px;}
    .counter-mini{display:flex;align-items:center;justify-content:center;min-width:62px;height:46px;border:1px solid rgba(255,255,255,0.12);border-radius:10px;box-shadow:0 0 6px rgba(255,255,255,0.08);padding:0 12px;font-weight:700;}
    .counter-mini .value{font-size:16px;color:var(--accent);}
    .section-chip{display:flex;align-items:center;justify-content:center;min-height:46px;min-width:120px;padding:0 18px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);box-shadow:0 0 6px rgba(255,255,255,0.08);}
    .section-chip.is-empty{opacity:.55;}
    .chip-value{font-weight:700;color:var(--text-strong);}
    .view-switch{display:flex;gap:8px;}
    .view-tab{flex:1;background:transparent;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;color:var(--muted);font-weight:700;box-shadow:0 0 6px rgba(255,255,255,0.08);}
    .view-tab.active{color:var(--accent);border-color:var(--accent);}
    .view-panel{display:none;flex-direction:column;gap:0;margin:0;padding:0;}
    .view-panel.active{display:flex;}
    #resultsBox{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;text-align:center;width:100%;max-width:460px;margin-inline:auto;padding:12px 0;}
    #resultsBox .badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
    .badge{display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid rgba(255,255,255,0.12);box-shadow:0 0 6px rgba(255,255,255,0.08);}
    .badge--withdraw{color:#4de4a1;}
    .badge--agent{color:#38bdf8;}
    .badge--admin{color:#facc15;}
    .badge--dup{color:#ff5d75;}
    .badge--loading{color:var(--muted);}
    #statusChipsRow{display:flex;flex-wrap:wrap;gap:6px;}
    #nameText{font-size:15px;color:var(--muted);}
    #amountText{font-size:56px;font-weight:900;color:var(--accent);}
    #discountInfo{font-size:13px;color:var(--muted);min-height:18px;white-space:pre-line;}
    #multiText{font-size:12px;color:var(--muted);}
    #extraDupInfo{font-size:12px;color:var(--muted);}
    .search-flow{display:flex;flex-direction:column;gap:6px;}
    .search-row{display:flex;gap:8px;align-items:center;}
    .search-row input{flex:1;}
    .search-row button{flex:0 0 auto;}
    .search-meta{display:flex;gap:12px;align-items:center;}
    #pasteHint{flex:1;color:var(--muted);}
    #lastIdPill{margin-inline-start:auto;}
    .single-flow{display:flex;flex-direction:column;gap:12px;padding:12px 0;}
    .single-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;}
    .create-row{display:flex;gap:8px;}
    .create-row input{flex:1;}
    .person-card{display:flex;flex-direction:column;gap:8px;padding:12px;border:1px solid rgba(255,255,255,0.12);border-radius:10px;box-shadow:0 0 6px rgba(255,255,255,0.08);}
    .person-header{display:flex;justify-content:flex-end;gap:8px;}
    .log-slot{display:flex;flex-direction:column;gap:8px;padding:12px 0;}
    #aiMountHere{display:flex;flex-direction:column;gap:12px;padding:12px 0;}
    .bulk-note{color:var(--muted);padding:12px 0;}
    .bulk-config{display:flex;flex-direction:column;gap:8px;padding:12px 0;}
    .bulk-target-row{display:flex;gap:8px;align-items:center;}
    .bulk-inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .bulk-inline input{flex:1 1 200px;}
    .bulk-new-inline{flex-wrap:nowrap;align-items:center;}
    .bulk-new-inline input{flex:1 1 auto;min-width:0;}
    .bulk-external{display:flex;flex-direction:column;gap:8px;padding:12px 0;}
    .bulk-external-row{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
    .bulk-external-row select,.bulk-external-row input{flex:1;min-width:0;}
    .bulk-external-row button{flex:0 0 auto;white-space:nowrap;}
    .bulk-external-row > *{min-height:46px;}
    .bulk-colors{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;}
    .bulk-actions-row{display:flex;flex-wrap:wrap;gap:8px;padding:12px 0;}
    .bulk-actions-row button{flex:1 1 160px;}
    .bulk-progress-wrap{display:flex;flex-direction:column;gap:6px;padding:12px 0;}
    .bulk-progress{height:10px;background:rgba(255,255,255,0.12);border-radius:999px;overflow:hidden;}
    .bulk-progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#38bdf8);transition:width .3s ease;}
    .bulk-progress-text{display:flex;justify-content:space-between;gap:8px;color:var(--muted);font-size:13px;}
    .bulk-counters{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;padding:12px 0;}
    .bulk-counter{border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:10px;box-shadow:0 0 6px rgba(255,255,255,0.08);font-size:12px;color:var(--muted);}
    #bulkIds{min-height:220px;}
    .bulk-table-wrap{display:flex;flex-direction:column;gap:8px;padding:12px 0;}
    .bulk-table{width:100%;border-collapse:collapse;font-size:13px;}
    .bulk-table th,.bulk-table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.12);text-align:right;}
    .bulk-table thead{background:rgba(255,255,255,0.04);}
    .bulk-pagination{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;}
    .bulk-page-btn{flex:0 0 auto;}
    .bulk-page-info{color:var(--muted);font-size:12px;}
    .bulk-chip{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);margin-inline-start:6px;font-size:11px;}
    td.state-cell{display:flex;align-items:center;gap:6px;}
    .drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:8;}
    .drawer-backdrop.show{opacity:1;pointer-events:auto;}
    #quickTools{position:fixed;top:24px;left:50%;transform:translateX(-50%);width:92%;max-width:360px;background:rgba(12,18,28,0.94);border:1px solid rgba(255,255,255,0.12);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px;z-index:9;opacity:0;pointer-events:none;transition:opacity .2s ease,transform .2s ease;}
    #quickTools.open{opacity:1;pointer-events:auto;transform:translate(-50%,0);}
    .drawer-header{display:flex;justify-content:flex-end;}
    #drawerClose{width:38px;height:38px;display:flex;align-items:center;justify-content:center;}
    .menu-stats{display:flex;gap:8px;flex-wrap:wrap;}
    .menu-counter{flex:1 1 120px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.12);border-radius:10px;box-shadow:0 0 6px rgba(255,255,255,0.08);padding:10px;font-weight:700;}
    #menuSectionChip{display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.18);border-radius:999px;min-height:46px;box-shadow:0 0 6px rgba(255,255,255,0.08);}
    #menuSectionChip.is-empty{opacity:.55;}
    #loadCard{display:flex;flex-direction:column;gap:8px;}
    #loadNote{color:var(--muted);font-size:12px;}
    .menu-actions{display:flex;flex-direction:column;gap:8px;}
    .menu-btn{width:100%;border:1px solid rgba(255,255,255,0.12);border-radius:10px;background:transparent;color:var(--text);padding:12px 16px;font-weight:700;box-shadow:0 0 6px rgba(255,255,255,0.08);}
    .menu-section{display:flex;flex-direction:column;gap:8px;}
    .menu-toggle{display:flex;justify-content:flex-end;}
    .drawer-discount-row{display:flex;gap:8px;align-items:center;}
    .drawer-discount-row input{flex:1;}
    .drawer-discount-value{min-width:90px;text-align:center;color:var(--muted);font-size:13px;font-weight:700;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);box-shadow:0 0 6px rgba(255,255,255,0.08);}
    .drawer-note{font-size:12px;color:var(--muted);line-height:1.5;}
    #qtMode{width:58px;height:30px;border-radius:999px;background:var(--surface-soft);position:relative;border:1px solid rgba(255,255,255,0.18);padding:0;font-size:0;line-height:0;box-shadow:0 0 6px rgba(255,255,255,0.08);}
    #qtMode::after{content:'';position:absolute;top:3px;right:3px;width:24px;height:24px;border-radius:50%;background:#fff;transition:transform .2s ease,background .2s ease;}
    body.dark #qtMode{background:var(--accent);border-color:rgba(43,255,168,0.32);}
    body.dark #qtMode::after{transform:translateX(-26px);background:#052016;}
    .hidden-tools{display:none;}
    .muted{color:var(--muted);font-size:12px;}
    .lastid{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);color:var(--muted);cursor:pointer;box-shadow:0 0 6px rgba(255,255,255,0.08);font-size:12px;}
    @media(min-width:1024px){
      body{padding:48px;}
      .layout{flex-direction:row;align-items:flex-start;gap:32px;}
      #quickTools{position:sticky;top:0;left:auto;transform:none;width:280px;max-width:none;opacity:1;pointer-events:auto;}
      #drawerBackdrop{display:none;}
      .drawer-header{display:none;}
    }
    @media(max-width:768px){
      body{padding:16px 10px;}
      button,input[type="text"],input[type="number"],select,textarea{width:100%;font-size:16px;border-radius:10px;}
      .search-row{flex-direction:column;align-items:stretch;}
      .search-row button{width:100%;}
      .search-meta{flex-direction:column;align-items:flex-end;gap:4px;}
      .create-row{flex-direction:column;}
      .bulk-target-row{flex-direction:column;align-items:stretch;}
      .bulk-inline{flex-direction:column;}
      .bulk-new-inline{flex-direction:row;flex-wrap:nowrap;}
      .bulk-new-inline input{max-width:65vw;}
      .bulk-new-inline button{width:auto;flex:0 0 auto;}
      #bulkExternalWrap .bulk-external-row input{max-width:68vw;}
      .bulk-actions-row button{flex:1;}
      #quickTools{top:16px;}
    }
  </style>

</head>


<body class="dark">
  <div class="layout">
    <aside id="quickTools" class="drawer" aria-hidden="true">
      <div class="drawer-header">
        <button id="drawerClose" type="button" aria-label="إغلاق">✕</button>
      </div>
      <div class="menu-stats">
        <div class="menu-counter" title="ملوّن">
          <span id="menuQtColored" class="value">—</span>
        </div>
        <div class="menu-counter" title="غير ملوّن">
          <span id="menuQtUncolored" class="value">—</span>
        </div>
      </div>
      <div id="menuSectionChip" class="section-chip is-empty" title="القسم">
        <span id="menuSectionLabel" class="chip-value">—</span>
      </div>
      <div id="loadCard">
        <button id="reloadBtn" class="btn-red" type="button">تحميل البيانات</button>
        <div id="loadNote"></div>
      </div>
      <div class="menu-actions">
        <button id="menuHome" class="menu-btn" type="button">الصفحة الرئيسية</button>
        <button id="menuBulk" class="menu-btn" type="button">أداة البحث الجماعي</button>
        <button id="refreshSheetsBtn" class="menu-btn" type="button">تحديث قائمة الأوراق</button>
        <button id="togglePersonCardBtn" class="menu-btn" type="button">إيقاف بيانات صاحب الـID</button>
      </div>
      <div class="menu-section">
        <select id="menuSection"></select>
        <div id="menuSectionStatus" class="drawer-note"></div>
      </div>
      <div class="menu-toggle">
        <button id="qtMode" type="button" aria-label="تبديل الوضع"></button>
      </div>
      <div class="menu-section">
        <div class="drawer-discount-row">
          <input id="menuDiscount" type="number" min="0" max="100" step="0.1" inputmode="decimal" placeholder="0">
          <span id="menuDiscountValue" class="drawer-discount-value">بدون خصم</span>
        </div>
      </div>
      <div class="hidden-tools">
        <button id="qtHideLoad" type="button"></button>
        <button id="qtHidePerson" type="button"></button>
        <label><input id="qtDisablePerson" type="checkbox"></label>
        <button id="qtRefreshCnt" type="button"></button>
      </div>
    </aside>

    <div class="main-area">
      <header class="top-bar">
        <button id="menuToggle" class="hamburger" type="button" aria-label="فتح القائمة">
          <svg width="22" height="18" viewBox="0 0 22 18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="1" y="1" width="20" height="2.4" rx="1.2" fill="currentColor" />
            <rect x="1" y="7.8" width="20" height="2.4" rx="1.2" fill="currentColor" />
            <rect x="1" y="14.6" width="20" height="2.4" rx="1.2" fill="currentColor" />
          </svg>
        </button>
        <div class="header-meta">
          <div class="counter-cluster">
            <div class="counter-mini" title="ملوّن">
              <span id="qtColored" class="value">—</span>
            </div>
            <div class="counter-mini" title="غير ملوّن">
              <span id="qtUncolored" class="value">—</span>
            </div>
          </div>
          <div id="sectionChip" class="section-chip is-empty" title="القسم">
            <span id="headerSectionLabel" class="chip-value">—</span>
          </div>
        </div>
      </header>

      <div class="view-switch">
        <button class="view-tab active" type="button" data-view="main">الصفحة الرئيسية</button>
        <button class="view-tab" type="button" data-view="bulk">أداة البحث الجماعي</button>
      </div>

      <section id="mainView" class="view-panel active">
        <div id="resultsBox">
          <div class="badges">
            <span id="statusBadge" class="badge badge--loading">—</span>
            <span id="dupBadge" class="badge badge--dup" style="display:none">مكرر</span>
            <span id="statusChipsRow"></span>
          </div>
          <div id="nameText">—</div>
          <div id="amountText">—</div>
          <div id="discountInfo" style="display:none"></div>
          <div id="multiText"></div>
          <div id="extraDupInfo" class="muted"></div>
        </div>
        <div class="search-flow">
          <div class="search-row">
            <input id="idInput" type="text" placeholder="أدخل ID هنا" autocomplete="off" inputmode="numeric">
            <button id="pasteSearchBtn" class="btn-blue" type="button">لصق ثم بحث</button>
          </div>
          <div class="search-meta">
            <div id="pasteHint" class="muted"></div>
            <div id="lastIdPill" class="lastid" style="display:none">آخر ID: <b id="lastIdText"></b></div>
          </div>
        </div>
        <div class="single-flow">
          <button id="advRunBtn" class="btn-green" type="button">تنفيذ (حسب النتيجة)</button>
          <div id="advNote" class="muted"></div>
          <div class="single-grid">
            <select id="sheetSelect" aria-label="الهدف"></select>
            <select id="targetMode" aria-label="وضع التنفيذ">
              <option value="agent">الوكيل فقط</option>
              <option value="both" selected>الإدارة + الوكيل</option>
            </select>
            <input id="adminColor" type="color" value="#fde68a" aria-label="لون الإدارة">
            <input id="withdrawColor" type="color" value="#9629ff" aria-label="لون سحب وكالة">
          </div>
          <div class="create-row">
            <input id="newSheetName" type="text" placeholder="اسم ورقة جديدة (داخل الإدارة)">
            <button id="createSheetBtn" class="btn-ghost" type="button">إنشاء</button>
          </div>
          <div id="personCard" class="person-card" style="display:none;">
            <div class="person-header">
              <button id="copyMsgBtn" class="btn-green" type="button">نسخ الرسالة</button>
              <button id="colorAllBtn" class="btn-ghost" type="button" title="تلوين كل الـIDs لهذا الشخص بسرعة">تلوين الكل</button>
            </div>
            <div id="personNote" class="muted"></div>
            <textarea id="personMsg" rows="8" readonly></textarea>
          </div>
        </div>
        <div id="logSlot" class="log-slot"></div>
        <div id="aiMountHere"></div>
        <div id="bulkMobileMount" style="display:none"></div>
      </section>

      <section id="bulkView" class="view-panel">
        <div id="bulkStatusText" class="bulk-note"></div>
        <div class="bulk-config">
          <select id="bulkScope">
            <option value="agent">الوكيل فقط</option>
            <option value="both" selected>الإدارة + الوكيل</option>
            <option value="all">الكل (يشمل الخارجي)</option>
          </select>
          <div class="bulk-target-row">
            <select id="bulkTargetSheet" style="flex:1"></select>
          </div>
          <div class="bulk-inline bulk-new-inline">
            <input id="bulkNewSheet" type="text" placeholder="اسم ورقة جديدة (داخل الإدارة)">
            <button id="bulkCreateSheet" class="btn-ghost">إنشاء ورقة</button>
          </div>
          <div id="bulkExternalWrap" class="bulk-external" style="display:none;">
            <div id="bulkExternalFileLabel" class="muted"></div>
            <div class="bulk-external-row">
              <select id="bulkExternalTargetSheet"></select>
              <button id="bulkExternalRefreshSheets" class="btn-ghost" title="تحديث قائمة الأوراق الخارجية">↻</button>
            </div>
            <div class="bulk-external-row">
              <input id="bulkExternalNewSheet" type="text" placeholder="اسم ورقة جديدة (خارجية)">
              <button id="bulkExternalCreateSheet" class="btn-ghost">إنشاء</button>
            </div>
            <div id="bulkExternalNote" class="muted"></div>
          </div>
          <div class="bulk-colors">
            <input id="bulkAdminColor" type="color" value="#fde68a" aria-label="لون الإدارة">
            <input id="bulkWithdrawColor" type="color" value="#9629ff" aria-label="لون سحب وكالة">
            <input id="bulkDiscount" type="number" min="0" max="100" value="0" step="1">
          </div>
        </div>
        <div class="bulk-actions-row">
          <button id="bulkPasteBtn" class="btn-blue">لصق ثم بحث</button>
          <button id="bulkExecuteBtn" class="btn-red" disabled>تنفيذ الكل</button>
          <button id="bulkCopyAllBtn" class="btn-ghost" disabled>نسخ الكل</button>
          <button id="bulkCopySalaryBtn" class="btn-ghost" disabled>نسخ الراتب فقط</button>
        </div>
        <div class="bulk-progress-wrap">
          <div class="bulk-progress">
            <div id="bulkProgressBar" class="bulk-progress-bar"></div>
          </div>
          <div class="bulk-progress-text">
            <span id="bulkProgressLabel">0%</span>
            <span id="bulkSummaryText"></span>
          </div>
        </div>
        <div class="bulk-counters">
          <div class="bulk-counter" title="عدد الإدخالات"><b id="bulkCountTotal">0</b></div>
          <div class="bulk-counter" title="ملوّن"><b id="bulkCountColored">0</b></div>
          <div class="bulk-counter" title="غير ملوّن"><b id="bulkCountUncolored">0</b></div>
          <div class="bulk-counter" title="مجموع الرواتب"><b id="bulkSalarySum">0</b></div>
        </div>
        <textarea id="bulkIds" placeholder="ألصق عدة IDs (سطر لكل ID أو مفصولة بمسافات)"></textarea>
        <div class="bulk-table-wrap">
          <table class="bulk-table">
            <thead>
              <tr>
                <th>#</th>
                <th>ID</th>
                <th>الراتب</th>
                <th>الحالة</th>
                <th>ملوّن؟</th>
              </tr>
            </thead>
            <tbody id="bulkResultsBody"></tbody>
          </table>
          <div id="bulkPagination" class="bulk-pagination">
            <button id="bulkPrevBtn" class="bulk-page-btn">‹ السابق</button>
            <span id="bulkPageInfo" class="bulk-page-info"></span>
            <button id="bulkNextBtn" class="bulk-page-btn">التالي ›</button>
          </div>
          <div id="bulkEmptyState" class="bulk-empty">لا توجد نتائج بعد.</div>
        </div>
      </section>
    </div>
  </div>

  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <script>
    // عناصر عامة
    const loadCard       = document.getElementById('loadCard');
    const reloadBtn      = document.getElementById('reloadBtn');
    const loadNote       = document.getElementById('loadNote');
    const mobileLoadCardSpot = document.getElementById('mobileLoadCardSpot');
    const loadCardHome = loadCard ? { parent: loadCard.parentNode, next: loadCard.nextSibling } : null;
    const loadCardMedia = window.matchMedia('(max-width: 768px)');

    function placeLoadCard(){
      if (!loadCard || !loadCardHome || !loadCardHome.parent) return;
      if (loadCardMedia.matches && mobileLoadCardSpot){
        if (loadCard.parentNode !== mobileLoadCardSpot){
          mobileLoadCardSpot.appendChild(loadCard);
        }
        mobileLoadCardSpot.classList.add('show');
      } else {
        if (loadCard.parentNode !== loadCardHome.parent){
          if (loadCardHome.next && loadCardHome.next.parentNode === loadCardHome.parent){
            loadCardHome.parent.insertBefore(loadCard, loadCardHome.next);
          } else {
            loadCardHome.parent.appendChild(loadCard);
          }
        }
        if (mobileLoadCardSpot){
          mobileLoadCardSpot.classList.remove('show');
        }
      }
    }

    placeLoadCard();
    if (typeof loadCardMedia.addEventListener === 'function'){
      loadCardMedia.addEventListener('change', placeLoadCard);
    } else if (typeof loadCardMedia.addListener === 'function'){
      loadCardMedia.addListener(placeLoadCard);
    }

    const idInput        = document.getElementById('idInput');
    const pasteSearchBtn = document.getElementById('pasteSearchBtn');
    const pasteHint      = document.getElementById('pasteHint');
    const headerSectionLabelEl = document.getElementById('headerSectionLabel');
    const sectionChipEl        = document.getElementById('sectionChip');
    const menuSectionChipEl   = document.getElementById('menuSectionChip');
    const menuSectionLabelEl  = document.getElementById('menuSectionLabel');

    const resultsBox  = document.getElementById('resultsBox');
    const statusBadge = document.getElementById('statusBadge');
    const dupBadge    = document.getElementById('dupBadge');
    const amountText  = document.getElementById('amountText');
    const discountInfo= document.getElementById('discountInfo');
    const multiText   = document.getElementById('multiText');
    const extraDupInfo= document.getElementById('extraDupInfo');
    const justColored = Object.create(null);
    const justColoredOrder = [];
    const LIVE_SOURCE_SINGLE = 'single';
    const LIVE_SOURCE_BULK = 'bulk';
    const liveDisplaySources = Object.create(null);

    const bulkCardEl         = document.getElementById('bulkCard');
    const bulkScope          = document.getElementById('bulkScope');
    const bulkTargetSheet          = document.getElementById('bulkTargetSheet');
    const bulkRefreshSheets        = document.getElementById('bulkRefreshSheets');
    const bulkNewSheet             = document.getElementById('bulkNewSheet');
    const bulkCreateSheet          = document.getElementById('bulkCreateSheet');
    const bulkExternalWrap         = document.getElementById('bulkExternalWrap');
    const bulkExternalTargetSheet  = document.getElementById('bulkExternalTargetSheet');
    const bulkExternalRefreshSheets= document.getElementById('bulkExternalRefreshSheets');
    const bulkExternalNewSheet     = document.getElementById('bulkExternalNewSheet');
    const bulkExternalCreateSheet  = document.getElementById('bulkExternalCreateSheet');
    const bulkExternalNote         = document.getElementById('bulkExternalNote');
    const bulkExternalFileLabel    = document.getElementById('bulkExternalFileLabel');
    const bulkAdminColor           = document.getElementById('bulkAdminColor');
    const bulkWithdrawColor        = document.getElementById('bulkWithdrawColor');
    const bulkDiscount             = document.getElementById('bulkDiscount');
    const bulkIdsInput       = document.getElementById('bulkIds');
    const bulkPasteBtn       = document.getElementById('bulkPasteBtn');
    const bulkExecuteBtn     = document.getElementById('bulkExecuteBtn');
    const bulkCopyAllBtn     = document.getElementById('bulkCopyAllBtn');
    const bulkCopySalaryBtn  = document.getElementById('bulkCopySalaryBtn');
    const bulkProgressBar    = document.getElementById('bulkProgressBar');
    const bulkProgressLabel  = document.getElementById('bulkProgressLabel');
    const bulkSummaryText    = document.getElementById('bulkSummaryText');
    const bulkStatusText     = document.getElementById('bulkStatusText');
    const bulkCountTotal     = document.getElementById('bulkCountTotal');
    const bulkCountColored   = document.getElementById('bulkCountColored');
    const bulkCountUncolored = document.getElementById('bulkCountUncolored');
    const bulkSalarySum      = document.getElementById('bulkSalarySum');
    const bulkResultsBody    = document.getElementById('bulkResultsBody');
    const bulkEmptyState     = document.getElementById('bulkEmptyState');
    const bulkPagination     = document.getElementById('bulkPagination');
    const bulkPrevBtn        = document.getElementById('bulkPrevBtn');
    const bulkNextBtn        = document.getElementById('bulkNextBtn');
    const bulkPageInfo       = document.getElementById('bulkPageInfo');

    // عنصر لعرض اسم العميل (من عمود B)
    const nameText   = document.getElementById('nameText');
    const advCard    = document.getElementById('advCard');
    const advNote    = document.getElementById('advNote');
    const sheetSelect   = document.getElementById('sheetSelect');
    const refreshSheetsBtn = document.getElementById('refreshSheetsBtn');
    const newSheetName  = document.getElementById('newSheetName');
    const createSheetBtn= document.getElementById('createSheetBtn');
    const adminColor    = document.getElementById('adminColor');
    const withdrawColor = document.getElementById('withdrawColor');
    const targetModeSel = document.getElementById('targetMode');
    const advRunBtn     = document.getElementById('advRunBtn');

    const applyDiscountToMessage = document.getElementById('applyDiscountToMessage');
    const enableSalaryCorrection = document.getElementById('enableSalaryCorrection');
    const menuDiscountInput = document.getElementById('menuDiscount');
    const menuDiscountValue = document.getElementById('menuDiscountValue');
    const discountInput = document.getElementById('discountInput') || menuDiscountInput;

    // بطاقة الشخص
    const personCardEl = document.getElementById('personCard');
    const personNote   = document.getElementById('personNote');
    const personMsg    = document.getElementById('personMsg');
    const copyMsgBtn   = document.getElementById('copyMsgBtn');
    const colorAllBtn  = document.getElementById('colorAllBtn');

    // عناصر واجهة العرض والقائمة
    const menuToggleBtn   = document.getElementById('menuToggle');
    const drawerEl        = document.getElementById('quickTools');
    const drawerCloseBtn  = document.getElementById('drawerClose');
    const drawerBackdrop  = document.getElementById('drawerBackdrop');
    const menuReloadBtn   = document.getElementById('menuReload');
    const menuHomeBtn     = document.getElementById('menuHome');
    const menuBulkBtn     = document.getElementById('menuBulk');
    const personCardToggleBtn = document.getElementById('togglePersonCardBtn');
    const menuSectionSelect = document.getElementById('menuSection');
    const menuSectionStatus = document.getElementById('menuSectionStatus');
    if (menuSectionStatus) {
      menuSectionStatus.textContent = '✳️ اكتب اسم كل قسم في العمود K (بدءًا من K2) داخل ورقة Settings. يمكن أن يكون العنوان في K1 مثل Sheet_month_name أو أي وصف تفضله.';
    }
    const viewTabs        = Array.from(document.querySelectorAll('.view-tab'));
    const mainViewEl      = document.getElementById('mainView');
    const bulkViewEl      = document.getElementById('bulkView');

    // آخر ID
    const lastIdPill = document.getElementById('lastIdPill');
    const lastIdText = document.getElementById('lastIdText');

    // أدوات سريعة
    const qtColored = document.getElementById('qtColored');
    const qtUncolored = document.getElementById('qtUncolored');
    const menuQtColored = document.getElementById('menuQtColored');
    const menuQtUncolored = document.getElementById('menuQtUncolored');
    const qtMode = document.getElementById('qtMode');
    const qtHide = document.getElementById('qtHideLoad');

    const qtHidePerson = document.getElementById('qtHidePerson');
    const qtDisablePerson = document.getElementById('qtDisablePerson');

    function setDrawerState(open){
      if (!drawerEl) return;
      const shouldOpen = !!open;
      drawerEl.classList.toggle('open', shouldOpen);
      drawerEl.setAttribute('aria-hidden', shouldOpen ? 'false' : 'true');
      if (drawerBackdrop) drawerBackdrop.classList.toggle('show', shouldOpen);
      document.body.classList.toggle('drawer-open', shouldOpen);
    }

    function closeDrawer(){ setDrawerState(false); }
    function toggleDrawer(){
      if (!drawerEl) return;
      setDrawerState(!drawerEl.classList.contains('open'));
    }

    if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleDrawer);
    if (drawerCloseBtn) drawerCloseBtn.addEventListener('click', closeDrawer);
    if (drawerBackdrop) drawerBackdrop.addEventListener('click', closeDrawer);
    if (menuSectionSelect) {
      menuSectionSelect.addEventListener('change', () => {
        const selected = menuSectionSelect.value;
        if (!selected) return;
        if (selected === activeSectionKey) {
          if (activeSectionLabel) {
            setSectionStatus('✅ القسم الحالي: ' + activeSectionLabel);
          }
          return;
        }
        performSectionSwitch(selected);
      });
    }
    updateHeaderSectionUI('');
    fetchSections();

    const viewsMap = { main: mainViewEl, bulk: bulkViewEl };

    function activateView(name){
      const key = viewsMap[name] ? name : 'main';
      viewTabs.forEach(btn => {
        const isActive = (btn.dataset.view || 'main') === key;
        btn.classList.toggle('active', isActive);
      });
      Object.entries(viewsMap).forEach(([viewKey, el]) => {
        if (el) el.classList.toggle('active', viewKey === key);
      });
      try { localStorage.setItem('active_view', key); } catch(_) {}
      closeDrawer();
    }

    if (viewTabs.length){
      viewTabs.forEach(btn => btn.addEventListener('click', () => activateView(btn.dataset.view || 'main')));
      let savedView = null;
      try { savedView = localStorage.getItem('active_view'); } catch(_) {}
      activateView(savedView && viewsMap[savedView] ? savedView : 'main');
    } else {
      activateView('main');
    }

    if (menuHomeBtn) menuHomeBtn.addEventListener('click', () => activateView('main'));
    if (menuBulkBtn) menuBulkBtn.addEventListener('click', () => activateView('bulk'));
    if (menuReloadBtn) menuReloadBtn.addEventListener('click', () => {
      closeDrawer();
      if (reloadBtn) reloadBtn.click();
    });
    if (refreshSheetsBtn) refreshSheetsBtn.addEventListener('click', () => {
      closeDrawer();
      fillSheets();
    });
    document.addEventListener('keydown', evt => {
      if (evt.key === 'Escape') closeDrawer();
    });

    // حالة
    let localMap = null;
    let lastResult = null;
    let lastProfileIds = [];
    let lastBaseId = '';

    const PERSON_CARD_STORAGE_KEY = 'personCardEnabled';
    let personCardEnabledState = readStoredPersonCardState();
    let personListenersAttached = false;
    let copyMsgResetTimer = null;

    let bulkIds = [];
    let bulkResults = [];
    let bulkBusy = false;
    let bulkAnalyzed = false;
    let bulkExecuted = false;
    let bulkAutoAnalyzeTimer = null;
    let bulkExternalAvailable = false;
    let bulkExternalDefaultName = '';
    let bulkExternalErrorMessage = '';
    let bulkPage = 1;

    let sectionOptions = [];
    let activeSectionKey = '';
    let activeSectionLabel = '';
    let manualSearchTimer = null;
    let skipNextManualDebounce = false;

    const BULK_PAGE_SIZE = 20;
    const SINGLE_DISCOUNT_STORAGE_KEY = 'SINGLE_DISCOUNT_PCT';

    const fmt = n => {
      const x = Number(n);
      return isNaN(x) ? '—' : new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(x);
    };

    const clampDiscountValue = (val) => {
      const normalized = String(val ?? '').replace(/,/g, '.');
      const num = Number(normalized);
      if (!isFinite(num)) return 0;
      return Math.max(0, Math.min(100, num));
    };

    const formatDiscountValue = (val) => {
      const num = Number(val);
      if (!isFinite(num)) return '0';
      const rounded = Math.round(num * 100) / 100;
      return Number(rounded.toFixed(2)).toString();
    };

    const getSingleDiscountPct = () => clampDiscountValue(discountInput?.value);

    function updateMenuDiscountUI(pct, options = {}){
      const safe = clampDiscountValue(pct);
      const formatted = formatDiscountValue(safe);
      if (menuDiscountValue) {
        menuDiscountValue.textContent = safe > 0 ? `${formatted}%` : 'بدون خصم';
      }
      if (menuDiscountInput && !options.skipInputUpdate) {
        menuDiscountInput.value = formatted;
      }
    }

    function setSectionStatus(message){
      if (menuSectionStatus) {
        menuSectionStatus.textContent = message || '';
      }
    }

    function updateHeaderSectionUI(label){
      const safe = String(label || '').trim();
      window.__activeSectionLabel = safe;
      if (headerSectionLabelEl) {
        headerSectionLabelEl.textContent = safe || '—';
      }
      if (sectionChipEl) {
        sectionChipEl.classList.toggle('is-empty', !safe);
        sectionChipEl.title = safe ? `القسم الحالي: ${safe}` : 'لم يتم اختيار قسم';
      }
      if (menuSectionLabelEl) {
        menuSectionLabelEl.textContent = safe || '—';
      }
      if (menuSectionChipEl) {
        menuSectionChipEl.classList.toggle('is-empty', !safe);
        menuSectionChipEl.title = safe ? `القسم الحالي: ${safe}` : 'لم يتم اختيار قسم';
      }
      if (window.__aiClient && typeof window.__aiClient.setActiveSection === 'function') {
        window.__aiClient.setActiveSection(safe);
      }
    }

    function rebuildSectionOptions(){
      if (!menuSectionSelect) return;
      const previous = menuSectionSelect.value;
      menuSectionSelect.innerHTML = '';
      sectionOptions.forEach(section => {
        const opt = document.createElement('option');
        opt.value = section.key || '';
        opt.textContent = section.label || section.key || '';
        menuSectionSelect.appendChild(opt);
      });
      const targetValue = activeSectionKey || previous;
      if (targetValue) {
        menuSectionSelect.value = targetValue;
      }
      if (!menuSectionSelect.value && menuSectionSelect.options.length) {
        menuSectionSelect.selectedIndex = 0;
      }
      if (!activeSectionLabel && sectionOptions.length) {
        const match = sectionOptions.find(s => s.key === menuSectionSelect.value);
        activeSectionLabel = match ? match.label : '';
      }
      menuSectionSelect.disabled = sectionOptions.length <= 1;
    }

    async function fetchSections(options = {}){
      if (!menuSectionSelect) return;
      const keepStatus = options.keepStatus;
      if (!keepStatus) setSectionStatus('⏳ جارٍ تحميل الأقسام…');
      menuSectionSelect.disabled = true;
      try {
        const res = await runServer('getAvailableSections');
        if (!res || res.ok === false) {
          const msg = res?.message || 'فشل تحميل الأقسام.';
          setSectionStatus('⚠️ ' + msg);
          sectionOptions = [];
          activeSectionKey = '';
          activeSectionLabel = '';
          menuSectionSelect.innerHTML = '';
          menuSectionSelect.disabled = true;
          return;
        }
        sectionOptions = Array.isArray(res.sections) ? res.sections : [];
        activeSectionKey = res.activeKey || (sectionOptions[0]?.key || '');
        const match = sectionOptions.find(s => s.key === activeSectionKey);
        activeSectionLabel = res.activeLabel || (match ? match.label : '');
        rebuildSectionOptions();
        updateHeaderSectionUI(activeSectionLabel);
        if (activeSectionLabel) {
          setSectionStatus('✅ القسم الحالي: ' + activeSectionLabel);
        } else {
          setSectionStatus(sectionOptions.length ? 'اختر قسمًا لبدء العمل.' : 'لم يتم إعداد أي قسم.');
        }
      } catch (err) {
        setSectionStatus('⚠️ حدث خطأ أثناء تحميل الأقسام: ' + (err?.message || err));
        sectionOptions = [];
        activeSectionKey = '';
        activeSectionLabel = '';
        menuSectionSelect.innerHTML = '';
        menuSectionSelect.disabled = true;
        updateHeaderSectionUI('');
      }
    }

    async function performSectionSwitch(key){
      const targetKey = String(key || '').trim();
      if (!targetKey) return;
      if (menuSectionSelect) menuSectionSelect.disabled = true;
      setSectionStatus('⏳ جارٍ تحميل بيانات القسم…');
      if (loadNote) loadNote.textContent = '⏳ جارٍ تحميل بيانات القسم…';
      setLoadBtnState(false);
      try {
        const res = await runServer('switchActiveSection', targetKey);
        if (!res || res.ok === false) {
          const msg = res?.message || 'فشل تبديل القسم.';
          setSectionStatus('⚠️ ' + msg);
          if (loadNote) loadNote.textContent = '⚠️ ' + msg;
          return;
        }
        activeSectionKey = res.section?.key || targetKey;
        activeSectionLabel = res.section?.label || (sectionOptions.find(s => s.key === activeSectionKey)?.label || '');
        rebuildSectionOptions();
        updateHeaderSectionUI(activeSectionLabel);
        const baseMsg = res.loadResult?.message || 'تم تحديث بيانات القسم.';
        const serverOk = res.loadResult?.success !== false;
        applyLoadResults(baseMsg, res.snapshot, { serverSuccess: serverOk });
        if (activeSectionLabel) {
          setSectionStatus('✅ القسم الحالي: ' + activeSectionLabel);
        } else {
          setSectionStatus('✅ تم تحديث القسم.');
        }
        if (typeof fillSheets === 'function') {
          fillSheets();
        } else {
          refreshBulkSheets();
        }
      } catch (err) {
        setSectionStatus('⚠️ حدث خطأ أثناء تحديث القسم: ' + (err?.message || err));
      } finally {
        if (menuSectionSelect) {
          menuSectionSelect.disabled = sectionOptions.length <= 1;
          menuSectionSelect.value = activeSectionKey || '';
        }
      }
    }

    function runServer(fnName, ...args) {
      return new Promise((resolve, reject) => {
        try {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(err => reject(err))
            [fnName](...args);
        } catch (err) {
          reject(err);
        }
      });
    }

    const parseBulkIds = txt => {
      return String(txt || '')
        .split(/[\s,\n\r]+/)
        .map(v => v.trim())
        .filter(v => !!v);
    };

    function markJustColored(ids, mode){
      const arr = Array.isArray(ids) ? ids : [ids];
      const flavor = mode === 'agent' ? 'agent' : (mode === 'admin' ? 'admin' : 'both');
      arr.forEach(id => {
        const key = String(id || '').trim();
        if (!key) return;
        if (Object.prototype.hasOwnProperty.call(justColored, key)) {
          const idx = justColoredOrder.indexOf(key);
          if (idx >= 0) justColoredOrder.splice(idx, 1);
        }
        justColored[key] = flavor;
        justColoredOrder.push(key);
        const overflow = justColoredOrder.length - 400;
        if (overflow > 0) {
          const removed = justColoredOrder.splice(0, overflow);
          removed.forEach(k => { delete justColored[k]; });
        }
      });
    }

    function updateBulkPaginationUI(total, startIndex, endIndex, totalPages){
      if (!bulkPagination) return;
      if (!total){
        bulkPagination.style.display = 'none';
        if (bulkPageInfo) bulkPageInfo.textContent = '';
        if (bulkPrevBtn) bulkPrevBtn.disabled = true;
        if (bulkNextBtn) bulkNextBtn.disabled = true;
        return;
      }
      const pages = Math.max(1, totalPages || 1);
      const hasPages = total > BULK_PAGE_SIZE;
      bulkPagination.style.display = hasPages ? 'flex' : 'none';
      const start = Math.min(total, Math.max(1, startIndex + 1));
      const end = Math.min(total, Math.max(start, endIndex));
      if (bulkPageInfo){
        if (hasPages){
          bulkPageInfo.textContent = `عرض ${start} - ${end} من ${total} (صفحة ${bulkPage}/${pages})`;
        } else {
          bulkPageInfo.textContent = `عرض ${total} نتيجة`;
        }
      }
      if (bulkPrevBtn) bulkPrevBtn.disabled = !hasPages || bulkPage <= 1;
      if (bulkNextBtn) bulkNextBtn.disabled = !hasPages || bulkPage >= pages;
    }

    function setBulkBusy(flag){
      bulkBusy = !!flag;
      const disabled = bulkBusy;
      [bulkPasteBtn, bulkExecuteBtn,
        bulkScope, bulkTargetSheet, bulkRefreshSheets, bulkNewSheet, bulkCreateSheet,
        bulkExternalTargetSheet, bulkExternalRefreshSheets, bulkExternalNewSheet, bulkExternalCreateSheet,
        bulkAdminColor, bulkWithdrawColor, bulkDiscount, bulkIdsInput]
        .forEach(el => { if (el) el.disabled = disabled; });
    }

    function updateBulkProgress(done, total, label){
      const max = Math.max(0, Number(total) || 0);
      const cur = Math.min(max, Math.max(0, Number(done) || 0));
      const pct = max === 0 ? 0 : Math.round((cur / max) * 100);
      if (bulkProgressBar) bulkProgressBar.style.width = `${pct}%`;
      if (bulkProgressLabel) bulkProgressLabel.textContent = `${pct}%`;
      if (bulkSummaryText) bulkSummaryText.textContent = label || '';
    }

    function updateBulkButtons(){
      const hasIds = bulkIds.length > 0;
      const hasCopyableResults = bulkResults.length > 0;
      if (bulkPasteBtn) bulkPasteBtn.disabled = bulkBusy;
      if (bulkExecuteBtn) bulkExecuteBtn.disabled = !hasIds || !bulkAnalyzed || bulkBusy;
      if (bulkCopyAllBtn) bulkCopyAllBtn.disabled = !hasCopyableResults;
      if (bulkCopySalaryBtn) bulkCopySalaryBtn.disabled = !hasCopyableResults;
    }

    function renderBulkResults(){
      while (bulkResultsBody && bulkResultsBody.firstChild) {
        bulkResultsBody.removeChild(bulkResultsBody.firstChild);
      }
      if (!bulkResults.length) {
        if (bulkEmptyState) bulkEmptyState.style.display = '';
        updateBulkPaginationUI(0, 0, 0, 0);
        registerBulkDisplay([]);
        return;
      }
      if (bulkEmptyState) bulkEmptyState.style.display = 'none';

      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      const total = bulkResults.length;
      const totalPages = Math.max(1, Math.ceil(total / BULK_PAGE_SIZE));
      if (bulkPage > totalPages) bulkPage = totalPages;
      if (bulkPage < 1) bulkPage = 1;
      const startIndex = (bulkPage - 1) * BULK_PAGE_SIZE;
      const endIndex = Math.min(total, startIndex + BULK_PAGE_SIZE);
      const visible = bulkResults.slice(startIndex, endIndex);

      visible.forEach((res, idx) => {
        const tr = document.createElement('tr');
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const salaryBase = Number(baseSalaryRaw || 0);
        const absoluteIndex = startIndex + idx;
        const cells = [
          { text: String(absoluteIndex + 1) },
          { text: res.id || '' },
          { text: fmt(salaryBase) },
          { html: res.duplicateLabel ? `${res.state || ''} <span class="bulk-chip">${res.duplicateLabel}</span>` : (res.state || '') },
          { text: res.colored ? 'نعم' : 'لا' }
        ];
        cells.forEach((cell, i) => {
          const td = document.createElement('td');
          if (i === 3) td.classList.add('state-cell');
          if (cell.html) td.innerHTML = cell.html;
          else td.textContent = cell.text;
          tr.appendChild(td);
        });
        if (bulkResultsBody) bulkResultsBody.appendChild(tr);
      });
      updateBulkPaginationUI(total, startIndex, endIndex, totalPages);
      registerBulkDisplay(visible);
    }
    function computeBulkDisplayInfo(res){
      if (!res) return null;
      const key = String(res.id || '').trim();
      if (!key) return null;
      const node = (localMap && key && Object.prototype.hasOwnProperty.call(localMap, key)) ? localMap[key] : null;
      const ctx = resolveDuplicateContext(res, node);
      let totalRows = ctx.agentRows + ctx.adminRows;
      if (!totalRows && (ctx.agentPresent || ctx.adminPresent)) {
        totalRows = (ctx.agentPresent ? 1 : 0) + (ctx.adminPresent ? 1 : 0);
      }
      let coloredRows = 0;
      if (ctx.agentColored && ctx.agentRows) coloredRows += ctx.agentRows;
      if (ctx.adminColored && ctx.adminRows) coloredRows += ctx.adminRows;
      if (coloredRows > totalRows) coloredRows = totalRows;
      if (!totalRows && coloredRows) totalRows = coloredRows;
      return { id: key, rows: Math.max(0, totalRows), coloredRows: Math.max(0, Math.min(totalRows, coloredRows)) };
    }
    function registerBulkDisplay(rows){
      clearLiveSource(LIVE_SOURCE_BULK, { skipRecalc: true });
      if (Array.isArray(rows)) {
        rows.forEach(res => {
          const info = computeBulkDisplayInfo(res);
          if (!info) return;
          if (info.rows > 0) {
            addLiveDisplayEntry(LIVE_SOURCE_BULK, info.id, info.rows, info.coloredRows, { skipRecalc: true });
          }
        });
      }
      recomputeLiveTotals();
    }

    function updateBulkCounters(){
      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      let total = bulkIds.length;
      let colored = 0;
      let salarySum = 0;
      bulkResults.forEach(res => {
        if (res.colored) colored++;
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const val = Number(baseSalaryRaw || 0);
        salarySum += isNaN(val) ? 0 : val;
      });
      const uncolored = Math.max(0, total - colored);
      if (bulkCountTotal) bulkCountTotal.textContent = total;
      if (bulkCountColored) bulkCountColored.textContent = colored;
      if (bulkCountUncolored) bulkCountUncolored.textContent = uncolored;
      if (bulkSalarySum) bulkSalarySum.textContent = fmt(salarySum);
    }

    function cancelBulkAutoAnalyze(){
      if (bulkAutoAnalyzeTimer) {
        clearTimeout(bulkAutoAnalyzeTimer);
        bulkAutoAnalyzeTimer = null;
      }
    }

    function scheduleBulkAutoAnalyze(reason){
      if (!bulkIds.length) return;
      cancelBulkAutoAnalyze();
      const attempt = () => {
        if (bulkBusy) {
          bulkAutoAnalyzeTimer = setTimeout(attempt, 180);
          return;
        }
        bulkAutoAnalyzeTimer = null;
        runBulkAnalyze({ skipHandleChange: true, reason: reason || 'auto' });
      };
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ التحليل التلقائي…';
      bulkAutoAnalyzeTimer = setTimeout(attempt, 180);
    }

    function handleBulkIdsChange(options = {}){
      const auto = options.auto !== false;
      bulkIds = parseBulkIds(bulkIdsInput?.value || '');
      bulkPage = 1;
      cancelBulkAutoAnalyze();
      if (!bulkIds.length) {
        bulkResults = [];
        bulkAnalyzed = false;
        bulkExecuted = false;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(0, 1, '');
        if (bulkEmptyState) bulkEmptyState.style.display = '';
        if (bulkStatusText) bulkStatusText.textContent = 'ألصق IDs وسيتم التحليل تلقائيًا.';
        return;
      }
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, bulkIds.length, '');
      if (bulkEmptyState) bulkEmptyState.style.display = 'none';
      if (bulkStatusText) bulkStatusText.textContent = `تمت إضافة ${bulkIds.length} ID — جارٍ التحليل…`;
      if (auto) scheduleBulkAutoAnalyze(options.reason || 'ids-change');
    }

    async function refreshBulkSheets(preserveLocal, preserveExternal){
      try {
        const res = await runServer('getBulkSheetLists');
        if (!res || res.ok === false) {
          if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${res?.message || 'فشل تحميل الأوراق'}`;
          return;
        }

        const localList = Array.isArray(res.localSheets) ? res.localSheets : [];
        if (bulkTargetSheet) {
          const current = preserveLocal || bulkTargetSheet.value;
          bulkTargetSheet.innerHTML = '';
          localList.forEach(name => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            bulkTargetSheet.appendChild(opt);
          });
          if (current && localList.includes(current)) {
            bulkTargetSheet.value = current;
          } else if (res.localDefault && localList.includes(res.localDefault)) {
            bulkTargetSheet.value = res.localDefault;
          }
        }

        const externalList = Array.isArray(res.externalSheets) ? res.externalSheets : [];
        bulkExternalAvailable = !!res.externalEnabled;
        bulkExternalDefaultName = String(res.externalDefault || '');
        bulkExternalErrorMessage = String(res.externalError || '');
        if (bulkExternalTargetSheet) {
          const currentExt = preserveExternal || bulkExternalTargetSheet.value;
          bulkExternalTargetSheet.innerHTML = '';
          externalList.forEach(name => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            bulkExternalTargetSheet.appendChild(opt);
          });
          if (currentExt && externalList.includes(currentExt)) {
            bulkExternalTargetSheet.value = currentExt;
          } else if (bulkExternalDefaultName && externalList.includes(bulkExternalDefaultName)) {
            bulkExternalTargetSheet.value = bulkExternalDefaultName;
          } else if (externalList.length) {
            bulkExternalTargetSheet.value = externalList[0];
          }
        }

        if (bulkExternalFileLabel) {
          bulkExternalFileLabel.textContent = res.externalFileName ? `(${res.externalFileName})` : '';
        }

        applyBulkScopeUI();
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
      }
    }

    async function createBulkSheet(){
      const name = (bulkNewSheet?.value || '').trim();
      if (!name) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ اكتب اسم ورقة جديدة أولًا.';
        return;
      }
      const btn = bulkCreateSheet;
      if (btn) btn.disabled = true;
      try {
        const res = await runServer('createSheetIfMissing', name);
        await refreshBulkSheets(res?.name || name, bulkExternalTargetSheet?.value);
        bulkNewSheet.value = '';
        if (bulkStatusText) bulkStatusText.textContent = `✅ تم تجهيز الورقة: ${res?.name || name}`;
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function createExternalSheet(){
      const name = (bulkExternalNewSheet?.value || '').trim();
      if (!name) {
        if (bulkExternalNote) bulkExternalNote.textContent = '⚠️ اكتب اسم ورقة جديدة أولًا.';
        return;
      }
      const btn = bulkExternalCreateSheet;
      if (btn) btn.disabled = true;
      try {
        const res = await runServer('createExternalSheetIfMissing', name);
        await refreshBulkSheets(bulkTargetSheet?.value, res?.name || name);
        if (bulkExternalNewSheet) bulkExternalNewSheet.value = '';
        if (bulkExternalNote) bulkExternalNote.textContent = `✅ تم تجهيز الورقة الخارجية: ${res?.name || name}`;
      } catch (err) {
        if (bulkExternalNote) bulkExternalNote.textContent = `خطأ: ${err?.message || err}`;
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function applyBulkScopeUI(){
      const scope = bulkScope?.value || 'both';
      if (bulkTargetSheet) {
        bulkTargetSheet.style.display = '';
        const parentRow = bulkTargetSheet.closest('.bulk-target-row');
        if (parentRow) parentRow.style.display = '';
      }
      if (bulkNewSheet) {
        bulkNewSheet.style.display = '';
        const newRow = bulkNewSheet.closest('.bulk-inline');
        if (newRow) newRow.style.display = '';
      }
      if (bulkCreateSheet) {
        bulkCreateSheet.style.display = '';
      }
      if (bulkRefreshSheets) {
        const shouldHideRefresh = scope === 'all';
        bulkRefreshSheets.style.display = shouldHideRefresh ? 'none' : '';
      }
      const showExternalUI = false; // خيار "الكل" لا يعرض عناصر إضافية
      if (bulkExternalWrap) {
        bulkExternalWrap.style.display = showExternalUI ? '' : 'none';
      }
      if (bulkExternalNote) {
        if (showExternalUI && !bulkExternalAvailable) {
          bulkExternalNote.textContent = bulkExternalErrorMessage || '⚠️ أضف رابط ملف الإدارة الخارجي في Settings (الأعمدة I-L).';
        } else if (showExternalUI && bulkExternalErrorMessage) {
          bulkExternalNote.textContent = bulkExternalErrorMessage;
        } else {
          bulkExternalNote.textContent = '';
        }
      }
      if (showExternalUI && bulkExternalAvailable && bulkExternalTargetSheet && !bulkExternalTargetSheet.value && bulkExternalDefaultName) {
        const opts = Array.from(bulkExternalTargetSheet.options || []);
        const match = opts.find(o => o.value === bulkExternalDefaultName);
        if (match) bulkExternalTargetSheet.value = bulkExternalDefaultName;
      }
    }

    async function runBulkAnalyze(options = {}){
      if (bulkBusy) return;
      if (!options.skipHandleChange) handleBulkIdsChange({ auto: false, reason: options.reason });
      if (!bulkIds.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ أضف IDs أولًا.';
        return;
      }
      cancelBulkAutoAnalyze();
      const discountVal = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const scope = bulkScope?.value || 'both';
      setBulkBusy(true);
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, bulkIds.length, 'جارٍ التحليل…');
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ التحليل…';

      const chunkSize = bulkIds.length > 400 ? 150 : 120;
      let processed = 0;
      const aggregated = [];

      try {
        for (let i = 0; i < bulkIds.length; i += chunkSize) {
          const part = bulkIds.slice(i, i + chunkSize);
          const res = await runServer('bulkSearchExact', part, discountVal, scope);
          if (!res || !res.ok) {
            throw new Error(res?.message || 'فشل التحليل');
          }
          const arr = Array.isArray(res.results) ? res.results : [];
          aggregated.push(...arr);
          processed += part.length;
          updateBulkProgress(processed, bulkIds.length, `تم تحليل ${Math.min(processed, bulkIds.length)} من ${bulkIds.length}`);
        }
        bulkPage = 1;
        bulkResults = aggregated;
        bulkAnalyzed = true;
        bulkExecuted = false;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(bulkIds.length, bulkIds.length, 'تم التحليل');
        if (bulkStatusText) bulkStatusText.textContent = `✅ تم تحليل ${bulkResults.length} ID.`;
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
        updateBulkProgress(processed, bulkIds.length, 'توقف بسبب خطأ');
      } finally {
        setBulkBusy(false);
        updateBulkButtons();
      }
    }

    async function runBulkExecute(){
      if (bulkBusy) {
        if (bulkStatusText) bulkStatusText.textContent = '⏳ هناك عملية جارية، انتظر قليلًا.';
        return;
      }
      if (!bulkIds.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ لا يوجد IDs.';
        return;
      }
      if (!bulkAnalyzed) {
        await runBulkAnalyze({ skipHandleChange: true, reason: 'execute' });
        if (!bulkAnalyzed) {
          if (bulkStatusText) bulkStatusText.textContent = '⚠️ تعذّر التحليل قبل التنفيذ.';
          return;
        }
      }

      const ids = bulkIds.slice();
      if (!ids.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ لا يوجد IDs.';
        return;
      }

      const scope = bulkScope?.value || 'both';
      const targetMode = scope === 'agent' ? 'agent' : 'both';
      const sheetName = bulkTargetSheet?.value || '';
      if (targetMode !== 'agent' && !sheetName) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ اختر ورقة الهدف.';
        return;
      }

      let externalSheetName = '';
      if (scope === 'all') {
        if (!bulkExternalAvailable) {
          if (bulkExternalNote) bulkExternalNote.textContent = bulkExternalErrorMessage || '⚠️ أضف ملف الإدارة الخارجي أولًا.';
        }
        externalSheetName = bulkExternalTargetSheet?.value || '';
      }

      const config = {
        sheetName: sheetName,
        color: bulkWithdrawColor?.value || '#9629ff',
        adminColor: bulkAdminColor?.value || '#fde68a',
        withdrawColor: bulkWithdrawColor?.value || '#9629ff',
        targetMode: targetMode,
        scope: scope,
        externalSheetName: externalSheetName
      };

      cancelBulkAutoAnalyze();
      setBulkBusy(true);
      bulkExecuted = false;
      updateBulkButtons();
      updateBulkProgress(0, ids.length, 'جارٍ التنفيذ…');
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ التنفيذ…';

      const chunkSize = ids.length > 300 ? 80 : 60;
      let processed = 0;
      let copiedTotal = 0;
      let skippedTotal = 0;
      let copiedExternalTotal = 0;
      const coloredSet = new Set();

      try {
        for (let i = 0; i < ids.length; i += chunkSize) {
          const part = ids.slice(i, i + chunkSize);
          const res = await runServer('bulkExecuteExact', part, config);
          if (!res || !res.ok) {
            throw new Error(res?.message || 'فشل التنفيذ');
          }
          const newlyColoredRaw = Array.isArray(res.coloredIds) ? res.coloredIds : [];
          const normalizedColored = [];
          newlyColoredRaw.forEach(idVal => {
            const key = String(idVal || '').trim();
            if (!key) return;
            normalizedColored.push(key);
            coloredSet.add(key);
          });
          if (normalizedColored.length) {
            const delta = computeInstantColoringDelta(normalizedColored, { mode: targetMode });
            if (delta.coloredDelta || delta.uncoloredDelta) {
              applyInstantCounterDelta(delta.coloredDelta, delta.uncoloredDelta);
            }
            markJustColored(normalizedColored, targetMode);
            if (localMap) {
              normalizedColored.forEach(key => {
                const node = localMap[key];
                if (!node) return;
                node.aCol = true;
                if (targetMode === 'both') {
                  node.dCol = true;
                  node.inAdmin = true;
                  if (!node.adminRowsCount || node.adminRowsCount < 1) node.adminRowsCount = 1;
                }
              });
            }
            if (lastResult) {
              const lastIdNormalized = String(lastResult.id || '').trim();
              if (lastIdNormalized && normalizedColored.includes(lastIdNormalized)) {
                updateLastResultDuplicateState(lastIdNormalized, targetMode);
              }
            }
          }
          copiedTotal += Number(res.copied || 0);
          skippedTotal += Number(res.skipped || 0);
          copiedExternalTotal += Number(res.copiedExternal || 0);
          processed += part.length;
          updateBulkProgress(processed, ids.length, `تمت معالجة ${Math.min(processed, ids.length)} من ${ids.length}`);
        }

        if (coloredSet.size) {
          bulkResults = bulkResults.map(res => {
            if (!coloredSet.has(res.id)) return res;
            const next = Object.assign({}, res, {
              colored: true,
              coloredAgent: true
            });
            if (targetMode === 'both') {
              next.coloredAdmin = true;
            }
            return next;
          });
        }
        if (coloredSet.size) {
          markJustColored(Array.from(coloredSet), targetMode);
        }
        bulkExecuted = true;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(ids.length, ids.length, 'تم التنفيذ');
        const parts = ['✅ تم التنفيذ'];
        if (coloredSet.size) parts.push(`تلوين ${coloredSet.size}`);
        if (copiedTotal) parts.push(`نسخ ${copiedTotal}`);
        if (copiedExternalTotal) parts.push(`خارجي ${copiedExternalTotal}`);
        if (skippedTotal) parts.push(`تخطي ${skippedTotal}`);
        if (bulkStatusText) bulkStatusText.textContent = parts.join(' • ');
        refreshCountsLive();
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `خطأ: ${err?.message || err}`;
        updateBulkProgress(processed, ids.length, 'توقف بسبب خطأ');
      } finally {
        setBulkBusy(false);
        updateBulkButtons();
      }
    }

    async function copyBulk(mode){
      if (!bulkResults.length) {
        if (bulkStatusText) bulkStatusText.textContent = '⚠️ نفّذ التحليل والتطبيق أولًا.';
        return;
      }
      const copyingDuringRun = bulkBusy || !bulkExecuted;
      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      const rows = bulkResults.map(res => {
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const salaryVal = Number(baseSalaryRaw || 0);
        const salaryStr = salaryVal.toFixed(2);
        if (mode === 'salary') return salaryStr;
        const stateText = res.state || '';
        const duplicateText = res.duplicateLabel ? `${stateText ? ' - ' : ''}${res.duplicateLabel}` : '';
        return [res.id || '', salaryStr, `${stateText}${duplicateText}`.trim()].join('\t');
      });
      const text = rows.join('\n');
      const successMessage = copyingDuringRun
        ? 'ℹ️ تم النسخ من آخر نتائج مكتملة (لا تزال العملية الحالية جارية).'
        : '✅ تم النسخ إلى الحافظة.';
      const fallbackMessage = copyingDuringRun
        ? 'ℹ️ تم النسخ (وضع احتياطي) من آخر نتائج مكتملة أثناء استمرار العملية الحالية.'
        : '✅ تم النسخ (وضع احتياطي).';
      try {
        await navigator.clipboard.writeText(text);
        if (bulkStatusText) {
          bulkStatusText.textContent = successMessage;
        }
      } catch (err) {
        const helper = document.createElement('textarea');
        helper.style.position = 'fixed';
        helper.style.opacity = '0';
        helper.value = text;
        document.body.appendChild(helper);
        helper.focus();
        helper.select();
        try {
          document.execCommand('copy');
          if (bulkStatusText) bulkStatusText.textContent = fallbackMessage;
        } catch (e2) {
          if (bulkStatusText) bulkStatusText.textContent = `⚠️ انسخ يدويًا: ${e2?.message || e2}`;
        }
        document.body.removeChild(helper);
      }
    }

    async function handleBulkPaste(){
      try {
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()) {
          if (bulkIdsInput) bulkIdsInput.value = txt.trim();
          handleBulkIdsChange({ auto: true, reason: 'paste' });
          return;
        }
      } catch (_) {}
      const fallback = prompt('ألصق IDs يدويًا:');
      if (fallback && bulkIdsInput) {
        bulkIdsInput.value = fallback;
        handleBulkIdsChange({ auto: true, reason: 'paste' });
      }
    }

    /******** قسم البيانات (إخفاء/تعطيل) ********/
    function readStoredPersonCardState(){
      try {
        const stored = localStorage.getItem(PERSON_CARD_STORAGE_KEY);
        if (stored === null) {
          const legacy = localStorage.getItem('disable_person_feature');
          if (legacy === '1') return false;
          return true;
        }
        return stored !== 'false';
      } catch (_) {
        return true;
      }
    }

    function isPersonFeatureDisabled(){
      return !personCardEnabledState;
    }

    function isPersonHidden(){
      return localStorage.getItem('hide_person_section') === '1';
    }

    function resetCopyMsgLabel(){
      if (copyMsgBtn) {
        copyMsgBtn.textContent = 'نسخ الرسالة';
      }
      if (copyMsgResetTimer){
        clearTimeout(copyMsgResetTimer);
        copyMsgResetTimer = null;
      }
    }

    function cancelPersonCardOperations(){
      lastProfileIds = [];
      personMsg.value = '';
      personNote.textContent = '—';
      resetCopyMsgLabel();
    }

    function updatePersonToggleUI(){
      if (personCardToggleBtn){
        personCardToggleBtn.textContent = personCardEnabledState ? 'إيقاف بيانات صاحب الـID' : 'تفعيل بيانات صاحب الـID';
      }
      if (qtDisablePerson){
        qtDisablePerson.checked = !personCardEnabledState;
      }
    }

    function attachPersonCardListeners(){
      if (personListenersAttached) return;
      if (copyMsgBtn) copyMsgBtn.addEventListener('click', handleCopyMsgClick);
      if (colorAllBtn) colorAllBtn.addEventListener('click', handleColorAllClick);
      personListenersAttached = true;
    }

    function detachPersonCardListeners(){
      if (!personListenersAttached) return;
      if (copyMsgBtn) copyMsgBtn.removeEventListener('click', handleCopyMsgClick);
      if (colorAllBtn) colorAllBtn.removeEventListener('click', handleColorAllClick);
      personListenersAttached = false;
    }

    function applyPersonVisibility(){
      updatePersonToggleUI();
      const hidden = isPersonHidden() || isPersonFeatureDisabled();
      if (personCardEl) personCardEl.style.display = hidden ? 'none' : '';
      if (isPersonFeatureDisabled()){
        detachPersonCardListeners();
        cancelPersonCardOperations();
        if (copyMsgBtn) copyMsgBtn.disabled = true;
        if (colorAllBtn) colorAllBtn.disabled = true;
      } else {
        attachPersonCardListeners();
        if (copyMsgBtn) copyMsgBtn.disabled = false;
        if (colorAllBtn) colorAllBtn.disabled = false;
      }
      if (qtHidePerson){
        qtHidePerson.textContent = hidden ? '👀 إظهار قسم البيانات' : '🙈 إخفاء قسم البيانات';
      }
    }

    function setPersonCardEnabled(enabled){
      const next = !!enabled;
      if (next === personCardEnabledState) return;
      personCardEnabledState = next;
      try { localStorage.setItem(PERSON_CARD_STORAGE_KEY, next ? 'true' : 'false'); } catch (_) {}
      updatePersonToggleUI();
      applyPersonVisibility();
      if (personCardEnabledState && lastBaseId){
        renderPersonCard(lastBaseId);
      }
    }

    async function handleCopyMsgClick(){
      if (isPersonFeatureDisabled()) return;
      const text = personMsg.value || '';
      try {
        await navigator.clipboard.writeText(text);
        if (copyMsgBtn) {
          copyMsgBtn.textContent = '✓ نُسخت';
          copyMsgResetTimer = setTimeout(resetCopyMsgLabel, 900);
        }
      } catch (_) {
        if (!personMsg) return;
        personMsg.select();
        document.execCommand('copy');
        if (copyMsgBtn) {
          copyMsgBtn.textContent = '✓ نُسخت';
          copyMsgResetTimer = setTimeout(resetCopyMsgLabel, 900);
        }
      }
    }

    function handleColorAllClick(){
      if (isPersonFeatureDisabled()) { if (personNote) personNote.textContent='الميزة معطّلة.'; return; }
      if (!lastProfileIds.length){ if (personNote) personNote.textContent='لا IDs لتلوينها.'; return; }
      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode==='both' && !sheet){ advNote.textContent='اختر ورقة الهدف أولاً.'; return; }

      if (personNote) personNote.textContent = 'جارٍ التلوين...';
      let done=0, fail=0;
      const coloredSetNow = new Set();
      const runOne = (uid)=> new Promise((resolve)=>{
        const normalized = String(uid || '').trim();
        google.script.run
          .withSuccessHandler(_=>{ done++; if (normalized) coloredSetNow.add(normalized); resolve(true); })
          .withFailureHandler(_=>{ fail++; resolve(false); })
          .applyAdvancedAction(uid, sheet, adminColor.value, withdrawColor.value, targetMode, undefined, activeSectionKey || '');
      });
      Promise.all(lastProfileIds.map(runOne)).then(()=>{
        if (isPersonFeatureDisabled()) { cancelPersonCardOperations(); return; }
        if(personNote) personNote.textContent = `تم — ملوّن: ${done}, فشل: ${fail}`;
        flash(personCardEl,'flash-green');
        const coloredIds = Array.from(coloredSetNow);
        if (coloredIds.length) {
          const delta = computeInstantColoringDelta(coloredIds, { mode: targetMode });
          if (delta.coloredDelta || delta.uncoloredDelta) {
            applyInstantCounterDelta(delta.coloredDelta, delta.uncoloredDelta);
          }
          if(localMap){
            coloredIds.forEach(uid=>{
              const node = localMap[uid];
              if(!node) return;
              node.aCol = true;
              if (targetMode==='both') {
                node.dCol = true;
                node.inAdmin = true;
                if (!node.adminRowsCount || node.adminRowsCount < 1) node.adminRowsCount = 1;
              }
            });
          }
          markJustColored(coloredIds, targetMode);
          if (lastResult) {
            const lastIdNormalized = String(lastResult.id || '').trim();
            if (coloredSetNow.has(lastIdNormalized)) {
              updateLastResultDuplicateState(lastIdNormalized, targetMode);
            }
          }
        }
        refreshCountsLive();
      });
    }

    if (qtHidePerson){
      qtHidePerson.addEventListener('click', ()=>{
        const cur = isPersonHidden();
        localStorage.setItem('hide_person_section', cur ? '0':'1');
        applyPersonVisibility();
      });
    }

    if (qtDisablePerson){
      qtDisablePerson.addEventListener('change', ()=>{
        const enable = !qtDisablePerson.checked;
        setPersonCardEnabled(enable);
      });
    }

    if (personCardToggleBtn){
      personCardToggleBtn.addEventListener('click', ()=>{
        setPersonCardEnabled(!personCardEnabledState);
      });
    }

    applyPersonVisibility();

    /******** أدوات مساعدة UI ********/
    function flash(el, cls){
      el.classList.remove('flash-blue','flash-green');
      void el.offsetWidth;
      el.classList.add(cls);
    }
    function saveLastId(id){
      try { localStorage.setItem('last_id', id); } catch(_){}
      lastIdText.textContent = id || '';
      lastIdPill.style.display = id ? 'inline-flex' : 'none';
    }
    function loadLastId(){
      let v = '';
      try { v = localStorage.getItem('last_id') || ''; } catch(_){}
      if (v){ lastIdText.textContent = v; lastIdPill.style.display = 'inline-flex'; }
      else { lastIdPill.style.display = 'none'; }
    }
    lastIdPill.addEventListener('click', ()=>{
      const v = lastIdText.textContent || '';
      if (!v) return;
      idInput.value = v;
      clearTimeout(manualSearchTimer);
      manualSearchTimer = null;
      doSearch({ manual:true });
    });

    /******** تحميل الأوراق ********/
    function fillSheets(){
      if (advNote) advNote.textContent = '⏳ جارٍ تحديث قائمة الأوراق…';
      google.script.run
        .withSuccessHandler(arr=>{
          const list = Array.isArray(arr) ? arr : [];
          sheetSelect.innerHTML = '';
          list.forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          if (bulkTargetSheet) {
            const keep = bulkTargetSheet.value;
            refreshBulkSheets(keep, bulkExternalTargetSheet?.value);
          }
          if (advNote) advNote.textContent = '✅ تم تحديث قائمة الأوراق';
        })
        .withFailureHandler(err=> advNote.textContent = 'خطأ: '+(err?.message||''))
        .getAdminSheets();
    }

    /******** تحميل البيانات ********/
    function setLoadBtnState(ok){
      if (ok===true){ reloadBtn.classList.remove('btn-red'); reloadBtn.classList.add('btn-green'); }
      else if (ok===false){ reloadBtn.classList.remove('btn-green'); reloadBtn.classList.add('btn-red'); }
    }

    function applyLoadResults(baseMessage, snapshot, options = {}){
      if (!loadNote) return;
      const baseMsg = baseMessage || 'تم التحميل من السيرفر.';
      const serverOk = options.serverSuccess !== false;
      if (!snapshot || snapshot.ok === false) {
        const extra = snapshot && snapshot.message ? snapshot.message : '';
        loadNote.textContent = extra
          ? `${baseMsg} | ⚠️ فشل المحلي: ${extra}`
          : `${baseMsg} | ⚠️ فشل التحميل المحلي.`;
        setLoadBtnState(false);
        return;
      }
      localMap = snapshot.map || null;
      const st = snapshot.stats || {};
      loadNote.textContent = `${baseMsg} | محلي: ${st.agentRows||0} صف / ${st.agentUnique||0} ID.`;
      setLoadBtnState(serverOk);
      refreshCountsLive();
    }
    function loadData(){
      setLoadBtnState(false);
      loadNote.textContent = '⏳ جارٍ تحميل البيانات…';
      google.script.run
        .withSuccessHandler(srv=>{
          const baseMsg = srv?.message || 'تم التحميل من السيرفر.';
          google.script.run
            .withSuccessHandler(res=>{
              const serverOk = srv?.success !== false;
              applyLoadResults(baseMsg, res, { serverSuccess: serverOk });
            })
            .withFailureHandler(err=>{
              loadNote.textContent = baseMsg + ' | ⚠️ خطأ بالمحلي: ' + (err?.message||'');
              setLoadBtnState(false);
            })
            .getSearchSnapshotLight(activeSectionKey || '');
        })
        .withFailureHandler(err=>{
          loadNote.textContent = '⚠️ خطأ بالتحميل: ' + (err?.message||'');
          setLoadBtnState(false);
        })
        .loadDataIntoCache(activeSectionKey || '');
    }
    reloadBtn.addEventListener('click', loadData);
    createSheetBtn.addEventListener('click', ()=>{
  const name = (newSheetName.value || '').trim();
  if (!name){ advNote.textContent = '⚠️ اكتب اسم ورقة جديدة'; return; }
  google.script.run
    .withSuccessHandler(msg=>{
      advNote.textContent = msg || 'تم الإنشاء ✅';
      // حدّث القائمة وحدّد الورقة الجديدة
      google.script.run
        .withSuccessHandler(arr=>{
          sheetSelect.innerHTML = '';
          (arr||[]).forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          // حاول اختيار الورقة التي أنشأناها
          const opt = Array.from(sheetSelect.options).find(o => o.value === name);
          if (opt) sheetSelect.value = name;
          newSheetName.value = '';
        })
        .getAdminSheets();
    })
    .withFailureHandler(err=>{
      advNote.textContent = 'خطأ: ' + (err?.message || '');
    })
    .createAdminSheet(name);
    });

    if (bulkIdsInput) bulkIdsInput.addEventListener('input', () => handleBulkIdsChange({ reason: 'typing' }));
    if (bulkPasteBtn) bulkPasteBtn.addEventListener('click', handleBulkPaste);
    if (bulkExecuteBtn) bulkExecuteBtn.addEventListener('click', runBulkExecute);
    if (bulkCopyAllBtn) bulkCopyAllBtn.addEventListener('click', () => copyBulk('all'));
    if (bulkCopySalaryBtn) bulkCopySalaryBtn.addEventListener('click', () => copyBulk('salary'));
    if (bulkPrevBtn) bulkPrevBtn.addEventListener('click', () => {
      if (bulkPage > 1) {
        bulkPage--;
        renderBulkResults();
      }
    });
    if (bulkNextBtn) bulkNextBtn.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil((bulkResults.length || 0) / BULK_PAGE_SIZE));
      if (bulkPage < totalPages) {
        bulkPage++;
        renderBulkResults();
      }
    });
    if (bulkDiscount) bulkDiscount.addEventListener('input', () => {
      if (!bulkIds.length) return;
      bulkAnalyzed = false;
      bulkExecuted = false;
      updateBulkButtons();
      if (bulkStatusText) bulkStatusText.textContent = '⏳ جارٍ تحديث النتائج بعد تعديل الخصم…';
      scheduleBulkAutoAnalyze('discount-change');
    });
    if (bulkRefreshSheets) bulkRefreshSheets.addEventListener('click', () => refreshBulkSheets(bulkTargetSheet?.value, bulkExternalTargetSheet?.value));
    if (bulkExternalRefreshSheets) bulkExternalRefreshSheets.addEventListener('click', () => refreshBulkSheets(bulkTargetSheet?.value, bulkExternalTargetSheet?.value));
    if (bulkCreateSheet) bulkCreateSheet.addEventListener('click', createBulkSheet);
    if (bulkExternalCreateSheet) bulkExternalCreateSheet.addEventListener('click', createExternalSheet);
    if (bulkScope) bulkScope.addEventListener('change', () => {
      bulkAnalyzed = false;
      bulkExecuted = false;
      applyBulkScopeUI();
      updateBulkButtons();
      if (bulkIds.length) scheduleBulkAutoAnalyze('scope-change');
    });
    refreshBulkSheets();
    applyBulkScopeUI();
    updateBulkButtons();

    /******** لصق ثم بحث / إنتر ********/
    pasteSearchBtn.addEventListener('click', async ()=>{
      pasteHint.textContent = '';
      try{
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()){
          idInput.value = txt.trim();
          clearTimeout(manualSearchTimer);
          manualSearchTimer = null;
          doSearch({ manual:true });
          return;
        }
      }catch(_){}
      idInput.focus(); idInput.select();
      pasteHint.textContent = 'الصق يدويًا وسيبدأ البحث تلقائيًا…';
      const once = ()=>{
        pasteHint.textContent = '';
        idInput.removeEventListener('input', once);
        skipNextManualDebounce = true;
        setTimeout(()=>{
          doSearch({ manual:true });
          skipNextManualDebounce = false;
        }, 0);
      };
      idInput.addEventListener('input', once, { once:true });
    });
    idInput.addEventListener('paste', ()=>{
      skipNextManualDebounce = true;
      setTimeout(()=>{
        clearTimeout(manualSearchTimer);
        manualSearchTimer = null;
        doSearch({ manual:true });
        skipNextManualDebounce = false;
      }, 0);
    });
    idInput.addEventListener('keyup', e=>{
      if (e.key === 'Enter'){
        clearTimeout(manualSearchTimer);
        manualSearchTimer = null;
        doSearch({ manual:true });
      }
    });
    idInput.addEventListener('input', ()=>{
      if (skipNextManualDebounce) return;
      const val = String(idInput.value || '').trim();
      clearTimeout(manualSearchTimer);
      if (!val){
        manualSearchTimer = null;
        doSearch({ manual:true });
        return;
      }
      manualSearchTimer = setTimeout(()=>{
        doSearch({ manual:true });
      }, 140);
    });

    /******** رندر النتائج ********/
    function clearDupUI(){
      dupBadge.style.display = 'none';
      dupBadge.textContent = 'مكرر';
      extraDupInfo.textContent = '';
    }
    function renderLoading(){
      clearDupUI();
      statusBadge.className = 'badge badge--loading';
      statusBadge.textContent = 'جارٍ البحث…';
      amountText.textContent = '⏳';
      multiText.textContent = '';
      if (discountInfo){
        discountInfo.textContent = '';
        discountInfo.style.display = 'none';
      }
      if (nameText) nameText.textContent = '—';
    }
    function ensureLocalMapObject(){
      if (!localMap || typeof localMap !== 'object') {
        localMap = Object.create(null);
      }
      return localMap;
    }
    function createEmptyLocalNode(){
      return { rowsCount: 0, adminRowsCount: 0, sum: 0, salaries: [], names: [], inAdmin: false, aCol: false, dCol: false };
    }
    function toNumericArray(list){
      if (!Array.isArray(list)) return [];
      const nums = [];
      list.forEach(val => {
        const num = Number(val);
        if (Number.isFinite(num)) nums.push(num);
      });
      return nums;
    }
    function deriveRowCountFromResult(result){
      if (!result) return 0;
      const salaryNums = toNumericArray(result.salaries);
      if (salaryNums.length) return salaryNums.length;
      const rawRows = Number(result.rowsCount);
      if (Number.isFinite(rawRows) && rawRows > 0) return rawRows;
      const status = String(result.status || '');
      if (!status || status === 'غير موجود' || status === 'error') return 0;
      if (status.includes('راتبين')) return 2;
      return 1;
    }
    function pickBoolean(value, fallback){
      return typeof value === 'boolean' ? value : !!fallback;
    }
    function resolveDuplicateContext(result, node, flavor){
      const res = result || {};
      const info = node || {};
      const mode = String(flavor || '').toLowerCase();
      const flavorAgent = mode === 'agent' || mode === 'both';
      const flavorAdmin = mode === 'admin' || mode === 'both';

      const derivedRows = deriveRowCountFromResult(res);
      const explicitRows = Number(res.rowsCount || 0);
      const nodeRows = Number(info.rowsCount || 0);
      let agentRows = Math.max(0, derivedRows, explicitRows, nodeRows);

      const adminRowsResult = Number(res.adminRowsCount || 0);
      const adminRowsNode = Number(info.adminRowsCount || 0);
      let adminRows = Math.max(0, adminRowsResult, adminRowsNode);

      const statusText = String(res.status || '');
      const agentPresent = !!(res.inAgent || agentRows > 0 || info.sum || (Array.isArray(info.names) && info.names.length) || flavorAgent || mode === 'both' || statusText.includes('وكال') || statusText.includes('راتب'));
      const adminPresent = !!(res.inAdmin || adminRows > 0 || info.inAdmin || flavorAdmin || mode === 'both');

      if (!agentRows && agentPresent) agentRows = 1;
      if (!adminRows && adminPresent) adminRows = 1;

      const agentColored = flavorAgent || pickBoolean(res.coloredAgent, pickBoolean(res.colored, info.aCol));
      const adminColored = flavorAdmin || pickBoolean(res.coloredAdmin, info.dCol);

      return { agentPresent, adminPresent, agentColored, adminColored, agentRows, adminRows };
    }
    function determineDuplicateLabelFromContext(ctx){
      if (!ctx) return null;
      const { agentPresent, adminPresent, agentColored, adminColored } = ctx;
      if (agentPresent && adminPresent) {
        if (agentColored && adminColored) return 'مكرر';
        if (agentColored && !adminColored) return 'مكرر وكالة فقط';
        if (!agentColored && adminColored) return 'مكرر ادارة فقط';
        return 'مكرر';
      }
      if (agentColored) return 'مكرر وكالة فقط';
      if (adminColored) return 'مكرر ادارة فقط';
      return null;
    }
    function computeSingleResultDisplayInfo(res){
      if (!res) return null;
      const key = String(res.id || '').trim();
      if (!key) return null;
      const status = String(res.status || '');
      const salaries = Array.isArray(res.salaries) ? res.salaries : [];
      const isAdminOnly = status.includes('ادارة') && !salaries.length;
      if (status === 'غير موجود' || status === 'error') {
        return { id: key, rows: 0, coloredRows: 0 };
      }
      const node = (localMap && key && Object.prototype.hasOwnProperty.call(localMap, key)) ? localMap[key] : null;
      const ctx = resolveDuplicateContext(res, node);
      let totalRows = ctx.agentRows + ctx.adminRows;
      if (!totalRows && status && status !== 'غير موجود' && status !== 'error' && !isAdminOnly) {
        totalRows = 1;
      }
      if (!totalRows && (ctx.agentPresent || ctx.adminPresent)) {
        totalRows = (ctx.agentPresent ? 1 : 0) + (ctx.adminPresent ? 1 : 0);
      }
      let coloredRows = 0;
      if (ctx.agentColored && ctx.agentRows) {
        coloredRows += ctx.agentRows;
      }
      if (ctx.adminColored && ctx.adminRows) {
        coloredRows += ctx.adminRows;
      }
      if (coloredRows > totalRows) coloredRows = totalRows;
      if (!totalRows && coloredRows) totalRows = coloredRows;
      return { id: key, rows: Math.max(0, totalRows), coloredRows: Math.max(0, coloredRows) };
    }
    function registerSingleResultDisplay(res){
      clearLiveSource(LIVE_SOURCE_SINGLE, { skipRecalc: true });
      const info = computeSingleResultDisplayInfo(res);
      if (info && info.rows > 0) {
        addLiveDisplayEntry(LIVE_SOURCE_SINGLE, info.id, info.rows, info.coloredRows, { skipRecalc: true });
      }
      recomputeLiveTotals();
    }
    function syncLocalEntryFromResult(result, options = {}){
      const keySource = result ? result.id : options.id;
      const key = String(keySource || '').trim();
      if (!key) return null;
      if (result && (result.status === 'غير موجود' || result.status === 'error')) return null;
      const allowCreate = options.allowCreateWhenMissing ?? !!result;
      if (!allowCreate && (!localMap || typeof localMap !== 'object' || !Object.prototype.hasOwnProperty.call(localMap, key))) {
        return null;
      }
      const map = ensureLocalMapObject();
      let node = map[key];
      if (!node) {
        if (!allowCreate) return null;
        node = createEmptyLocalNode();
        map[key] = node;
      }
      if (result) {
        const status = String(result.status || '');
        const salaryNums = toNumericArray(result.salaries);
        if (salaryNums.length) {
          node.rowsCount = salaryNums.length;
          node.sum = salaryNums.reduce((acc, n) => acc + n, 0);
          node.salaries = salaryNums;
        } else {
          const fallback = Number(result.totalSalary ?? result.salaryAfterDiscount ?? result.discountAmount ?? result.sum);
          if (Number.isFinite(fallback)) {
            if (!node.rowsCount && fallback > 0) node.rowsCount = Math.max(1, Number(result.rowsCount || 0) || 1);
            node.sum = fallback;
            if ((!Array.isArray(node.salaries) || !node.salaries.length) && fallback) node.salaries = [fallback];
          }
        }
        if (Array.isArray(result.names) && result.names.length) {
          node.names = result.names.map(v => String(v || ''));
        } else if (result.name) {
          const nm = String(result.name || '').trim();
          if (nm) node.names = [nm];
        }
        const adminRowsFromResult = Math.max(0, Number(result.adminRowsCount || 0));
        if (adminRowsFromResult && (!node.adminRowsCount || node.adminRowsCount < adminRowsFromResult)) {
          node.adminRowsCount = adminRowsFromResult;
        }
        if (typeof result.inAdmin === 'boolean') {
          node.inAdmin = result.inAdmin || node.inAdmin;
        } else if (status.includes('ادارة')) {
          node.inAdmin = true;
        }
        if (typeof result.coloredAgent === 'boolean' && result.coloredAgent) {
          node.aCol = true;
        }
        if (typeof result.coloredAdmin === 'boolean' && result.coloredAdmin) {
          node.dCol = true;
        }
        if (result.isDuplicate) {
          const label = String(result.duplicateLabel || '');
          if (label === 'مكرر' || label.includes('وكالة')) node.aCol = true;
          if (label === 'مكرر' || label.includes('ادارة')) node.dCol = true;
        }
      } else if (options.fallbackRowsCount && (!node.rowsCount || node.rowsCount < options.fallbackRowsCount)) {
        node.rowsCount = options.fallbackRowsCount;
      }
      if (options.forceInAdmin) {
        node.inAdmin = true;
        const fallbackAdmin = Math.max(1, Number(options.fallbackAdminRowsCount || options.fallbackRowsCount || 0));
        if (!node.adminRowsCount || node.adminRowsCount < fallbackAdmin) {
          node.adminRowsCount = fallbackAdmin;
        }
      }
      if (options.markAgent) {
        node.aCol = true;
      }
      if (options.markAdmin) {
        node.dCol = true;
        node.inAdmin = true;
        const fallbackAdmin = Math.max(1, Number(options.fallbackAdminRowsCount || options.fallbackRowsCount || 0));
        if (!node.adminRowsCount || node.adminRowsCount < fallbackAdmin) {
          node.adminRowsCount = fallbackAdmin;
        }
      }
      return node;
    }
    function applyBadges(baseStatus, duplicateLabel, hasSalaries){
      let baseClass = 'badge--agent';
      if (baseStatus.includes('ادارة') && !hasSalaries) baseClass = 'badge--admin';
      else if (baseStatus.includes('سحب وكالة'))      baseClass = 'badge--withdraw';
      else if (baseStatus.includes('غير موجود'))      baseClass = 'badge--missing';
      statusBadge.className = 'badge ' + baseClass;
      statusBadge.textContent = baseStatus || '—';
      if (duplicateLabel){ dupBadge.style.display='inline-block'; dupBadge.textContent=duplicateLabel; }
      else dupBadge.style.display='none';
    }
    function renderResult(res){
      lastResult = res;
      const idKey = res && res.id ? String(res.id).trim() : '';

      // حدّد اسم الشخص إن وجد فى النتيجة (إما خاصية name أو دمج مصفوفة names)
      (function(){
        try{
          let nm = '';
          if (res) {
            if (res.name) nm = String(res.name||'').trim();
            else if (Array.isArray(res.names)) nm = res.names.map(x=>String(x||'').trim()).filter(Boolean).join('، ');
          }
          if (nameText) nameText.textContent = nm || '—';
        }catch(_){ if (nameText) nameText.textContent = '—'; }
      })();
      if (res.status === 'error'){
        applyBadges('خطأ', null, false);
        amountText.textContent = '—';
        multiText.textContent = res.message || '';
        if (discountInfo){
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
        registerSingleResultDisplay(res);
        return;
      }
      if (res.status === 'غير موجود'){
        applyBadges('غير موجود', null, false);
        amountText.textContent = '—';
        multiText.textContent = '';
        if (discountInfo){
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
        registerSingleResultDisplay(res);
        return;
      }

      const baseStatus = res.status || '';
      const node = (idKey && localMap && Object.prototype.hasOwnProperty.call(localMap, idKey)) ? localMap[idKey] : null;
      const flavor = idKey && Object.prototype.hasOwnProperty.call(justColored, idKey) ? justColored[idKey] : null;
      const ctx = resolveDuplicateContext(res, node, flavor);
      let dupLabel = determineDuplicateLabelFromContext(ctx);
      if (!dupLabel && res && res.isDuplicate && res.duplicateLabel) {
        dupLabel = res.duplicateLabel;
      }
      if (idKey && Object.prototype.hasOwnProperty.call(justColored, idKey)){
        delete justColored[idKey];
        const idx = justColoredOrder.indexOf(idKey);
        if (idx >= 0) justColoredOrder.splice(idx, 1);
      }
      res.isDuplicate = !!dupLabel;
      res.duplicateLabel = dupLabel || null;
      res.inAgent = ctx.agentPresent;
      res.inAdmin = ctx.adminPresent;
      res.coloredAgent = ctx.agentColored;
      res.coloredAdmin = ctx.adminColored;
      if (ctx.agentRows && (!res.rowsCount || res.rowsCount < ctx.agentRows)) {
        res.rowsCount = ctx.agentRows;
      }
      if (ctx.adminRows && (!res.adminRowsCount || res.adminRowsCount < ctx.adminRows)) {
        res.adminRowsCount = ctx.adminRows;
      }

      const hasSalaries = Array.isArray(res.salaries) && res.salaries.length > 0;
      const isAdminOnly = baseStatus.includes('ادارة') && !hasSalaries;

      applyBadges(baseStatus, dupLabel, hasSalaries);

      if (isAdminOnly){
        amountText.textContent = '—';
        multiText.textContent = '';
        if (discountInfo){
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
        flash(resultsBox,'flash-blue');
        syncLocalEntryFromResult(res);
        registerSingleResultDisplay(res);
        return;
      }

      const total = Number(res.totalSalary) || 0;
      const pct   = getSingleDiscountPct();
      const discountedTotal = total * (1 - pct / 100);
      amountText.textContent = fmt(discountedTotal);

      if (discountInfo){
        if (pct > 0 && total > 0){
          const beforeText = fmt(total);
          const afterText  = fmt(discountedTotal);
          discountInfo.textContent = `قبل النسبة: ${beforeText}\nبعد النسبة: ${afterText}`;
          discountInfo.style.display = '';
        } else {
          discountInfo.textContent = '';
          discountInfo.style.display = 'none';
        }
      }

      if (hasSalaries && res.salaries.length > 1){
        multiText.textContent = '(' + res.salaries.map(n=>fmt(Number(n)||0)).join(' + ') + ')';
      } else multiText.textContent = '';

      syncLocalEntryFromResult(res);
      registerSingleResultDisplay(res);
      flash(resultsBox,'flash-blue');
    }

    /******** الرسالة ********/
    function buildMessageText(card, applyDiscount, localMapRef){
      if (!card || !Array.isArray(card.ids)) return '—';
      const pct = getSingleDiscountPct();
      const lm  = localMapRef || {};
      const header = [];
      if (card.name)    header.push(card.name);
      if (card.phone)   header.push(card.phone);
      if (card.address) header.push(card.address);
      if (card.agency)  header.push(card.agency);
      if (card.note)    header.push('ملاحظة : ' + card.note);

      let total = 0;
      const idLines = [];
      card.ids.forEach(x=>{
        const id = String(x.id||'').trim();
        if (!id) return;
        const node = lm[id];
        const adminOnly = node ? (!node.rowsCount && node.inAdmin) : false;
        let val = Number(x.amount||0);
        if (applyDiscount) val = val * (pct ? (1 - pct/100) : 1);
        total += val;
        idLines.push({ id, text: `${id} ... ${fmt(val)}${adminOnly ? ' ادارة' : ''}`, value: val });
      });

      const lines = [];
      lines.push(header.join('\n')); lines.push('');
      if (idLines.length === 1){
        lines.push(idLines[0].id); lines.push(''); lines.push(fmt(idLines[0].value));
      } else if (idLines.length > 1){
        lines.push(idLines.map(x=>x.text).join('\n'));
        lines.push('•••••••••••••••••••••••');
        lines.push('المجموع : ' + fmt(total));
        lines.push('•••••••••••••••••••••••');
      }
      return lines.filter(Boolean).join('\n');
    }

    function renderPersonCard(id){
      if (isPersonFeatureDisabled()) { personNote.textContent='—'; personMsg.value=''; return; }
      personNote.textContent = 'جاري جلب الرسالة...';
      personMsg.value = '';
      lastProfileIds = [];
      google.script.run
        .withSuccessHandler(card=>{
          if (isPersonFeatureDisabled()) { cancelPersonCardOperations(); return; }
          if(!card || !card.ok){
            personNote.textContent = card?.message || 'لم يتم العثور على بيانات.';
            personMsg.value = '';
            return;
          }
          lastProfileIds = (card.ids||[]).map(x=> String(x.id));
          const txt = buildMessageText(card, applyDiscountToMessage.checked, localMap);
          personMsg.value = txt;
          personNote.textContent = `تم — عدد IDs: ${lastProfileIds.length}`;
          flash(personCardEl, 'flash-blue');

          clearDupUI();
          const dupList = [];
          lastProfileIds.forEach(uid=>{
            const node = localMap && localMap[uid];
            if (!node) return;
            if (node.aCol && node.dCol) dupList.push(`${uid} (مكرر)`);
            else if (node.aCol)         dupList.push(`${uid} (مكرر وكالة فقط)`);
            else if (node.dCol)         dupList.push(`${uid} (مكرر ادارة فقط)`);
          });
          if (dupList.length){
            dupBadge.style.display='inline-block';
            dupBadge.textContent='مكرر';
            extraDupInfo.textContent = 'IDs مكررة: ' + dupList.join('، ');
          }
        })
        .withFailureHandler(err=>{
          if (isPersonFeatureDisabled()) { cancelPersonCardOperations(); return; }
          personNote.textContent = 'خطأ: ' + (err?.message||'');
          personMsg.value = '';
        })
        .getPersonCardById(id, activeSectionKey || '');
    }

    function rebuildPersonCardUsingLast(){
      if (isPersonFeatureDisabled()) return;
      if (lastBaseId){
        google.script.run
          .withSuccessHandler(card=>{
            if (isPersonFeatureDisabled()) { cancelPersonCardOperations(); return; }
            if(card && card.ok){
              personMsg.value = buildMessageText(card, !!applyDiscountToMessage.checked, localMap);
              personNote.textContent = `تم — عدد IDs: ${(card.ids||[]).length}`;
            }
          })
          .getPersonCardById(lastBaseId, activeSectionKey || '');
      }
    }

    /******** تنفيذ ذكي ********/
    function runAdvanced() {
      advNote.textContent = '... جارٍ التنفيذ';
      const id = idInput.value.trim();
      if (!id) { advNote.textContent = '⚠️ أدخل ID أولاً'; return; }

      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode === 'both' && !sheet) {
        advNote.textContent = '⚠️ اختر ورقة الهدف';
        return;
      }

      google.script.run
        .withSuccessHandler(res => {
          advNote.textContent = res?.message || 'تم ✅';
          flash(advCard, 'flash-green');
          const normalizedId = String(id || '').trim();
          if (normalizedId) {
            const matchedResult = (lastResult && String(lastResult.id || '').trim() === normalizedId) ? lastResult : null;
            const hadLocalNode = !!(localMap && Object.prototype.hasOwnProperty.call(localMap, normalizedId));
            let delta = computeInstantColoringDelta(normalizedId, { mode: targetMode });
            if (!delta.coloredDelta && !delta.uncoloredDelta) {
              if (matchedResult) {
                const fallbackRows = deriveRowCountFromResult(matchedResult);
                if (fallbackRows > 0) {
                  delta = { coloredDelta: fallbackRows, uncoloredDelta: -fallbackRows };
                }
              } else if (!hadLocalNode) {
                delta = { coloredDelta: 1, uncoloredDelta: -1 };
              }
            }
            if (delta.coloredDelta || delta.uncoloredDelta) {
              applyInstantCounterDelta(delta.coloredDelta, delta.uncoloredDelta);
            }
            const fallbackAdminRows = targetMode === 'both'
              ? Math.max(1, Number(matchedResult?.adminRowsCount || 0) || 1)
              : 0;
            if (matchedResult) {
              syncLocalEntryFromResult(matchedResult, {
                allowCreateWhenMissing: true,
                markAgent: true,
                markAdmin: targetMode === 'both',
                forceInAdmin: targetMode === 'both',
                fallbackAdminRowsCount: fallbackAdminRows
              });
            } else {
              syncLocalEntryFromResult(null, {
                id: normalizedId,
                allowCreateWhenMissing: true,
                fallbackRowsCount: 1,
                markAgent: true,
                markAdmin: targetMode === 'both',
                forceInAdmin: targetMode === 'both',
                fallbackAdminRowsCount: fallbackAdminRows
              });
            }
            markJustColored(normalizedId, targetMode);
            updateLastResultDuplicateState(normalizedId, targetMode);
          } else {
            markJustColored(id, targetMode);
            if (lastResult) renderResult(lastResult);
          }
          refreshCountsLive();
        })
        .withFailureHandler(err => {
          advNote.textContent = 'خطأ: ' + (err?.message || '');
        })
        .applyAdvancedAction(id, sheet, adminColor.value, withdrawColor.value, targetMode, undefined, activeSectionKey || '');
    }
    advRunBtn.addEventListener('click', runAdvanced);

    /******** عداد / وضع داكن / إخفاء تحميل ********/
    function fmtNum(n){ const x=Number(n); return isNaN(x)?'—':new Intl.NumberFormat('en-US').format(x); }
    function refreshCountsLive(){
      updateLiveCountersFromDisplay();
    }
    function parseCounterValue(el){
      if (!el) return NaN;
      const raw = String(el.textContent || '').replace(/[^0-9.-]/g, '');
      if (!raw) return NaN;
      const num = Number(raw);
      return Number.isFinite(num) ? num : NaN;
    }
    function setCounterValue(el, value){
      if (!el) return;
      const safe = Math.max(0, Math.round(Number(value) || 0));
      el.textContent = fmtNum(safe);
    }
    function getLiveSourceMap(source){
      const key = source || '__default';
      if (!liveDisplaySources[key]) {
        liveDisplaySources[key] = new Map();
      }
      return liveDisplaySources[key];
    }
    function clearLiveSource(source, options = {}){
      const map = getLiveSourceMap(source);
      map.clear();
      if (!options.skipRecalc) recomputeLiveTotals();
    }
    function addLiveDisplayEntry(source, id, rows, coloredRows, options = {}){
      const map = getLiveSourceMap(source);
      const key = String(id || '').trim();
      if (!key) return;
      const totalRows = Math.max(0, Number(rows) || 0);
      const colored = Math.max(0, Math.min(totalRows, Number(coloredRows) || 0));
      if (!totalRows) {
        map.delete(key);
      } else {
        const prev = map.get(key);
        if (prev) {
          map.set(key, {
            rows: totalRows + Math.max(0, Number(prev.rows) || 0),
            coloredRows: colored + Math.max(0, Number(prev.coloredRows) || 0),
            count: (prev.count || 0) + 1
          });
        } else {
          map.set(key, { rows: totalRows, coloredRows: colored, count: 1 });
        }
      }
      if (!options.skipRecalc) recomputeLiveTotals();
    }
    function recomputeLiveTotals(){
      let totalRows = 0;
      let coloredRows = 0;
      Object.keys(liveDisplaySources).forEach(src => {
        const map = liveDisplaySources[src];
        if (!map) return;
        map.forEach(info => {
          const rows = Math.max(0, Number(info?.rows) || 0);
          const colored = Math.max(0, Math.min(rows, Number(info?.coloredRows) || 0));
          totalRows += rows;
          coloredRows += colored;
        });
      });
      const uncoloredRows = Math.max(0, totalRows - coloredRows);
      setCounterValue(qtColored, coloredRows);
      setCounterValue(menuQtColored, coloredRows);
      setCounterValue(qtUncolored, uncoloredRows);
      setCounterValue(menuQtUncolored, uncoloredRows);
    }
    function updateLiveCountersFromDisplay(){
      recomputeLiveTotals();
    }
    function applyInstantCounterDelta(coloredDelta, uncoloredDelta){
      if (!coloredDelta && !uncoloredDelta) return;
      const coloredEls = [qtColored, menuQtColored];
      const uncoloredEls = [qtUncolored, menuQtUncolored];
      coloredEls.forEach(el => {
        const cur = parseCounterValue(el);
        if (!Number.isFinite(cur)) return;
        setCounterValue(el, cur + coloredDelta);
      });
      uncoloredEls.forEach(el => {
        const cur = parseCounterValue(el);
        if (!Number.isFinite(cur)) return;
        setCounterValue(el, cur + uncoloredDelta);
      });
    }
    function computeInstantColoringDelta(ids, options = {}){
      if (!localMap) return { coloredDelta: 0, uncoloredDelta: 0 };
      const arr = Array.isArray(ids) ? ids : [ids];
      const mode = String(options.mode || 'both').toLowerCase();
      const affectAgent = (mode === 'agent' || mode === 'both');
      const affectAdmin = (mode === 'admin' || mode === 'both');
      let coloredDelta = 0;
      let uncoloredDelta = 0;
      arr.forEach(rawId => {
        const key = String(rawId || '').trim();
        if (!key) return;
        const node = localMap[key];
        if (!node) return;
        const agentRows = Math.max(0, Number(node.rowsCount || (Array.isArray(node.rows) ? node.rows.length : 0) || 0));
        const adminRows = Math.max(0, Number(node.adminRowsCount || 0));
        if (affectAgent && !node.aCol) {
          const count = agentRows || 1;
          coloredDelta += count;
          uncoloredDelta -= count;
        }
        if (affectAdmin) {
          const adminCount = adminRows || (node.inAdmin ? 1 : 0);
          if (adminCount && !node.dCol) {
            coloredDelta += adminCount;
            uncoloredDelta -= adminCount;
          }
        }
      });
      return { coloredDelta, uncoloredDelta };
    }
    function updateLastResultDuplicateState(id, fallbackMode){
      const normalized = String(id || '').trim();
      if (!normalized || !lastResult) return;
      if (String(lastResult.id || '').trim() !== normalized) return;
      const node = localMap ? localMap[normalized] : null;
      const ctx = resolveDuplicateContext(lastResult, node, fallbackMode);
      const dupLabel = determineDuplicateLabelFromContext(ctx);
      lastResult.isDuplicate = !!dupLabel;
      lastResult.duplicateLabel = dupLabel || null;
      lastResult.inAgent = ctx.agentPresent;
      lastResult.inAdmin = ctx.adminPresent;
      lastResult.coloredAgent = ctx.agentColored;
      lastResult.coloredAdmin = ctx.adminColored;
      if (ctx.agentRows && (!lastResult.rowsCount || lastResult.rowsCount < ctx.agentRows)) {
        lastResult.rowsCount = ctx.agentRows;
      }
      if (ctx.adminRows && (!lastResult.adminRowsCount || lastResult.adminRowsCount < ctx.adminRows)) {
        lastResult.adminRowsCount = ctx.adminRows;
      }
      renderResult(lastResult);
    }
    function applyModeLabel(){
      const isDark = document.body.classList.contains('dark');
      qtMode.textContent = isDark ? '☀️ وضع فاتح' : '🌙 وضع داكن';
    }
    try { if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark'); } catch(_){}
    applyModeLabel();
    qtMode.addEventListener('click', ()=>{
      const isDark = document.body.classList.toggle('dark');
      applyModeLabel();
      try { localStorage.setItem('darkMode', isDark ? 'true':'false'); } catch(_){}
    });
    function applyHideState(){
      const loadCard = document.getElementById('loadCard');
      const hide = (localStorage.getItem('hide_loadsec') === '1');
      if (loadCard) loadCard.style.display = hide ? 'none' : '';
      qtHide.textContent = hide ? '👀 إظهار التحميل' : '🙈 إخفاء التحميل';
    }
    applyHideState();
    qtHide.addEventListener('click', ()=>{
      const cur = localStorage.getItem('hide_loadsec') === '1';
      localStorage.setItem('hide_loadsec', cur ? '0':'1');
      applyHideState();
    });
    document.getElementById('qtRefreshCnt').addEventListener('click', refreshCountsLive);

    /******** البحث (محلي أولاً ثم السيرفر) ********/
    let querySeq = 0;
    function normalizeId(v){ return String(v||'').trim(); }

  function doSearch(options = {}){
    const id = String(idInput.value||'').trim();
    const allowSuggestions = options && options.allowSuggestions !== false;
    if (!id){
      applyBadges('غير موجود', null, false);
      amountText.textContent = '—';
      multiText.textContent  = '';
      if (discountInfo){
        discountInfo.textContent = '';
        discountInfo.style.display = 'none';
      }
      personNote.textContent = '—';
      personMsg.value = '';
      clearDupUI();
      clearLiveSource(LIVE_SOURCE_SINGLE);
      return;
    }

    saveLastId(id);
    lastBaseId = id;
    renderLoading(); // أبقِ "جارٍ البحث…" كافتراضي

    const hasLocal = !!(localMap && Object.prototype.hasOwnProperty.call(localMap, id));
    if (hasLocal){
      // إذا موجود بالوكيل: أعرض محليًا فورًا (وكالة/سحب وكالة/راتبين)
      const node = localMap[id];
      const inAdmin   = !!node.inAdmin;
      const rowsCount = Number(node.rowsCount||0);
      const total     = Number(node.sum||0);
      const salaries  = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];
      let status;
      if (rowsCount > 0) status = inAdmin ? ((rowsCount>1)? 'سحب وكالة - راتبين':'سحب وكالة')
                                          : ((rowsCount>1)? 'راتبين':'وكالة');
      else if (inAdmin) status = 'ادارة';
      else status = 'غير موجود';

      let isDuplicate=false, duplicateLabel=null;
      if (node.aCol && node.dCol) { isDuplicate = true; duplicateLabel = 'مكرر'; }
      else if (node.aCol)         { isDuplicate = true; duplicateLabel = 'مكرر وكالة فقط'; }
      else if (node.dCol)         { isDuplicate = true; duplicateLabel = 'مكرر ادارة فقط'; }

      renderResult({
        status,
        totalSalary: total.toFixed(2),
        salaries,
        names: (Array.isArray(node.names) ? node.names : []),
        name: (Array.isArray(node.names) && node.names.length ? String(node.names[0]||'').trim() : ''),
        discountAmount: '0.00',
        salaryAfterDiscount: total.toFixed(2),
        id,
        isDuplicate,
        duplicateLabel,
        inAgent: rowsCount > 0,
        inAdmin: !!node.inAdmin,
        rowsCount: rowsCount,
        adminRowsCount: Number(node.adminRowsCount || 0),
        coloredAgent: !!node.aCol,
        coloredAdmin: !!node.dCol
      });
    }

    const mySeq = (++window.__qseq || (window.__qseq=1));
    const pct = getSingleDiscountPct();

    google.script.run
      .withSuccessHandler(res=>{
        if (mySeq !== window.__qseq) return; // تجاهل الردود المتأخرة
        if (!res || res.status === 'error'){
          if (res && res.message) renderResult({ status:'error', message: res.message });
          return;
        }
        renderResult(res);
        if (isPersonFeatureDisabled()) {
          cancelPersonCardOperations();
        } else {
          renderPersonCard(id);
        }
      })
      .withFailureHandler(err=>{
        if (err && err.message) renderResult({ status:'error', message: err.message });
      })
      .searchId(id, pct, activeSectionKey || '');
  }

    function applySingleDiscountChange(pct, source){
      const safePct = clampDiscountValue(pct);
      const formatted = formatDiscountValue(safePct);
      if (discountInput && discountInput !== source && discountInput.value !== formatted) {
        discountInput.value = formatted;
      }
      if (menuDiscountInput && menuDiscountInput !== source && menuDiscountInput.value !== formatted) {
        menuDiscountInput.value = formatted;
      }
      updateMenuDiscountUI(safePct, { skipInputUpdate: true });
      try { localStorage.setItem(SINGLE_DISCOUNT_STORAGE_KEY, formatted); } catch (_) {}
      if (lastResult) renderResult(lastResult);
      refreshCountsLive(safePct);
      if (!isPersonFeatureDisabled() && applyDiscountToMessage?.checked && lastBaseId) {
        rebuildPersonCardUsingLast();
      }
    }

    function handleSingleDiscountInput(event){
      const source = event?.target || null;
      const pct = clampDiscountValue(source?.value);
      const formatted = formatDiscountValue(pct);
      if (source && source.value !== formatted) {
        source.value = formatted;
      }
      applySingleDiscountChange(pct, source);
    }

    (function initSingleDiscount(){
      if (!discountInput && !menuDiscountInput) return;

      let initialValue = clampDiscountValue(discountInput?.value ?? menuDiscountInput?.value);
      try {
        const stored = localStorage.getItem(SINGLE_DISCOUNT_STORAGE_KEY);
        if (stored !== null && stored !== '') {
          initialValue = clampDiscountValue(stored);
        } else {
          const legacy = localStorage.getItem('single_discount_pct');
          if (legacy !== null && legacy !== '') {
            initialValue = clampDiscountValue(legacy);
          }
        }
      } catch (_) {}

      const formatted = formatDiscountValue(initialValue);
      if (discountInput && discountInput.value !== formatted) {
        discountInput.value = formatted;
      }
      if (menuDiscountInput && menuDiscountInput !== discountInput && menuDiscountInput.value !== formatted) {
        menuDiscountInput.value = formatted;
      }
      updateMenuDiscountUI(initialValue, { skipInputUpdate: true });

      applySingleDiscountChange(initialValue, null);

      if (discountInput && discountInput !== menuDiscountInput) {
        discountInput.addEventListener('input', handleSingleDiscountInput);
      }
      if (menuDiscountInput) {
        menuDiscountInput.addEventListener('input', handleSingleDiscountInput);
      }
    })();

    // مهيّئ سويتش "تصحيح الراتب"
    function initSalaryCorrectionSwitch(){
      if (!enableSalaryCorrection) return;
      google.script.run
        .withSuccessHandler(res=>{
          try { enableSalaryCorrection.checked = !!(res && res.enabled); } catch(_){}
        })
        .withFailureHandler(()=>{})
        .getSalaryCorrectionEnabled();

      enableSalaryCorrection.addEventListener('change', ()=>{
        const desired = !!enableSalaryCorrection.checked;
        google.script.run
          .withSuccessHandler(res=>{
            if (!res || typeof res.enabled === 'undefined') return;
            if (!!res.enabled !== desired) enableSalaryCorrection.checked = !!res.enabled;
            if (!isPersonFeatureDisabled() && lastBaseId) rebuildPersonCardUsingLast();
          })
          .withFailureHandler(()=>{ enableSalaryCorrection.checked = !desired; })
          .setSalaryCorrectionEnabled(desired ? 1 : 0);
      });
    }

    // أول تحميل
    window.addEventListener('load', ()=>{
      applyPersonVisibility();
      loadLastId();
      loadData();
      fillSheets();
      handleBulkIdsChange();
      updateBulkButtons();
      initSalaryCorrectionSwitch();
      setTimeout(refreshCountsLive, 600);
    });
  </script>
  
<!-- ===== /Bulk IDs — Advanced ===== -->
<!-- شارة حالة الإنترنت (فحص ذكي، لا يمنع التنفيذ عند البطء) -->
<style>
  #netBadge{position:fixed;inset-inline-end:18px;inset-block-end:18px;z-index:9999;padding:8px 12px;border-radius:14px;font-size:12px;font-weight:700;box-shadow:0 18px 48px rgba(0,0,0,.38);background:var(--surface-strong);border:1px solid rgba(255,255,255,.12);color:var(--text);display:flex;align-items:center;gap:8px;backdrop-filter:blur(12px);}
  #netBadge.net-weak{background:rgba(255,209,102,.12);border-color:rgba(255,209,102,.32);color:#ffd27f;}
  #netBadge.net-down{background:rgba(255,93,117,.16);border-color:rgba(255,93,117,.32);color:#ff9aad;}
  #netBadge .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(43,255,168,.6);}
  #netBadge.net-weak .dot{background:#ffd166;box-shadow:0 0 8px rgba(255,209,102,.6);}
  #netBadge.net-down .dot{background:#ff5d75;box-shadow:0 0 8px rgba(255,93,117,.6);}
</style>
<div id="netBadge"><span class="dot"></span><span id="netText">فحص الاتصال…</span></div>

<script>
(function(){
  const badge=document.getElementById('netBadge');
  const text=document.getElementById('netText');

  function setState(kind,label){
    badge.classList.remove('net-weak','net-down');
    if(kind==='ok'){ text.textContent=`متصل ✅ ${label||''}`.trim(); }
    else if(kind==='weak'){ badge.classList.add('net-weak'); text.textContent=`بطيء 🟡 ${label||''}`.trim(); }
    else { badge.classList.add('net-down'); text.textContent=`أوفلاين ⛔ ${label||''}`.trim(); }
  }

  function pingServer(timeoutMs){
    return new Promise(res=>{
      let done=false, t0=performance.now();
      try{
        google.script.run
          .withSuccessHandler(()=>{ if(done) return; done=true; res({ok:true,rtt:performance.now()-t0}); })
          .withFailureHandler(()=>{ if(done) return; done=true; res({ok:false}); })
          .ping?.();
        setTimeout(()=>{ if(done) return; done=true; res({ok:false}); }, timeoutMs||2000);
      }catch(_){ res({ok:false}); }
    });
  }

  let lastPing=0;
  async function checkNow(){
    // فحص الجهاز كل ثانية (سنفعّله بالinterval بالأسفل)
    if(!navigator.onLine){ setState('down','(الجهاز غير متصل)'); window.__serverReachable=false; return; }

    // فحص السيرفر كل 30 ثانية فقط
    const now=Date.now();
    if(now-lastPing>30000){
      lastPing=now;
      const s=await pingServer(1500);
      if(s.ok){
        const rtt=Math.round(s.rtt||0);
        if(rtt<=700) setState('ok',`(${rtt}ms)`); else setState('weak',`(${rtt}ms)`);
        window.__serverReachable=true;   // نستفيد منها للعرض فقط
      }else{
        setState('weak','()'); // عرض فقط؛ ما يمنع التنفيذ
        window.__serverReachable=false;
      }
    }
  }

  // فحص الجهاز كل ثانية + السيرفر كل 30 ثانية
  setInterval(checkNow,1000);
  checkNow();
  window.addEventListener('online',()=>{ lastPing=0; checkNow(); });
  window.addEventListener('offline',()=> setState('down','(الجهاز غير متصل)'));

  // 🔁 أهم تغيير: السماح بالتنفيذ ما دام الجهاز Online حتى لو السيرفر بطيء
  window.netEnsureOnline = async function(){
    // لو الجهاز أوفلاين فقط نمنع
    if(!navigator.onLine){
      alert('⛔ الجهاز غير متصل بالإنترنت');
      return false;
    }
    // خلاف ذلك نسمح دومًا (سريع أو بطيء / السيرفر يتأخر بالرد)
    return true;
  };
})();
</script>
<script>
/* حارس زر التنفيذ — يمنع التنفيذ لو الاتصال غير جاهز (بدون لمس كودك الأصلي) */
(function guardExecButton(){
  const SELECTORS = ['#advRunBtn']; // أضف أزرار أخرى هنا لو تحب

  function isServerLikelyUp(){
    if (window.__serverReachable === true)  return true;
    if (window.__serverReachable === false) return false;
    return navigator.onLine; // تقدير سريع
  }

  async function ensureOnlineInteractive(){
    if (typeof window.netEnsureOnline === 'function'){
      return await window.netEnsureOnline();
    }
    if (!navigator.onLine){ alert('⛔ الجهاز أوفلاين — لن يتم التنفيذ.'); return false; }
    if (window.__serverReachable === false){ alert('🟡 السيرفر غير متاح — أعد المحاولة أو حدّث الصفحة.'); return false; }
    return true;
    }

  function handlerCapture(e){
    const btn = e.target.closest(SELECTORS.join(','));
    if (!btn) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    (async ()=>{
      if (!isServerLikelyUp()){
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      } else {
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      }
      // مرّت الشروط ✅ — أعد إطلاق النقر ليكمل كودك الأصلي
      document.removeEventListener('click', handlerCapture, true);
      try { btn.click(); } finally {
        setTimeout(()=> document.addEventListener('click', handlerCapture, true), 0);
      }
    })();
  }

  document.addEventListener('click', handlerCapture, true);
})();
</script>
<!-- ======= سجل النقل — واجهة نهائية ======= -->
<style>
  .lgp-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px;border:1px solid #16a34a;background:#22c55e;color:#fff;
    font-weight:800;cursor:pointer;width:100%;margin:10px 0;border-radius:12px}
  .lgp-btn:disabled{opacity:.6;cursor:not-allowed}

  .lgp-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.35);z-index:99999}
  .lgp-modal.show{display:flex}
  .lgp-sheet{width:min(92vw,560px);padding:14px;background:var(--card-bg,#111827);color:var(--fg,#e5e7eb);
    box-shadow:0 12px 28px rgba(0,0,0,.25);border:1px solid var(--border,#374151);border-radius:12px;overflow:hidden}
  .lgp-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .lgp-heading{font-size:16px;font-weight:800}
  .lgp-ghost{border:1px solid var(--border,#374151);background:transparent;padding:8px 12px;color:inherit;border-radius:12px}

  .lgp-list{max-height:56vh;overflow:auto;border:1px solid var(--border,#374151);background:rgba(255,255,255,.02);border-radius:12px}
  .lgp-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-bottom:1px solid var(--border,#374151)}
  .lgp-row:last-child{border-bottom:0}
  .lgp-id{font-family:ui-monospace,monospace;font-weight:800}
  .lgp-meta{font-size:11px;opacity:.8}

  .lgp-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .lgp-select,.lgp-color{border:1px solid var(--border,#374151);background:transparent;color:inherit;padding:10px;border-radius:12px}
  .lgp-primary{background:#22c55e;border:1px solid #16a34a;color:#fff;padding:12px;font-weight:800;border-radius:12px}

  .lgp-toggle{display:inline-flex;align-items:center;gap:10px}
  .ios-switch{position:relative;width:48px;height:28px}
  .ios-switch input{appearance:none;-webkit-appearance:none;width:48px;height:28px;margin:0;cursor:pointer}
  .ios-switch .track{position:absolute;inset:0;background:#6b7280;transition:.2s;border-radius:999px}
  .ios-switch .thumb{position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.25);transition:.2s}
  .ios-switch input:checked ~ .track{ background:#22c55e }
  .ios-switch input:checked ~ .thumb{ left:23px }

  .lgp-color{ width:44px;height:34px;padding:0 }
  .lgp-hint{font-size:12px;opacity:.75;margin-top:6px}
</style>

<!-- زر "السجل" (يُزرَع تلقائيًا تحت زر التنفيذ) -->
<div id="lgpMount" style="display:none">
  <button id="lgpOpen" class="lgp-btn">📁 السجل</button>
</div>

<!-- النافذة المنبثقة -->
<div id="lgpModal" class="lgp-modal" role="dialog" aria-modal="true">
  <div class="lgp-sheet">
    <div class="lgp-title">
      <div class="lgp-heading" aria-hidden="true">📁</div>
      <button id="lgpClose" class="lgp-ghost">إغلاق</button>
    </div>

    <div id="lgpList" class="lgp-list">
      <div class="lgp-row"><div></div><div>… جارٍ التحميل</div><div></div></div>
    </div>

    <div class="lgp-controls">
      <select id="lgpTarget" class="lgp-select" title="اختر ورقة الهدف">
        <option>… جارٍ التحميل</option>
      </select>

      <div class="lgp-toggle" title="لون مخصّص">
        <label class="ios-switch">
          <input id="lgpUseCustom" type="checkbox" aria-label="لون مخصّص">
          <span class="track"></span><span class="thumb"></span>
        </label>
      </div>
      <input id="lgpColor" type="color" class="lgp-color" value="#9629ff" title="لون بعد النقل" disabled>

      <button id="lgpMove" class="lgp-primary">نقل المحدد</button>
    </div>

    <div id="lgpHint" class="lgp-hint"></div>
  </div>
</div>

<script>
/* زرع زر السجل تحت زر تنفيذ (حسب النتيجة) */
(function(){
  var mount = document.getElementById('lgpMount');
  function resolveHost(){
    if (!mount) return null;
    var slot = document.getElementById('logSlot');
    if (slot) return slot;
    var mobile = document.body.classList.contains('bulk-mobile-active') && window.matchMedia('(max-width: 1200px)').matches;
    if (mobile){
      var mobileHost = document.getElementById('bulkMobileMount');
      if (mobileHost) return mobileHost;
    }
    var runBtn=document.getElementById('advRunBtn');
    var host = runBtn ? runBtn.closest('.card') : null;
    if(!host) host=document.getElementById('advCard');
    if(!host){
      var cards=document.querySelectorAll('.card');
      if(cards.length) host=cards[cards.length-1];
    }
    if(!host) host=document.body;
    return host;
  }
  function placeButton(){
    if(!mount) return;
    var host = resolveHost();
    if(!host) return;
    var mobileHost = document.getElementById('bulkMobileMount');
    if(host === mobileHost){
      if(mount.parentNode!==host || host.firstChild!==mount){
        host.insertBefore(mount, host.firstChild || null);
      }
    } else {
      if(mount.parentNode!==host) host.appendChild(mount);
    }
    mount.style.display='block';
  }
  function ensureMounted(){
    placeButton();
    setTimeout(placeButton,150); setTimeout(placeButton,400); setTimeout(placeButton,1000);
    window.addEventListener('resize',()=>setTimeout(placeButton,150));
    document.addEventListener('bulk-mobile-state-change', ()=>setTimeout(placeButton,50));
    new MutationObserver(()=>placeButton()).observe(document.body,{childList:true,subtree:true});
  }
  (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded',ensureMounted) : ensureMounted();
})();

/* واجهة السجل */
(function(){
  var modal=document.getElementById('lgpModal');
  var openBtn=document.getElementById('lgpOpen');
  var closeBtn=document.getElementById('lgpClose');
  var list=document.getElementById('lgpList');
  var sel=document.getElementById('lgpTarget');
  var useCustom=document.getElementById('lgpUseCustom');
  var colorInp=document.getElementById('lgpColor');
  var move=document.getElementById('lgpMove');
  var hint=document.getElementById('lgpHint');

  function setHint(msg){ if(hint) hint.textContent = msg || ''; }

  function renderList(items){
    list.innerHTML='';
    if(!items||!items.length){
      list.innerHTML='<div class="lgp-row"><div></div><div>لا يوجد سجل</div><div></div></div>';
      list.__rows__=[];
      return;
    }
    items.forEach(function(it,i){
      var row=document.createElement('div');
      row.className='lgp-row';
      row.innerHTML = `
        <label><input type="checkbox" data-idx="${i}"></label>
        <div>
          <div class="lgp-id">${it.id||'—'} | ${it.target||'—'}</div>
          <div class="lgp-meta">${it.at||''} • صفوف: ${it.rows||1}</div>
        </div>
        <div style="width:18px;height:18px;border:1px solid var(--border,#374151);border-radius:6px;background:${it.color||'transparent'}"></div>
      `;
      list.appendChild(row);
    });
    list.__rows__ = items || [];
  }

  function loadAll(){
    list.innerHTML='<div class="lgp-row"><div></div><div>… جارٍ التحميل</div><div></div></div>';
    sel.innerHTML='<option>… جارٍ التحميل</option>';
    setHint('تحميل السجل والأوراق…');

    // السجل
    google.script.run
      .withSuccessHandler(function(items){ renderList(items||[]); setHint(''); })
      .withFailureHandler(function(err){
        list.innerHTML='<div class="lgp-row"><div></div><div>⚠️ خطأ getMoveLogLatest: '+(err&&err.message||'')+'</div><div></div></div>';
        list.__rows__=[];
        setHint('');
      })
      .getMoveLogLatest(15);

    // أسماء الأوراق (يستخدم getAdminSheetsSafe، وإن فشل يحاول getAdminSheets)
    google.script.run
      .withSuccessHandler(function(arr){
        sel.innerHTML='';
        (arr||[]).forEach(function(n){
          var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
        });
        var sheetSelect=document.getElementById('sheetSelect');
        if(sheetSelect && sheetSelect.value) sel.value = sheetSelect.value;
      })
      .withFailureHandler(function(){
        google.script.run
          .withSuccessHandler(function(arr){
            sel.innerHTML='';
            (arr||[]).forEach(function(n){
              var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
            });
          })
          .withFailureHandler(function(err){
            sel.innerHTML=''; var o=document.createElement('option');
            o.textContent='⚠️ فشل الحصول على أسماء الأوراق: '+(err&&err.message||''); sel.appendChild(o);
          })
          .getAdminSheets();
      })
      .getAdminSheetsSafe();
  }

  // فتح/إغلاق
  openBtn && openBtn.addEventListener('click', ()=>{ loadAll(); modal.classList.add('show'); });
  closeBtn && closeBtn.addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });

  // تفعيل/تعطيل لون مخصص
  function syncColor(){ colorInp.disabled = !useCustom.checked; colorInp.style.opacity = useCustom.checked ? '1' : '.55'; }
  useCustom && useCustom.addEventListener('change', syncColor); syncColor();

  // نقل المحدد
  move && move.addEventListener('click', function(){
    var checks = Array.from(list.querySelectorAll('input[type=checkbox]:checked'));
    if(!checks.length){ alert('اختر عناصر للنقل'); return; }
    var rows = list.__rows__ || [];
    var pick = checks.map(function(ch){ var r=rows[+ch.dataset.idx]||{}; return { id:(r.id||''), from:(r.target||'') }; });
    var override = useCustom && useCustom.checked ? (colorInp.value||'') : '';

    move.disabled=true; move.textContent='جارٍ النقل…';
    google.script.run
      .withSuccessHandler(function(res){
        move.disabled=false; move.textContent='نقل المحدد';
        alert(res && res.message ? res.message : 'تم.');
        loadAll();
      })
      .withFailureHandler(function(err){
        move.disabled=false; move.textContent='نقل المحدد';
        alert('خطأ: '+(err&&err.message||'')); 
      })
      .moveFromLog(pick, sel.value||'', override);
  });
})();
</script>
<?!= HtmlService.createHtmlOutputFromFile('AIClient').getContent(); ?>
<!-- ✅ ترتيب موحّد + تثبيت الأدوات السريعة + تنسيق صف البحث -->
 
</body>
</html>
